<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ËÅäÂ§©ÂÆ§</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #4a90e2;
            --primary-dark: #357abd;
            --secondary: #667eea;
            --accent: #764ba2;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #f5f7fa;
            
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        /* ÁôªÂΩïÂå∫Âüü */
        .login-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 30px 20px;
            border-radius: 20px;
            width: 100%;
            max-width: 320px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .login-box h3 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--dark);
            font-size: 24px;
        }

        .login-box h3 i {
            color: var(--primary);
            margin-right: 10px;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .login-box input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74,144,226,0.1);
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-box button:hover {
            background: var(--primary-dark);
        }

        .login-box button:active {
            transform: scale(0.98);
        }

        .login-box button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        #loginError {
            color: var(--danger);
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            display: none;
            padding: 10px;
            background: rgba(231,76,60,0.1);
            border-radius: 8px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .login-tip {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .login-tip p {
            margin-bottom: 3px;
        }
        
        .login-tip code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--danger);
        }

        /* ËøûÊé•Áä∂ÊÄÅ */
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }

        .status-connected {
            background: var(--success);
            color: white;
        }

        .status-disconnected {
            background: var(--danger);
            color: white;
        }

        .status-connecting {
            background: var(--warning);
            color: white;
        }

        /* ÁßªÂä®Á´ØÂ§¥ÈÉ® */
        .mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            padding-top: max(12px, var(--safe-area-top));
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
        }

        .mobile-header h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-header h2 i {
            font-size: 20px;
        }

        .online-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        /* Ê†áÁ≠æÈ°µÂØºËà™ */
        .tab-bar {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .tab-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
        }

        .tab-item.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .tab-item i {
            font-size: 16px;
        }

        /* ÂÜÖÂÆπÂå∫Âüü */
        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #f8f9fa;
        }

        .tab-panel {
            display: none;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: var(--safe-area-bottom);
        }

        .tab-panel.active {
            display: block;
        }

        /* ËÅäÂ§©Èù¢Êùø */
        .chat-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.system {
            align-self: center;
            max-width: 90%;
            background: rgba(0,0,0,0.03);
            border-radius: 20px;
            padding: 6px 16px;
        }

        .system-content {
            font-size: 12px;
            color: #666;
            text-align: center;
            word-break: break-word;
        }

        .message.private {
            align-self: center;
            max-width: 90%;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 20px;
            padding: 8px 16px;
            border-left: 3px solid var(--primary);
        }

        .private-content {
            font-size: 13px;
            color: var(--primary-dark);
            text-align: center;
            font-weight: 500;
        }

        .message.chat {
            align-self: flex-start;
        }

        .message.own-message {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            padding: 0 4px;
        }

        .own-message .message-header {
            flex-direction: row-reverse;
        }

        .message-username {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
        }

        .message-time {
            font-size: 10px;
            color: #999;
        }

        .message-bubble {
            background: white;
            padding: 10px 14px;
            border-radius: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
        }

        .own-message .message-bubble {
            background: var(--primary);
            color: white;
        }

        .command-highlight {
            background: rgba(255, 215, 0, 0.2);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }

        /* ËæìÂÖ•Âå∫Âüü */
        .input-area {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 12px 16px;
            padding-bottom: max(12px, var(--safe-area-bottom));
            display: flex;
            gap: 10px;
            align-items: flex-end;
            position: relative;
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 14px 45px 14px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 28px;
            font-size: 15px;
            resize: none;
            max-height: 120px;
            background: #f8f9fa;
            font-family: inherit;
            transition: all 0.3s ease;
            line-height: 1.5;
        }

        .message-input:focus {
            border-color: var(--primary);
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(74,144,226,0.1);
        }

        .message-input:disabled {
            background: #e9ecef;
            opacity: 0.7;
        }

        .message-input.command-mode {
            border-color: #f39c12;
            background: #fff8e7;
        }

        .command-prompt {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #f39c12;
            font-weight: bold;
            font-size: 18px;
            display: none;
            z-index: 2;
        }

        .command-prompt.visible {
            display: block;
        }

        .command-input {
            padding-left: 35px !important;
        }

        .send-btn {
            padding: 0 24px;
            height: 48px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 28px;
            font-size: 15px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 10px rgba(74,144,226,0.3);
        }

        .send-btn i {
            font-size: 15px;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74,144,226,0.4);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Êåá‰ª§Âª∫ËÆÆ - ÂÆö‰ΩçÂú®ËæìÂÖ•Ê°Ü‰∏äÊñπ */
        .command-suggestions {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -8px 25px rgba(0,0,0,0.15);
            border: 1px solid #e0e0e0;
            border-bottom: none;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            margin-bottom: 8px;
        }

        .command-suggestions.visible {
            display: block;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .suggestion-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item.selected {
            background: #e3f2fd;
            border-left: 3px solid var(--primary);
        }

        .suggestion-cmd {
            font-weight: 600;
            color: var(--primary);
            min-width: 90px;
            font-size: 14px;
            background: rgba(74, 144, 226, 0.1);
            padding: 4px 8px;
            border-radius: 16px;
            text-align: center;
        }

        .suggestion-desc {
            font-size: 13px;
            color: #666;
            flex: 1;
        }

        /* Âø´ÈÄüÊåá‰ª§ÊåâÈíÆ - ÂÆö‰ΩçÂú®ËæìÂÖ•Ê°Ü‰∏äÊñπÂ∑¶‰æß */
        .quick-commands {
            position: absolute;
            bottom: 100%;
            left: 0;
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            z-index: 99;
        }

        .quick-cmd-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .quick-cmd-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: var(--primary-dark);
        }

        .quick-cmd-btn i {
            font-size: 12px;
        }

        /* ÊâìÂ≠óÊåáÁ§∫Âô® */
        .typing-indicator {
            padding: 5px 16px;
            font-size: 11px;
            color: #666;
            font-style: italic;
            background: white;
        }

        /* Áî®Êà∑Èù¢Êùø */
        .users-panel {
            padding: 16px;
        }

        .online-stats {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .online-stats h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .online-count {
            font-size: 32px;
            font-weight: bold;
        }

        .online-count small {
            font-size: 14px;
            opacity: 0.8;
            margin-left: 5px;
        }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .user-card {
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .user-card.in-game {
            border-left: 3px solid var(--success);
        }

        .user-card.dead {
            opacity: 0.6;
            border-left: 3px solid var(--danger);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-status {
            font-size: 11px;
            color: #999;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-role-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(0,0,0,0.05);
        }

        /* Ê∏∏ÊàèÈù¢Êùø */
        .game-panel {
            padding: 16px;
        }

        .game-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .game-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .game-header h3 {
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .game-phase-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .game-phase-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .game-timer {
            background: rgba(0,0,0,0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-family: monospace;
            font-weight: bold;
        }

        .game-players {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .game-players h4 {
            margin-bottom: 12px;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-count {
            font-size: 14px;
            color: var(--primary);
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .game-player {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .game-player.alive {
            border-left: 3px solid var(--success);
        }

        .game-player.dead {
            border-left: 3px solid var(--danger);
            opacity: 0.6;
        }

        .player-role {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(0,0,0,0.1);
        }

        .game-instructions {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid #e0e0e0;
        }

        .game-instructions h5 {
            margin-bottom: 10px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .instruction-list {
            list-style: none;
            padding: 0;
        }

        .instruction-list li {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .instruction-list li:hover {
            background: rgba(74, 144, 226, 0.05);
        }

        .instruction-list li:last-child {
            border-bottom: none;
        }

        .instruction-cmd {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 70px;
            text-align: center;
        }

        .instruction-desc {
            color: #666;
        }

        .game-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .game-btn.primary {
            background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
            color: white;
        }

        .game-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .game-btn:active {
            transform: scale(0.98);
        }

        /* ÁÆ°ÁêÜÂëòÈù¢Êùø */
        .admin-panel {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 10px;
            position: fixed;
            top: 60px;
            right: 10px;
            width: 350px;
            max-width: 90%;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }

        .admin-panel.visible {
            display: block;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .admin-header h3 {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-header h3 i {
            color: #f39c12;
        }

        .admin-close {
            background: none;
            border: none;
            color: #999;
            font-size: 20px;
            cursor: pointer;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }

        .admin-tab {
            padding: 6px 12px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            border-radius: 20px;
            font-size: 13px;
        }

        .admin-tab.active {
            background: #f39c12;
            color: white;
        }

        .admin-content {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        .admin-user-list, .admin-message-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .admin-user-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .admin-user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .admin-user-ip {
            font-size: 11px;
            opacity: 0.7;
        }

        .admin-user-status {
            font-size: 11px;
            display: flex;
            gap: 8px;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .status-muted {
            background: #e74c3c;
        }

        .status-normal {
            background: #2ecc71;
        }

        .status-admin {
            background: #f39c12;
        }

        .status-banned {
            background: #c0392b;
        }

        .admin-user-actions {
            display: flex;
            gap: 5px;
        }

        .admin-user-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-user-actions button:hover {
            transform: scale(1.05);
        }

        .btn-mute {
            background: #e74c3c;
            color: white;
        }

        .btn-unmute {
            background: #2ecc71;
            color: white;
        }

        .btn-kick {
            background: #95a5a6;
            color: white;
        }

        .btn-ban {
            background: #c0392b;
            color: white;
        }

        .admin-message-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .admin-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 11px;
            opacity: 0.8;
        }

        .admin-message-content {
            font-size: 13px;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .admin-message-id {
            font-size: 9px;
            color: #999;
            margin-bottom: 5px;
        }

        .admin-message-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }

        .btn-recall {
            background: #e67e22;
            color: white;
            padding: 3px 8px;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }

        .admin-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ========== CMDÁªàÁ´ØÊ†∑Âºè - Âè™Âú®Ê°åÈù¢Á´ØÊòæÁ§∫ ========== */
        @media (min-width: 769px) {
            .cmd-terminal {
                background-color: #0a0a0a;
                color: #cccccc;
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                font-size: 13px;
                line-height: 1.5;
                padding: 0;
                border-radius: 6px;
                border: 1px solid #333;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                position: fixed;
                bottom: 80px;
                right: 20px;
                width: 600px;
                height: 400px;
                z-index: 2000;
                display: none;
                flex-direction: column;
                overflow: hidden;
                resize: both;
                min-width: 400px;
                min-height: 300px;
                user-select: none;
            }

            .cmd-terminal.visible {
                display: flex;
            }

            .terminal-toggle {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #2c3e50, #34495e);
                color: white;
                border: none;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                font-size: 20px;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                z-index: 1999;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
            }

            .terminal-toggle:hover {
                transform: scale(1.1);
                background: linear-gradient(135deg, #34495e, #2c3e50);
            }

            .terminal-toggle.active {
                background: #e74c3c;
            }

            .cmd-terminal-header {
                background-color: #1a1a1a;
                padding: 8px 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #333;
                cursor: move;
                user-select: none;
            }

            .cmd-terminal-title {
                color: #fff;
                font-weight: bold;
                font-size: 12px;
            }

            .cmd-terminal-controls {
                display: flex;
                gap: 8px;
            }

            .cmd-terminal-btn {
                background: none;
                border: none;
                color: #888;
                cursor: pointer;
                font-size: 14px;
                padding: 0 4px;
            }

            .cmd-terminal-btn:hover {
                color: #fff;
            }

            .cmd-terminal-content {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
                background-color: #0a0a0a;
                scroll-behavior: smooth;
                user-select: text;
            }

            .cmd-line {
                margin: 2px 0;
                white-space: pre-wrap;
                word-wrap: break-word;
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                color: #cccccc;
            }

            .cmd-prompt {
                color: #4ec9b0;
                font-weight: bold;
            }

            .cmd-timestamp {
                color: #808080;
                margin-right: 8px;
            }

            .cmd-input-line {
                display: flex;
                align-items: center;
                padding: 8px 12px;
                background-color: #1a1a1a;
                border-top: 1px solid #333;
            }

            .cmd-input-prompt {
                color: #4ec9b0;
                margin-right: 8px;
                font-weight: bold;
            }

            .cmd-input {
                flex: 1;
                background: none;
                border: none;
                color: #fff;
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                font-size: 13px;
                outline: none;
            }

            .cmd-input::placeholder {
                color: #444;
            }

            /* Êó•ÂøóÈ¢úËâ≤ */
            .cmd-log-info {
                color: #cccccc;
            }

            .cmd-log-warning {
                color: #ffd700;
            }

            .cmd-log-error {
                color: #ff6b6b;
            }

            .cmd-log-success {
                color: #6bff6b;
            }

            .cmd-log-admin {
                color: #ff9d4a;
            }

            .cmd-log-game {
                color: #9d6bff;
            }
        }

        /* ÊâãÊú∫Á´ØÈöêËóèCMDÁªàÁ´ØÂíåÁõ∏ÂÖ≥ÊåâÈíÆ */
        @media (max-width: 768px) {
            .cmd-terminal,
            .terminal-toggle,
            .cmd-terminal.visible,
            .terminal-toggle.active,
            #cmdTerminal,
            #terminalToggle {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                pointer-events: none !important;
            }
            
            /* Á°Æ‰øùÂø´ÈÄüÊåá‰ª§ÊåâÈíÆÂú®ÊâãÊú∫Á´ØÊ≠£Â∏∏ÊòæÁ§∫ */
            .quick-commands {
                left: 10px;
                gap: 5px;
            }
            
            .quick-cmd-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .quick-cmd-btn i {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ÁôªÂΩïÂå∫Âüü -->
        <div class="login-container" id="loginContainer">
            <div class="login-box">
                <h3><i class="fas fa-user-plus"></i> Âä†ÂÖ•ËÅäÂ§©</h3>
                <input type="text" id="username" placeholder="ËæìÂÖ•ÊòµÁß∞" maxlength="20" autocomplete="off">
                <button onclick="joinChat()" id="joinBtn">
                    <span id="joinText">ËøõÂÖ•ËÅäÂ§©ÂÆ§</span>
                    <span class="spinner" id="joinSpinner" style="display: none;"></span>
                </button>
                <div id="loginError"></div>
                
                <div class="login-tip">
                    <p><strong>üìå ÁôªÂΩïÊñπÂºèÔºö</strong></p>
                    <p>‚Ä¢ ÊôÆÈÄöÁî®Êà∑ÔºöÁõ¥Êé•ËæìÂÖ•ÊòµÁß∞ÔºåÂ¶Ç <code>Âº†‰∏â</code></p>
                    <p>‚Ä¢ ÁÆ°ÁêÜÂëòÔºöËæìÂÖ• <code>Áî®Êà∑Âêç:ÂØÜÁ†Å</code> Ê†ºÂºè</p>
                    <p style="color: #e67e22;">üîê ÈªòËÆ§ÁÆ°ÁêÜÂëòÂØÜÁ†Å: <code>admin123</code></p>
                    <p style="color: #e67e22;">Á§∫‰æã: <code>admin:admin123</code></p>
                </div>
            </div>
        </div>

        <!-- ‰∏ªÁïåÈù¢ (ÁôªÂΩïÂêéÊòæÁ§∫) -->
        <div id="mainApp" style="display: none; height: 100%; flex-direction: column;">
            <!-- Â§¥ÈÉ® -->
            <div class="mobile-header">
                <h2>
                    <i class="fas fa-comments"></i>
                    ËÅäÂ§©ÂÆ§
                </h2>
                <div class="online-badge" id="onlineBadge">
                    <i class="fas fa-users"></i> <span id="onlineCount">0</span>
                </div>
            </div>

            <!-- Ê†áÁ≠æÈ°µ -->
            <div class="tab-bar">
                <div class="tab-item active" onclick="switchTab('chat')">
                    <i class="fas fa-comment"></i> ËÅäÂ§©
                </div>
                <div class="tab-item" onclick="switchTab('users')">
                    <i class="fas fa-users"></i> Áî®Êà∑
                </div>
                <div class="tab-item" onclick="switchTab('game')">
                    <i class="fas fa-gamepad"></i> Ê∏∏Êàè
                </div>
            </div>

            <!-- ÂÜÖÂÆπÂå∫Âüü -->
            <div class="content-area">
                <!-- ËÅäÂ§©Èù¢Êùø -->
                <div class="tab-panel active" id="chatPanel">
                    <div class="chat-panel">
                        <div class="messages-container" id="messages">
                            <div class="message system">
                                <div class="system-content">
                                    <i class="fas fa-info-circle"></i> Ê¨¢Ëøé
                                </div>
                            </div>
                            <div class="message system">
                                <div class="system-content">
                                    <i class="fas fa-terminal"></i> ËæìÂÖ• <span class="command-highlight">/help</span> Êü•ÁúãÊ∏∏ÊàèÊåá‰ª§
                                </div>
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>
                        
                        <!-- ËæìÂÖ•Âå∫Âüü -->
                        <div class="input-area">
                            <!-- Âø´ÈÄüÊåá‰ª§ÊåâÈíÆÊîæÂú®ËøôÈáå -->
                            <div class="quick-commands" id="quickCommands" style="display: none;">
                                <button class="quick-cmd-btn" onclick="quickCommand('/join')">
                                    <i class="fas fa-plus"></i> /join
                                </button>
                                <button class="quick-cmd-btn" onclick="quickCommand('/players')">
                                    <i class="fas fa-users"></i> /players
                                </button>
                                <button class="quick-cmd-btn" onclick="quickCommand('/help')">
                                    <i class="fas fa-question"></i> /help
                                </button>
                            </div>
                            
                            <div class="message-input-wrapper">
                                <span class="command-prompt" id="commandPrompt">/</span>
                                <textarea 
                                    id="messageInput" 
                                    class="message-input" 
                                    placeholder="ËæìÂÖ•Ê∂àÊÅØ... "
                                    rows="1"
                                    disabled
                                ></textarea>
                                <!-- Êåá‰ª§Âª∫ËÆÆÊîæÂú®ËæìÂÖ•Ê°Ü‰∏äÊñπ -->
                                <div class="command-suggestions" id="commandSuggestions"></div>
                            </div>
                            
                            <button class="send-btn" onclick="sendMessage()" id="sendButton" disabled>
                                <i class="fas fa-paper-plane"></i> ÂèëÈÄÅ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Áî®Êà∑Èù¢Êùø -->
                <div class="tab-panel" id="usersPanel">
                    <div class="users-panel">
                        <div class="online-stats">
                            <h3><i class="fas fa-users"></i> Âú®Á∫øÁé©ÂÆ∂</h3>
                            <div class="online-count">
                                <span id="onlineCountDetail">0</span>
                                <small>‰∫∫</small>
                            </div>
                        </div>
                        <div class="user-grid" id="userList"></div>
                    </div>
                </div>

                <!-- Ê∏∏ÊàèÈù¢Êùø -->
                <div class="tab-panel" id="gamePanel">
                    <div class="game-panel">
                        <div class="game-header">
                            <h3><i class="fas fa-gamepad"></i> Áãº‰∫∫ÊùÄ</h3>
                            <div class="game-phase-info">
                                <span class="game-phase-badge" id="gameStatus">Á≠âÂæÖÂºÄÂßã</span>
                                <span class="game-timer" id="gameTimer">--:--</span>
                            </div>
                        </div>

                        <div class="game-players">
                            <h4>
                                <span>Ê∏∏ÊàèÁé©ÂÆ∂</span>
                                <span class="player-count" id="playerCount">0/8</span>
                            </h4>
                            <div class="players-grid" id="gamePlayers"></div>
                        </div>

                        <div class="game-instructions" id="gameInstructions">
                            <h5><i class="fas fa-terminal"></i> Ê∏∏ÊàèÊåá‰ª§</h5>
                            <ul class="instruction-list" id="instructionList">
                                <li onclick="quickCommand('/join')">
                                    <span class="instruction-cmd">/join</span>
                                    <span class="instruction-desc">Âä†ÂÖ•Ê∏∏Êàè</span>
                                </li>
                                <li onclick="quickCommand('/leave')">
                                    <span class="instruction-cmd">/leave</span>
                                    <span class="instruction-desc">Á¶ªÂºÄÊ∏∏Êàè</span>
                                </li>
                                <li onclick="quickCommand('/start')">
                                    <span class="instruction-cmd">/start</span>
                                    <span class="instruction-desc">ÂºÄÂßãÊ∏∏ÊàèÔºàÊàø‰∏ªÔºâ</span>
                                </li>
                                <li onclick="quickCommand('/players')">
                                    <span class="instruction-cmd">/players</span>
                                    <span class="instruction-desc">Êü•ÁúãÂ≠òÊ¥ªÁé©ÂÆ∂</span>
                                </li>
                                <li onclick="quickCommand('/roles')">
                                    <span class="instruction-cmd">/roles</span>
                                    <span class="instruction-desc">Êü•ÁúãÂâ©‰ΩôËßíËâ≤</span>
                                </li>
                                <li onclick="quickCommand('/help')">
                                    <span class="instruction-cmd">/help</span>
                                    <span class="instruction-desc">Êü•ÁúãÊâÄÊúâÊåá‰ª§</span>
                                </li>
                            </ul>
                        </div>

                        <button class="game-btn primary" id="joinGameBtn" onclick="quickCommand('/join')" disabled>
                            <i class="fas fa-plus"></i> Âä†ÂÖ•Ê∏∏Êàè (/join)
                        </button>
                        <button class="game-btn secondary" id="leaveGameBtn" onclick="quickCommand('/leave')" style="display: none;" disabled>
                            <i class="fas fa-sign-out-alt"></i> Á¶ªÂºÄÊ∏∏Êàè (/leave)
                        </button>
                        <button class="game-btn primary" id="startGameBtn" onclick="quickCommand('/start')" style="display: none;" disabled>
                            <i class="fas fa-play"></i> ÂºÄÂßãÊ∏∏Êàè (/start)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁÆ°ÁêÜÂëòÈù¢Êùø -->
        <div class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <h3><i class="fas fa-shield-alt"></i> ÁÆ°ÁêÜÂëòÊéßÂà∂Èù¢Êùø</h3>
                <button class="admin-close" onclick="hideAdminPanel()">&times;</button>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('users')">Âú®Á∫øÁî®Êà∑</button>
                <button class="admin-tab" onclick="switchAdminTab('messages')">Ê∂àÊÅØËÆ∞ÂΩï</button>
                <button class="admin-tab" onclick="switchAdminTab('bans')">Â∞ÅÁ¶ÅÂàóË°®</button>
            </div>
            
            <div class="admin-content" id="adminUsersTab">
                <div class="admin-user-list" id="adminUserList">
                    <div style="text-align: center; padding: 20px; color: #999;">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
            
            <div class="admin-content" id="adminMessagesTab" style="display: none;">
                <div class="admin-message-list" id="adminMessageList">
                    <div style="text-align: center; padding: 20px; color: #999;">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>

            <div class="admin-content" id="adminBansTab" style="display: none;">
                <div class="admin-ban-list" id="adminBanList">
                    <div style="text-align: center; padding: 20px; color: #999;">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
        </div>

        <!-- ËøûÊé•Áä∂ÊÄÅ -->
        <div id="connectionStatus" class="connection-status"></div>
    </div>

    <!-- CMDÁªàÁ´ØÊåâÈíÆ - Âè™Âú®Ê°åÈù¢Á´ØÊòæÁ§∫ -->
    <button class="terminal-toggle" id="terminalToggle" onclick="toggleTerminal()">
        <i class="fas fa-terminal"></i>
    </button>

    <!-- CMDÁªàÁ´Ø - Âè™Âú®Ê°åÈù¢Á´ØÊòæÁ§∫ -->
    <div class="cmd-terminal" id="cmdTerminal">
        <div class="cmd-terminal-header" id="terminalHeader">
            <span class="cmd-terminal-title">ADMIN@SERVER:~$ console</span>
            <div class="cmd-terminal-controls">
                <button class="cmd-terminal-btn" onclick="clearTerminal()"><i class="fas fa-trash"></i></button>
                <button class="cmd-terminal-btn" onclick="toggleTerminal()"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="cmd-terminal-content" id="terminalContent">
            <div class="cmd-line">
                <span class="cmd-prompt">ADMIN@SERVER:~$</span> 
                <span class="cmd-log-success">System initialized</span>
            </div>
            <div class="cmd-line">
                <span class="cmd-prompt">ADMIN@SERVER:~$</span> 
                <span>Type 'help' for available commands</span>
            </div>
        </div>
        <div class="cmd-input-line">
            <span class="cmd-input-prompt">ADMIN@SERVER:~$</span>
            <input type="text" class="cmd-input" id="cmdInput" placeholder="Enter command..." disabled>
        </div>
    </div>

    <script>
        // ========== ÈÖçÁΩÆ ==========
        const CONFIG = {
            maxReconnectAttempts: 5,
            reconnectDelay: 3000,
            typingTimeout: 1000,
            maxMessageLength: 500,
            maxUsernameLength: 20
        };

        // Ê∏∏ÊàèÊåá‰ª§ÂàóË°®
        const GAME_COMMANDS = {
            'join': 'Âä†ÂÖ•Ê∏∏Êàè',
            'leave': 'Á¶ªÂºÄÊ∏∏Êàè',
            'start': 'ÂºÄÂßãÊ∏∏ÊàèÔºàÊàø‰∏ªÔºâ',
            'kill': '[@Áî®Êà∑Âêç] Áãº‰∫∫ÊùÄ‰∫∫',
            'check': '[@Áî®Êà∑Âêç] È¢ÑË®ÄÂÆ∂Êü•È™å',
            'save': '[@Áî®Êà∑Âêç] Â•≥Â∑´Êïë‰∫∫',
            'poison': '[@Áî®Êà∑Âêç] Â•≥Â∑´ÊØí‰∫∫',
            'skip': 'Â•≥Â∑´Ë∑≥Ëøá',
            'shoot': '[@Áî®Êà∑Âêç] Áåé‰∫∫ÂºÄÊû™',
            'vote': '[@Áî®Êà∑Âêç] ÊäïÁ•®ÊîæÈÄê',
            'players': 'Êü•ÁúãÂ≠òÊ¥ªÁé©ÂÆ∂',
            'roles': 'Êü•ÁúãÂâ©‰ΩôËßíËâ≤',
            'help': 'Êü•ÁúãÂ∏ÆÂä©'
        };

        // ÁÆ°ÁêÜÂëòÂëΩ‰ª§ÂàóË°®
        const ADMIN_COMMANDS = {
            'help': 'ÊòæÁ§∫Ê≠§Â∏ÆÂä©‰ø°ÊÅØ',
            'users': 'ÂàóÂá∫ÊâÄÊúâÂú®Á∫øÁî®Êà∑',
            'userinfo <Áî®Êà∑Âêç>': 'Êü•ÁúãÁî®Êà∑ËØ¶ÁªÜ‰ø°ÊÅØ',
            'mute <Áî®Êà∑Âêç> [ÂéüÂõ†]': 'Á¶ÅË®ÄÁî®Êà∑',
            'unmute <Áî®Êà∑Âêç>': 'ÂèñÊ∂àÁî®Êà∑Á¶ÅË®Ä',
            'kick <Áî®Êà∑Âêç> [ÂéüÂõ†]': 'Ë∏¢Âá∫Áî®Êà∑',
            'ban <Áî®Êà∑Âêç/IP> [ÂéüÂõ†]': 'Â∞ÅÁ¶ÅÁî®Êà∑ÊàñIP',
            'unban <IP>': 'Ëß£Â∞ÅIP',
            'recall <Ê∂àÊÅØID> [ÂéüÂõ†]': 'Êí§ÂõûÊ∂àÊÅØ',
            'logs [Êï∞Èáè]': 'Êü•ÁúãÊúÄËøëÊó•Âøó',
            'search <Áî®Êà∑Âêç/IP>': 'ÊêúÁ¥¢Áî®Êà∑',
            'clear': 'Ê∏ÖÂ±è',
            'stats': 'Êü•ÁúãÊúçÂä°Âô®ÁªüËÆ°'
        };

        // ========== ÂÖ®Â±ÄÂèòÈáè ==========
        let ws = null;
        let currentUsername = null;
        let currentUserId = null;
        let currentUserIsAdmin = false;
        let reconnectAttempts = 0;
        let typingTimeout = null;
        let isConnected = false;
        let isJoining = false;
        let heartbeatInterval = null;

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            isPlaying: false,
            players: [],
            hostId: null,
            playerCount: 0,
            gamePhase: 'waiting',
            dayCount: 1,
            myRole: null,
            phaseEndTime: null
        };

        // ÁÆ°ÁêÜÂëòÁõ∏ÂÖ≥ÂèòÈáè
        let adminUsers = [];
        let adminMessages = [];
        let bannedIPs = [];

        // Â∏∏Áî®Ë°®ÊÉÖ
        const emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üéâ', '‚ú®', 'üî•', 'üíØ'];

        // CMDÁªàÁ´ØÂèòÈáè
        let terminalVisible = false;
        let terminalLogs = [];
        let cmdHistory = [];
        let cmdHistoryIndex = -1;
        let isDragging = false;
        let dragOffsetX, dragOffsetY;

        // Êåá‰ª§Âª∫ËÆÆÁõ∏ÂÖ≥
        let commandSuggestions = [];
        let selectedSuggestionIndex = -1;

        // ========== WebSocketËøûÊé• ==========
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            
            updateConnectionStatus('connecting');
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            ws = new WebSocket(`${protocol}//${host}`);

            ws.onopen = function() {
                console.log('‚úÖ Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®');
                isConnected = true;
                reconnectAttempts = 0;
                updateConnectionStatus('connected');
                
                startHeartbeat();
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Êî∂Âà∞Ê∂àÊÅØ:', data);
                    handleMessage(data);
                } catch (err) {
                    console.error('Ê∂àÊÅØËß£ÊûêÂ§±Ë¥•:', err);
                }
            };

            ws.onclose = function() {
                console.log('‚ùå ËøûÊé•Êñ≠ÂºÄ');
                isConnected = false;
                updateConnectionStatus('disconnected');
                
                enableControls(false);
                
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                    heartbeatInterval = null;
                }
                
                if (reconnectAttempts < CONFIG.maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connect, CONFIG.reconnectDelay);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketÈîôËØØ:', error);
                updateConnectionStatus('disconnected');
            };
        }

        // ÂøÉË∑≥
        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 30000);
        }

        // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;
            
            statusEl.style.display = 'block';
            statusEl.className = 'connection-status';
            
            let text = '';
            switch(status) {
                case 'connected':
                    statusEl.classList.add('status-connected');
                    text = 'üü¢ Â∑≤ËøûÊé•';
                    break;
                case 'connecting':
                    statusEl.classList.add('status-connecting');
                    text = 'üü° ËøûÊé•‰∏≠...';
                    break;
                case 'disconnected':
                    statusEl.classList.add('status-disconnected');
                    text = 'üî¥ Â∑≤Êñ≠ÂºÄ';
                    break;
            }
            statusEl.textContent = text;
        }

        // ÂêØÁî®/Á¶ÅÁî®Êéß‰ª∂
        function enableControls(enabled) {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const joinGameBtn = document.getElementById('joinGameBtn');
            const leaveGameBtn = document.getElementById('leaveGameBtn');
            const startGameBtn = document.getElementById('startGameBtn');
            const quickCommands = document.getElementById('quickCommands');
            
            if (messageInput) messageInput.disabled = !enabled;
            if (sendButton) sendButton.disabled = !enabled;
            
            if (enabled) {
                setupCommandInput();
                if (quickCommands) quickCommands.style.display = 'flex';
            }
        }

        // ========== ÁôªÂΩïÂäüËÉΩ ==========
        function joinChat() {
            if (isJoining) return;
            
            const usernameInput = document.getElementById('username');
            const joinBtn = document.getElementById('joinBtn');
            const joinText = document.getElementById('joinText');
            const joinSpinner = document.getElementById('joinSpinner');
            
            const username = usernameInput.value.trim();
            
            if (!username) {
                showError('ËØ∑ËæìÂÖ•ÊòµÁß∞');
                return;
            }

            if (username.length < 2) {
                showError('ÊòµÁß∞Ëá≥Â∞ë2‰∏™Â≠óÁ¨¶');
                return;
            }

            if (username.length > CONFIG.maxUsernameLength) {
                showError(`ÊòµÁß∞‰∏çËÉΩË∂ÖËøá${CONFIG.maxUsernameLength}‰∏™Â≠óÁ¨¶`);
                return;
            }

            if (!isConnected) {
                showError('Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®ÔºåËØ∑Á®çÂÄô...');
                return;
            }

            isJoining = true;
            currentUsername = username;
            
            joinBtn.disabled = true;
            joinText.style.display = 'none';
            joinSpinner.style.display = 'inline-block';
            
            ws.send(JSON.stringify({
                type: 'join',
                username: username
            }));
        }

        // ========== Ê∂àÊÅØÂ§ÑÁêÜ ==========
        function handleMessage(data) {
            console.log('Â§ÑÁêÜÊ∂àÊÅØ:', data);
            
            switch (data.type) {
                case 'welcome':
                    currentUserId = data.userId;
                    currentUserIsAdmin = data.isAdmin || false;
                    
                    console.log('ÂΩìÂâçÁî®Êà∑ÊòØÂê¶‰∏∫ÁÆ°ÁêÜÂëò:', currentUserIsAdmin);
                    
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'flex';
                    
                    enableControls(true);
                    
                    addSystemMessage(`Ê¨¢Ëøé ${data.username} Âä†ÂÖ•ËÅäÂ§©ÂÆ§ÔºÅ`);
                    
                    if (currentUserIsAdmin) {
                        console.log('ÁÆ°ÁêÜÂëòÁôªÂΩïÊàêÂäüÔºåÊòæÁ§∫Èù¢Êùø');
                        showAdminPanel();
                        ws.send(JSON.stringify({ type: 'adminGetUsers' }));
                        ws.send(JSON.stringify({ type: 'adminGetHistory' }));
                        ws.send(JSON.stringify({ type: 'adminGetBanned' }));
                        
                        // Âè™Âú®Ê°åÈù¢Á´ØÂàùÂßãÂåñÁªàÁ´Ø
                        if (window.innerWidth > 768) {
                            initTerminal();
                            addTerminalLog(`ÁÆ°ÁêÜÂëò ${data.username} ÁôªÂΩïÊàêÂäü`, 'success');
                            addTerminalLog(`IP: ${data.ip || 'Unknown'}`, 'info');
                        }
                    }
                    
                    setTimeout(() => {
                        ws.send(JSON.stringify({ type: 'getGameState' }));
                    }, 500);
                    break;
                    
                case 'chat':
                    addMessage(data);
                    if (currentUserIsAdmin && window.innerWidth > 768) {
                        addTerminalLog(`[CHAT] ${data.username}: ${data.content}`, 'info');
                    }
                    break;
                    
                case 'system':
                    addSystemMessage(data.content);
                    if (currentUserIsAdmin && window.innerWidth > 768) {
                        addTerminalLog(`[SYSTEM] ${data.content}`, 'game');
                    }
                    break;
                    
                case 'private':
                    addPrivateMessage(data.content);
                    break;
                    
                case 'users':
                    updateUserList(data.users);
                    updateOnlineCount(data.users.length);
                    if (currentUserIsAdmin && window.innerWidth > 768) {
                        addTerminalLog(`[INFO] Âú®Á∫øÁî®Êà∑Êõ¥Êñ∞: ${data.users.length} ‰∫∫Âú®Á∫ø`, 'info');
                    }
                    break;
                    
                case 'gameState':
                    console.log('Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ:', data);
                    updateGameState(data);
                    break;
                    
                case 'gameEvent':
                    addSystemMessage(`üéÆ ${data.content}`);
                    if (currentUserIsAdmin && window.innerWidth > 768) {
                        addTerminalLog(`[GAME] ${data.content}`, 'game');
                    }
                    break;
                    
                case 'phaseTimer':
                    updateGameTimer(data.remaining);
                    break;
                    
                case 'yourRole':
                    gameState.myRole = data.role;
                    addPrivateMessage(`üé≠ ‰Ω†ÁöÑËßíËâ≤ÊòØÔºö${data.role} - ${data.description}`);
                    updateGameInstructions(data.role);
                    break;
                    
                case 'seerResult':
                    addPrivateMessage(`üîÆ Êü•È™åÁªìÊûúÔºö${data.target} ${data.isWerewolf ? 'ÊòØÁãº‰∫∫' : '‰∏çÊòØÁãº‰∫∫'}`);
                    break;
                    
                case 'actionConfirm':
                    addSystemMessage(`‚úÖ ${data.content}`);
                    break;
                    
                case 'gameEnd':
                    addSystemMessage(`=== Ê∏∏ÊàèÁªìÊùüÔºå${data.winner}Ëé∑ËÉú ===`);
                    if (data.players) {
                        data.players.forEach(p => {
                            addSystemMessage(`${p.username} ÊòØ ${p.role} ${p.isAlive ? 'üòäÂ≠òÊ¥ª' : 'üíÄÊ≠ª‰∫°'}`);
                        });
                    }
                    ws.send(JSON.stringify({ type: 'getGameState' }));
                    break;
                    
                case 'messageRecalled':
                    handleMessageRecalled(data);
                    if (currentUserIsAdmin && window.innerWidth > 768) {
                        addTerminalLog(`[ADMIN] Ê∂àÊÅØÂ∑≤Êí§Âõû: ${data.messageId}`, 'admin');
                    }
                    break;
                    
                case 'error':
                    showError(data.content);
                    if (currentUserIsAdmin && window.innerWidth > 768) {
                        addTerminalLog(`[ERROR] ${data.content}`, 'error');
                    }
                    break;
                    
                case 'adminUsers':
                    console.log('Êî∂Âà∞ÁÆ°ÁêÜÂëòÁî®Êà∑ÂàóË°®:', data.users);
                    if (currentUserIsAdmin) {
                        adminUsers = data.users;
                        updateAdminUsers(data.users);
                        if (window.innerWidth > 768) {
                            addTerminalLog(`[ADMIN] Ëé∑ÂèñÂà∞ ${data.users.length} ‰∏™Âú®Á∫øÁî®Êà∑`, 'success');
                        }
                    }
                    break;
                    
                case 'adminHistory':
                    console.log('Êî∂Âà∞ÁÆ°ÁêÜÂëòÊ∂àÊÅØÂéÜÂè≤:', data.messages);
                    if (currentUserIsAdmin) {
                        adminMessages = data.messages;
                        updateAdminMessages(data.messages);
                        if (window.innerWidth > 768) {
                            addTerminalLog(`[ADMIN] Ëé∑ÂèñÂà∞ ${data.messages.length} Êù°Ê∂àÊÅØÂéÜÂè≤`, 'success');
                        }
                    }
                    break;
                    
                case 'bannedIPs':
                    console.log('Êî∂Âà∞Â∞ÅÁ¶ÅIPÂàóË°®:', data.ips);
                    if (currentUserIsAdmin) {
                        bannedIPs = data.ips || [];
                        updateBannedIPs(bannedIPs);
                        if (window.innerWidth > 768) {
                            addTerminalLog(`[ADMIN] ÂΩìÂâçÊúâ ${bannedIPs.length} ‰∏™IPË¢´Â∞ÅÁ¶Å`, 'info');
                        }
                    }
                    break;
                    
                case 'systemLogs':
                    if (currentUserIsAdmin && window.innerWidth > 768) {
                        addTerminalLog('=== Á≥ªÁªüÊó•Âøó ===', 'info');
                        data.logs.forEach(log => {
                            addTerminalLog(log, 'info');
                        });
                    }
                    break;
                    
                case 'adminSuccess':
                    if (currentUserIsAdmin) {
                        if (window.innerWidth > 768) {
                            addTerminalLog(`[SUCCESS] ${data.content}`, 'success');
                        }
                        showAdminNotification(data.content);
                    }
                    break;
                    
                case 'adminError':
                    if (currentUserIsAdmin) {
                        if (window.innerWidth > 768) {
                            addTerminalLog(`[ERROR] ${data.content}`, 'error');
                        }
                        alert(`ÁÆ°ÁêÜÂëòÊìç‰ΩúÂ§±Ë¥•: ${data.content}`);
                    }
                    break;
                    
                case 'pong':
                    break;
            }
        }

        // ========== ËÅäÂ§©ÂäüËÉΩ ==========
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !isConnected) return;
            
            if (content.length > CONFIG.maxMessageLength) {
                showError(`Ê∂àÊÅØ‰∏çËÉΩË∂ÖËøá${CONFIG.maxMessageLength}‰∏™Â≠óÁ¨¶`);
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'message',
                content: content
            }));
            
            input.value = '';
            input.style.height = 'auto';
            hideCommandSuggestions();
        }

        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const isOwnMessage = message.userId === currentUserId;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message chat ${isOwnMessage ? 'own-message' : ''}`;
            messageDiv.dataset.messageId = message.id;
            
            // È´ò‰∫ÆÊòæÁ§∫Êåá‰ª§
            let content = escapeHtml(message.content);
            if (content.startsWith('/')) {
                content = `<span class="command-highlight">${content}</span>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-username" style="color: ${message.color || '#4a90e2'}">
                        ${escapeHtml(message.username)}
                    </span>
                    <span class="message-time">${message.timestamp || new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-bubble">${content}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(content) {
            const messagesDiv = document.getElementById('messages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `<div class="system-content">${content}</div>`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addPrivateMessage(content) {
            const messagesDiv = document.getElementById('messages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message private';
            messageDiv.innerHTML = `<div class="private-content">üîí ${content}</div>`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleMessageRecalled(data) {
            const messagesDiv = document.getElementById('messages');
            const messages = messagesDiv.children;
            
            for (let i = 0; i < messages.length; i++) {
                const msg = messages[i];
                if (msg.dataset.messageId === data.messageId) {
                    if (msg.classList.contains('own-message')) {
                        msg.querySelector('.message-bubble').innerHTML = '‚ö†Ô∏è ‰Ω†ÁöÑÊ∂àÊÅØÂ∑≤Ë¢´ÁÆ°ÁêÜÂëòÊí§Âõû';
                    } else {
                        msg.querySelector('.message-bubble').innerHTML = '‚ö†Ô∏è ËØ•Ê∂àÊÅØÂ∑≤Ë¢´ÁÆ°ÁêÜÂëòÊí§Âõû';
                    }
                    msg.querySelector('.message-bubble').style.backgroundColor = '#f0f0f0';
                    msg.querySelector('.message-bubble').style.color = '#999';
                    break;
                }
            }
            
            addSystemMessage(data.content);
        }

        // ========== Êåá‰ª§ËæìÂÖ•ÂäüËÉΩ ==========
        function setupCommandInput() {
            const input = document.getElementById('messageInput');
            
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                
                const value = this.value;
                const prompt = document.getElementById('commandPrompt');
                
                if (value.startsWith('/')) {
                    prompt.classList.add('visible');
                    this.classList.add('command-input');
                    showCommandSuggestions(value);
                } else {
                    prompt.classList.remove('visible');
                    this.classList.remove('command-input');
                    hideCommandSuggestions();
                }
                
                if (!currentUserId || !isConnected) return;
                
                clearTimeout(typingTimeout);
                
                ws.send(JSON.stringify({
                    type: 'typing',
                    isTyping: true
                }));
                
                typingTimeout = setTimeout(() => {
                    ws.send(JSON.stringify({
                        type: 'typing',
                        isTyping: false
                    }));
                }, CONFIG.typingTimeout);
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    completeCommand();
                } else if (e.key === 'ArrowUp') {
                    if (commandSuggestions.length > 0) {
                        e.preventDefault();
                        navigateSuggestions('up');
                    }
                } else if (e.key === 'ArrowDown') {
                    if (commandSuggestions.length > 0) {
                        e.preventDefault();
                        navigateSuggestions('down');
                    }
                }
            });
        }

        function showCommandSuggestions(input) {
            const cmd = input.slice(1).toLowerCase();
            const suggestions = document.getElementById('commandSuggestions');
            const inputWrapper = document.querySelector('.message-input-wrapper');
            
            if (!cmd) {
                commandSuggestions = Object.entries(GAME_COMMANDS).map(([cmd, desc]) => ({ cmd, desc }));
            } else {
                commandSuggestions = Object.entries(GAME_COMMANDS)
                    .filter(([c, desc]) => c.includes(cmd) || desc.includes(cmd))
                    .map(([cmd, desc]) => ({ cmd, desc }));
            }
            
            if (commandSuggestions.length > 0) {
                suggestions.innerHTML = commandSuggestions.map((s, index) => `
                    <div class="suggestion-item ${index === 0 ? 'selected' : ''}" 
                         onclick="insertCommand('/${s.cmd}')">
                        <span class="suggestion-cmd">/${s.cmd}</span>
                        <span class="suggestion-desc">${s.desc}</span>
                    </div>
                `).join('');
                
                suggestions.classList.add('visible');
                
                // Ë∞ÉÊï¥ËæìÂÖ•Ê°Ü‰ΩçÁΩÆÔºå‰∏∫Âª∫ËÆÆÂàóË°®ËÖæÂá∫Á©∫Èó¥
                if (inputWrapper) {
                    inputWrapper.style.marginBottom = (suggestions.offsetHeight + 5) + 'px';
                }
                
                selectedSuggestionIndex = 0;
            } else {
                hideCommandSuggestions();
            }
        }

        function hideCommandSuggestions() {
            const suggestions = document.getElementById('commandSuggestions');
            const inputWrapper = document.querySelector('.message-input-wrapper');
            
            if (suggestions) {
                suggestions.classList.remove('visible');
            }
            if (inputWrapper) {
                inputWrapper.style.marginBottom = '0';
            }
            selectedSuggestionIndex = -1;
        }

        function navigateSuggestions(direction) {
            const items = document.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;
            
            items.forEach(item => item.classList.remove('selected'));
            
            if (direction === 'up') {
                selectedSuggestionIndex = (selectedSuggestionIndex - 1 + items.length) % items.length;
            } else {
                selectedSuggestionIndex = (selectedSuggestionIndex + 1) % items.length;
            }
            
            items[selectedSuggestionIndex].classList.add('selected');
        }

        function insertCommand(cmd) {
            const input = document.getElementById('messageInput');
            input.value = cmd + ' ';
            input.focus();
            hideCommandSuggestions();
        }

        function completeCommand() {
            if (commandSuggestions.length > 0) {
                const selected = document.querySelector('.suggestion-item.selected');
                if (selected) {
                    const cmd = selected.querySelector('.suggestion-cmd').textContent;
                    insertCommand(cmd);
                } else if (commandSuggestions[0]) {
                    insertCommand('/' + commandSuggestions[0].cmd);
                }
            }
        }

        function quickCommand(cmd) {
            const input = document.getElementById('messageInput');
            input.value = cmd + ' ';
            input.focus();
        }

        // ========== Áî®Êà∑ÂàóË°® ==========
        function updateUserList(users) {
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            if (!users || users.length === 0) {
                userList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ÊöÇÊó†Âú®Á∫øÁî®Êà∑</div>';
                return;
            }
            
            userList.innerHTML = users.map(user => {
                const avatar = user.username.charAt(0).toUpperCase();
                const isCurrentUser = user.username === currentUsername;
                const inGame = gameState.players?.some(p => p.username === user.username);
                const isDead = inGame && gameState.players?.find(p => p.username === user.username)?.isAlive === false;
                
                let userClass = 'user-card';
                if (inGame) userClass += ' in-game';
                if (isDead) userClass += ' dead';
                
                return `
                    <div class="${userClass}" onclick="quickCommand('/vote @${user.username}')">
                        <div class="user-avatar" style="background: ${user.color || '#4a90e2'}">
                            ${avatar}
                        </div>
                        <div class="user-info">
                            <div class="user-name">
                                ${escapeHtml(user.username)}
                                ${isCurrentUser ? ' (‰Ω†)' : ''}
                                ${user.isAdmin ? ' üëë' : ''}
                                ${isDead ? ' üíÄ' : ''}
                            </div>
                            <div class="user-status">
                                ${inGame ? '<span style="color: var(--success)">Ê∏∏Êàè‰∏≠</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateOnlineCount(count) {
            const onlineCount = document.getElementById('onlineCount');
            const onlineCountDetail = document.getElementById('onlineCountDetail');
            if (onlineCount) onlineCount.textContent = count;
            if (onlineCountDetail) onlineCountDetail.textContent = count;
        }

        // ========== Ê∏∏ÊàèÂäüËÉΩ ==========
        function updateGameState(state) {
            gameState = { 
                ...gameState, 
                isPlaying: state.isPlaying,
                players: state.players || [],
                hostId: state.hostId,
                playerCount: state.playerCount || (state.players ? state.players.length : 0),
                gamePhase: state.gamePhase || 'waiting',
                dayCount: state.dayCount || 1,
                phaseEndTime: state.phaseEndTime
            };
            
            console.log('Êõ¥Êñ∞ÂêéÁöÑÊ∏∏ÊàèÁä∂ÊÄÅ:', gameState);
            
            const gamePlayers = document.getElementById('gamePlayers');
            const playerCount = document.getElementById('playerCount');
            const gameStatus = document.getElementById('gameStatus');
            const joinGameBtn = document.getElementById('joinGameBtn');
            const leaveGameBtn = document.getElementById('leaveGameBtn');
            const startGameBtn = document.getElementById('startGameBtn');
            
            if (playerCount) {
                playerCount.textContent = `${gameState.playerCount}/8`;
            }
            
            if (gameStatus) {
                if (gameState.isPlaying) {
                    let phaseText = '';
                    switch(gameState.gamePhase) {
                        case 'night': phaseText = `üåô Á¨¨${gameState.dayCount}Â§©Â§úÊôö`; break;
                        case 'day': phaseText = `‚òÄÔ∏è Á¨¨${gameState.dayCount}Â§©ÁôΩÂ§©`; break;
                        case 'vote': phaseText = `üó≥Ô∏è Á¨¨${gameState.dayCount}Â§©ÊäïÁ•®`; break;
                        default: phaseText = 'Ê∏∏Êàè‰∏≠';
                    }
                    gameStatus.textContent = phaseText;
                } else {
                    gameStatus.textContent = 'Á≠âÂæÖÂºÄÂßã';
                }
            }
            
            if (gamePlayers) {
                if (gameState.players.length === 0) {
                    gamePlayers.innerHTML = '<div style="grid-column: span 2; text-align: center; padding: 20px; color: #999;">ÊöÇÊó†Áé©ÂÆ∂</div>';
                } else {
                    gamePlayers.innerHTML = gameState.players.map(p => {
                        const isHost = p.userId === gameState.hostId;
                        const isCurrent = p.userId === currentUserId;
                        return `
                            <div class="game-player ${p.isAlive === false ? 'dead' : 'alive'}">
                                <span>
                                    ${escapeHtml(p.username)}
                                    ${isCurrent ? ' (‰Ω†)' : ''}
                                </span>
                                ${isHost ? '<span style="color: #f39c12;">üëë</span>' : ''}
                            </div>
                        `;
                    }).join('');
                }
            }
            
            const isInGame = gameState.players.some(p => p.userId === currentUserId);
            
            if (gameState.isPlaying) {
                joinGameBtn.style.display = 'none';
                leaveGameBtn.style.display = 'none';
                startGameBtn.style.display = 'none';
            } else {
                if (isInGame) {
                    joinGameBtn.style.display = 'none';
                    leaveGameBtn.style.display = 'block';
                    
                    if (gameState.hostId === currentUserId && gameState.players.length >= 5) {
                        startGameBtn.style.display = 'block';
                        startGameBtn.disabled = false;
                    } else {
                        startGameBtn.style.display = 'none';
                    }
                } else {
                    joinGameBtn.style.display = 'block';
                    leaveGameBtn.style.display = 'none';
                    startGameBtn.style.display = 'none';
                }
            }
        }

        function updateGameTimer(remaining) {
            const timer = document.getElementById('gameTimer');
            if (timer) {
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function updateGameInstructions(role) {
            const instructionList = document.getElementById('instructionList');
            if (!instructionList) return;
            
            let commands = [
                { cmd: 'join', desc: 'Âä†ÂÖ•Ê∏∏Êàè' },
                { cmd: 'leave', desc: 'Á¶ªÂºÄÊ∏∏Êàè' },
                { cmd: 'players', desc: 'Êü•ÁúãÂ≠òÊ¥ªÁé©ÂÆ∂' },
                { cmd: 'roles', desc: 'Êü•ÁúãÂâ©‰ΩôËßíËâ≤' },
                { cmd: 'help', desc: 'Êü•ÁúãÊâÄÊúâÊåá‰ª§' }
            ];
            
            if (gameState.isPlaying) {
                if (role === 'Áãº‰∫∫') {
                    commands.unshift({ cmd: 'kill @Áî®Êà∑Âêç', desc: 'ÊùÄÊ≠ª‰∏ÄÂêçÁé©ÂÆ∂' });
                } else if (role === 'È¢ÑË®ÄÂÆ∂') {
                    commands.unshift({ cmd: 'check @Áî®Êà∑Âêç', desc: 'Êü•È™å‰∏ÄÂêçÁé©ÂÆ∂' });
                } else if (role === 'Â•≥Â∑´') {
                    commands.unshift(
                        { cmd: 'save @Áî®Êà∑Âêç', desc: '‰ΩøÁî®Ëß£ËçØÊïë‰∫∫' },
                        { cmd: 'poison @Áî®Êà∑Âêç', desc: '‰ΩøÁî®ÊØíËçØÊØí‰∫∫' },
                        { cmd: 'skip', desc: 'Ë∑≥ËøáË°åÂä®' }
                    );
                } else if (role === 'Áåé‰∫∫' && !gameState.players.find(p => p.userId === currentUserId)?.isAlive) {
                    commands.unshift({ cmd: 'shoot @Áî®Êà∑Âêç', desc: 'ÂºÄÊû™Â∏¶Ëµ∞‰∏Ä‰∫∫' });
                }
                
                if (gameState.gamePhase === 'vote') {
                    commands.unshift({ cmd: 'vote @Áî®Êà∑Âêç', desc: 'ÊäïÁ•®ÊîæÈÄê' });
                }
            }
            
            instructionList.innerHTML = commands.map(c => `
                <li onclick="quickCommand('/${c.cmd.split(' ')[0]}')">
                    <span class="instruction-cmd">/${c.cmd}</span>
                    <span class="instruction-desc">${c.desc}</span>
                </li>
            `).join('');
        }

        // ========== ÁÆ°ÁêÜÂëòÈù¢ÊùøÊéßÂà∂ ==========
        function showAdminPanel() {
            const panel = document.getElementById('adminPanel');
            if (panel) {
                panel.style.display = 'block';
                ws.send(JSON.stringify({ type: 'adminGetUsers' }));
                ws.send(JSON.stringify({ type: 'adminGetHistory' }));
                ws.send(JSON.stringify({ type: 'adminGetBanned' }));
            }
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.style.display = 'none');
            
            if (tab === 'users') {
                document.querySelectorAll('.admin-tab')[0].classList.add('active');
                document.getElementById('adminUsersTab').style.display = 'block';
                ws.send(JSON.stringify({ type: 'adminGetUsers' }));
            } else if (tab === 'messages') {
                document.querySelectorAll('.admin-tab')[1].classList.add('active');
                document.getElementById('adminMessagesTab').style.display = 'block';
                ws.send(JSON.stringify({ type: 'adminGetHistory' }));
            } else if (tab === 'bans') {
                document.querySelectorAll('.admin-tab')[2].classList.add('active');
                document.getElementById('adminBansTab').style.display = 'block';
                ws.send(JSON.stringify({ type: 'adminGetBanned' }));
            }
        }

        function updateAdminUsers(users) {
            adminUsers = users;
            const userList = document.getElementById('adminUserList');
            if (!userList) return;
            
            if (!users || users.length === 0) {
                userList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ÊöÇÊó†Âú®Á∫øÁî®Êà∑</div>';
                return;
            }
            
            userList.innerHTML = users.map(user => {
                const status = [];
                if (user.isMuted) status.push('<span class="status-badge status-muted">Á¶ÅË®Ä</span>');
                if (user.isAdmin) status.push('<span class="status-badge status-admin">ÁÆ°ÁêÜÂëò</span>');
                if (status.length === 0) status.push('<span class="status-badge status-normal">Ê≠£Â∏∏</span>');
                
                return `
                    <div class="admin-user-item">
                        <div class="admin-user-info">
                            <span class="admin-user-name">${escapeHtml(user.username)}</span>
                            <span class="admin-user-ip">${user.ip}</span>
                            <div class="admin-user-status">
                                ${status.join(' ')}
                            </div>
                        </div>
                        <div class="admin-user-actions">
                            ${user.isAdmin ? '<span style="color:#f39c12;">ÁÆ°ÁêÜÂëò</span>' : ''}
                            ${!user.isAdmin ? (user.isMuted ? 
                                `<button class="btn-unmute" onclick="adminUnmute('${user.username}')">ÂèñÊ∂àÁ¶ÅË®Ä</button>` : 
                                `<button class="btn-mute" onclick="adminMute('${user.username}')">Á¶ÅË®Ä</button>`
                            ) : ''}
                            ${!user.isAdmin ? `<button class="btn-ban" onclick="adminBan('${user.username}')">Â∞ÅÁ¶ÅIP</button>` : ''}
                            ${!user.isAdmin ? `<button class="btn-kick" onclick="adminKick('${user.username}')">Ë∏¢Âá∫</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAdminMessages(messages) {
            adminMessages = messages;
            const messageList = document.getElementById('adminMessageList');
            if (!messageList) return;
            
            if (!messages || messages.length === 0) {
                messageList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ÊöÇÊó†Ê∂àÊÅØËÆ∞ÂΩï</div>';
                return;
            }
            
            messageList.innerHTML = messages.slice().reverse().map(msg => `
                <div class="admin-message-item">
                    <div class="admin-message-header">
                        <span>${escapeHtml(msg.username)}</span>
                        <span>${msg.timestamp}</span>
                    </div>
                    <div class="admin-message-content">${escapeHtml(msg.content)}</div>
                    <div class="admin-message-id">ID: ${msg.id}</div>
                    <div class="admin-message-actions">
                        <button class="btn-recall" onclick="adminRecall('${msg.id}')">Êí§Âõû</button>
                    </div>
                </div>
            `).join('');
        }

        function updateBannedIPs(ips) {
            const banList = document.getElementById('adminBanList');
            if (!banList) return;
            
            if (!ips || ips.length === 0) {
                banList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ÊöÇÊó†Â∞ÅÁ¶ÅIP</div>';
                return;
            }
            
            banList.innerHTML = ips.map(ip => `
                <div class="admin-user-item">
                    <div class="admin-user-info">
                        <span class="admin-user-ip">${ip}</span>
                        <div class="admin-user-status">
                            <span class="status-badge status-banned">Â∑≤Â∞ÅÁ¶Å</span>
                        </div>
                    </div>
                    <div class="admin-user-actions">
                        <button class="btn-unmute" onclick="adminUnban('${ip}')">Ëß£Â∞Å</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== ÁÆ°ÁêÜÂëòÊìç‰ΩúÂáΩÊï∞ ==========
        function adminMute(username) {
            const reason = prompt('ËØ∑ËæìÂÖ•Á¶ÅË®ÄÂéüÂõ†Ôºö', 'ËøùËßÑÂèëË®Ä');
            if (reason !== null) {
                ws.send(JSON.stringify({
                    type: 'adminMute',
                    username: username,
                    reason: reason
                }));
                addTerminalLog(`[ADMIN] ÂèëÈÄÅÁ¶ÅË®ÄÂëΩ‰ª§: ${username}`, 'admin');
                showAdminNotification(`Â∑≤ÂèëÈÄÅÁ¶ÅË®ÄËØ∑Ê±Ç: ${username}`);
            }
        }

        function adminUnmute(username) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂèñÊ∂à ${username} ÁöÑÁ¶ÅË®ÄÂêóÔºü`)) {
                ws.send(JSON.stringify({
                    type: 'adminUnmute',
                    username: username
                }));
                addTerminalLog(`[ADMIN] ÂèëÈÄÅÂèñÊ∂àÁ¶ÅË®ÄÂëΩ‰ª§: ${username}`, 'admin');
                showAdminNotification(`Â∑≤ÂèëÈÄÅÂèñÊ∂àÁ¶ÅË®ÄËØ∑Ê±Ç: ${username}`);
            }
        }

        function adminBan(username) {
            const reason = prompt('ËØ∑ËæìÂÖ•Â∞ÅÁ¶ÅÂéüÂõ†Ôºö', 'ÊÅ∂ÊÑèË°å‰∏∫');
            if (reason !== null) {
                if (confirm(`Á°ÆÂÆöË¶ÅÂ∞ÅÁ¶Å ${username} ÁöÑIPÂêóÔºü`)) {
                    ws.send(JSON.stringify({
                        type: 'adminBan',
                        username: username,
                        reason: reason
                    }));
                    addTerminalLog(`[ADMIN] ÂèëÈÄÅÂ∞ÅÁ¶ÅÂëΩ‰ª§: ${username}`, 'admin');
                    showAdminNotification(`Â∑≤ÂèëÈÄÅÂ∞ÅÁ¶ÅËØ∑Ê±Ç: ${username}`);
                }
            }
        }

        function adminUnban(ip) {
            if (confirm(`Á°ÆÂÆöË¶ÅËß£Â∞ÅIP ${ip} ÂêóÔºü`)) {
                ws.send(JSON.stringify({
                    type: 'adminUnban',
                    ip: ip
                }));
                addTerminalLog(`[ADMIN] ÂèëÈÄÅËß£Â∞ÅÂëΩ‰ª§: ${ip}`, 'admin');
                showAdminNotification(`Â∑≤ÂèëÈÄÅËß£Â∞ÅËØ∑Ê±Ç: ${ip}`);
            }
        }

        function adminKick(username) {
            const reason = prompt('ËØ∑ËæìÂÖ•Ë∏¢Âá∫ÂéüÂõ†Ôºö', 'ËøùËßÑË°å‰∏∫');
            if (reason !== null) {
                if (confirm(`Á°ÆÂÆöË¶ÅÂ∞Ü ${username} Ë∏¢Âá∫ËÅäÂ§©ÂÆ§ÂêóÔºü`)) {
                    ws.send(JSON.stringify({
                        type: 'adminKick',
                        username: username,
                        reason: reason
                    }));
                    addTerminalLog(`[ADMIN] ÂèëÈÄÅË∏¢Âá∫ÂëΩ‰ª§: ${username}`, 'admin');
                    showAdminNotification(`Â∑≤ÂèëÈÄÅË∏¢Âá∫ËØ∑Ê±Ç: ${username}`);
                }
            }
        }

        function adminRecall(messageId) {
            const reason = prompt('ËØ∑ËæìÂÖ•Êí§ÂõûÂéüÂõ†Ôºö', '‰∏çÂΩìË®ÄËÆ∫');
            if (reason !== null) {
                if (confirm(`Á°ÆÂÆöË¶ÅÊí§ÂõûËøôÊù°Ê∂àÊÅØÂêóÔºü`)) {
                    ws.send(JSON.stringify({
                        type: 'adminRecall',
                        messageId: messageId,
                        reason: reason
                    }));
                    addTerminalLog(`[ADMIN] ÂèëÈÄÅÊí§ÂõûÂëΩ‰ª§: ${messageId}`, 'admin');
                    showAdminNotification(`Â∑≤ÂèëÈÄÅÊí§ÂõûËØ∑Ê±Ç: ${messageId}`);
                }
            }
        }

        function showAdminNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'admin-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ========== CMDÁªàÁ´ØÂäüËÉΩ ==========
        function initTerminal() {
            addTerminalLog('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'info');
            addTerminalLog('‚ïë               SUCCESS                ‚ïë', 'success');
            addTerminalLog('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'info');
            addTerminalLog('', 'info');
            addTerminalLog('Á≥ªÁªüÊó∂Èó¥: ' + new Date().toLocaleString(), 'info');
            addTerminalLog('ÂΩìÂâçÁî®Êà∑: ' + currentUsername, 'info');
            addTerminalLog('IPÂú∞ÂùÄ: ' + (currentUserIp || 'Unknown'), 'info');
            addTerminalLog('', 'info');
            addTerminalLog('ËæìÂÖ• "help" Êü•ÁúãÂèØÁî®ÂëΩ‰ª§', 'info');
        }

        function toggleTerminal() {
            // ÊâãÊú∫Á´Ø‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
            if (window.innerWidth <= 768) return;
            
            const terminal = document.getElementById('cmdTerminal');
            const toggleBtn = document.getElementById('terminalToggle');
            
            terminalVisible = !terminalVisible;
            if (terminalVisible) {
                terminal.classList.add('visible');
                toggleBtn.classList.add('active');
                toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                
                if (currentUserIsAdmin) {
                    document.getElementById('cmdInput').disabled = false;
                    document.getElementById('cmdInput').focus();
                }
            } else {
                terminal.classList.remove('visible');
                toggleBtn.classList.remove('active');
                toggleBtn.innerHTML = '<i class="fas fa-terminal"></i>';
                document.getElementById('cmdInput').disabled = true;
            }
        }

        function addTerminalLog(message, type = 'info') {
            // ÊâãÊú∫Á´Ø‰∏çËÆ∞ÂΩïÊó•Âøó
            if (window.innerWidth <= 768) return;
            
            const timestamp = new Date().toLocaleTimeString();
            let logClass = 'cmd-log-info';
            
            switch(type) {
                case 'warning': logClass = 'cmd-log-warning'; break;
                case 'error': logClass = 'cmd-log-error'; break;
                case 'success': logClass = 'cmd-log-success'; break;
                case 'admin': logClass = 'cmd-log-admin'; break;
                case 'game': logClass = 'cmd-log-game'; break;
            }
            
            const logLine = `<span class="cmd-timestamp">[${timestamp}]</span> <span class="${logClass}">${message}</span>`;
            terminalLogs.push(logLine);
            
            const terminalContent = document.getElementById('terminalContent');
            if (terminalContent) {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'cmd-line';
                lineDiv.innerHTML = logLine;
                terminalContent.appendChild(lineDiv);
                
                terminalContent.scrollTop = terminalContent.scrollHeight;
            }
        }

        function clearTerminal() {
            const terminalContent = document.getElementById('terminalContent');
            if (terminalContent) {
                terminalContent.innerHTML = '';
                terminalLogs = [];
                addTerminalLog('ÊéßÂà∂Âè∞Â∑≤Ê∏ÖÁ©∫', 'info');
                addTerminalLog('ËæìÂÖ• "help" Êü•ÁúãÂèØÁî®ÂëΩ‰ª§', 'info');
            }
        }

        // Â§ÑÁêÜÁÆ°ÁêÜÂëòÂëΩ‰ª§
        function handleAdminCommand(command) {
            const parts = command.split(' ');
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);

            addTerminalLog(`ADMIN@SERVER:~$ ${command}`, 'info');

            switch(cmd) {
                case 'help':
                    addTerminalLog('ÂèØÁî®ÂëΩ‰ª§:', 'info');
                    Object.entries(ADMIN_COMMANDS).forEach(([cmd, desc]) => {
                        addTerminalLog(`  ${cmd.padEnd(20)} - ${desc}`, 'info');
                    });
                    break;

                case 'users':
                    addTerminalLog('Ëé∑ÂèñÂú®Á∫øÁî®Êà∑ÂàóË°®...', 'info');
                    ws.send(JSON.stringify({ type: 'adminGetUsers' }));
                    break;

                case 'userinfo':
                    if (args.length < 1) {
                        addTerminalLog('Áî®Ê≥ï: userinfo <Áî®Êà∑Âêç>', 'error');
                        return;
                    }
                    const username = args[0];
                    const user = adminUsers.find(u => u.username === username);
                    if (user) {
                        addTerminalLog(`Áî®Êà∑‰ø°ÊÅØ: ${user.username}`, 'success');
                        addTerminalLog(`  ID: ${user.id}`, 'info');
                        addTerminalLog(`  IP: ${user.ip}`, 'info');
                        addTerminalLog(`  Áä∂ÊÄÅ: ${user.isMuted ? 'Á¶ÅË®Ä‰∏≠' : 'Ê≠£Â∏∏'}`, user.isMuted ? 'warning' : 'success');
                        addTerminalLog(`  ÁÆ°ÁêÜÂëò: ${user.isAdmin ? 'ÊòØ' : 'Âê¶'}`, user.isAdmin ? 'admin' : 'info');
                    } else {
                        addTerminalLog(`Áî®Êà∑ ${username} ‰∏çÂ≠òÂú®`, 'error');
                    }
                    break;

                case 'mute':
                    if (args.length < 1) {
                        addTerminalLog('Áî®Ê≥ï: mute <Áî®Êà∑Âêç> [ÂéüÂõ†]', 'error');
                        return;
                    }
                    const muteUser = args[0];
                    const muteReason = args.slice(1).join(' ') || 'ÁÆ°ÁêÜÂëòÊìç‰Ωú';
                    ws.send(JSON.stringify({
                        type: 'adminMute',
                        username: muteUser,
                        reason: muteReason
                    }));
                    addTerminalLog(`Â∑≤ÂèëÈÄÅÁ¶ÅË®ÄÂëΩ‰ª§: ${muteUser}`, 'admin');
                    break;

                case 'unmute':
                    if (args.length < 1) {
                        addTerminalLog('Áî®Ê≥ï: unmute <Áî®Êà∑Âêç>', 'error');
                        return;
                    }
                    ws.send(JSON.stringify({
                        type: 'adminUnmute',
                        username: args[0]
                    }));
                    addTerminalLog(`Â∑≤ÂèëÈÄÅÂèñÊ∂àÁ¶ÅË®ÄÂëΩ‰ª§: ${args[0]}`, 'admin');
                    break;

                case 'kick':
                    if (args.length < 1) {
                        addTerminalLog('Áî®Ê≥ï: kick <Áî®Êà∑Âêç> [ÂéüÂõ†]', 'error');
                        return;
                    }
                    const kickUser = args[0];
                    const kickReason = args.slice(1).join(' ') || 'ÁÆ°ÁêÜÂëòÊìç‰Ωú';
                    ws.send(JSON.stringify({
                        type: 'adminKick',
                        username: kickUser,
                        reason: kickReason
                    }));
                    addTerminalLog(`Â∑≤ÂèëÈÄÅË∏¢Âá∫ÂëΩ‰ª§: ${kickUser}`, 'admin');
                    break;

                case 'ban':
                    if (args.length < 1) {
                        addTerminalLog('Áî®Ê≥ï: ban <Áî®Êà∑Âêç/IP> [ÂéüÂõ†]', 'error');
                        return;
                    }
                    const target = args[0];
                    const banReason = args.slice(1).join(' ') || 'ÁÆ°ÁêÜÂëòÊìç‰Ωú';
                    
                    // Âà§Êñ≠ÊòØIPËøòÊòØÁî®Êà∑Âêç
                    if (target.includes('.')) {
                        ws.send(JSON.stringify({
                            type: 'adminBan',
                            ip: target,
                            reason: banReason
                        }));
                        addTerminalLog(`Â∑≤ÂèëÈÄÅÂ∞ÅÁ¶ÅIPÂëΩ‰ª§: ${target}`, 'admin');
                    } else {
                        ws.send(JSON.stringify({
                            type: 'adminBan',
                            username: target,
                            reason: banReason
                        }));
                        addTerminalLog(`Â∑≤ÂèëÈÄÅÂ∞ÅÁ¶ÅÁî®Êà∑ÂëΩ‰ª§: ${target}`, 'admin');
                    }
                    break;

                case 'unban':
                    if (args.length < 1) {
                        addTerminalLog('Áî®Ê≥ï: unban <IP>', 'error');
                        return;
                    }
                    ws.send(JSON.stringify({
                        type: 'adminUnban',
                        ip: args[0]
                    }));
                    addTerminalLog(`Â∑≤ÂèëÈÄÅËß£Â∞ÅIPÂëΩ‰ª§: ${args[0]}`, 'admin');
                    break;

                case 'recall':
                    if (args.length < 1) {
                        addTerminalLog('Áî®Ê≥ï: recall <Ê∂àÊÅØID> [ÂéüÂõ†]', 'error');
                        return;
                    }
                    const msgId = args[0];
                    const recallReason = args.slice(1).join(' ') || 'ÁÆ°ÁêÜÂëòÊìç‰Ωú';
                    ws.send(JSON.stringify({
                        type: 'adminRecall',
                        messageId: msgId,
                        reason: recallReason
                    }));
                    addTerminalLog(`Â∑≤ÂèëÈÄÅÊí§ÂõûÂëΩ‰ª§: ${msgId}`, 'admin');
                    break;

                case 'logs':
                    const limit = args.length > 0 ? parseInt(args[0]) : 50;
                    addTerminalLog(`Ëé∑ÂèñÊúÄËøë ${limit} Êù°Êó•Âøó...`, 'info');
                    ws.send(JSON.stringify({ type: 'adminGetLogs' }));
                    break;

                case 'search':
                    if (args.length < 1) {
                        addTerminalLog('Áî®Ê≥ï: search <Áî®Êà∑Âêç/IP>', 'error');
                        return;
                    }
                    const searchTerm = args[0].toLowerCase();
                    
                    // ÊêúÁ¥¢Áî®Êà∑
                    const matchedUsers = adminUsers.filter(u => 
                        u.username.toLowerCase().includes(searchTerm) || 
                        u.ip.includes(searchTerm)
                    );
                    
                    if (matchedUsers.length > 0) {
                        addTerminalLog(`ÊâæÂà∞ ${matchedUsers.length} ‰∏™ÂåπÈÖçÁöÑÁî®Êà∑:`, 'success');
                        matchedUsers.forEach(u => {
                            addTerminalLog(`  ${u.username} - IP: ${u.ip} - Áä∂ÊÄÅ: ${u.isMuted ? 'Á¶ÅË®Ä' : 'Ê≠£Â∏∏'}`, 'info');
                        });
                    } else {
                        addTerminalLog('Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÁî®Êà∑', 'warning');
                    }
                    
                    // ÊêúÁ¥¢Â∞ÅÁ¶ÅIP
                    const matchedBans = bannedIPs.filter(ip => ip.includes(searchTerm));
                    if (matchedBans.length > 0) {
                        addTerminalLog(`ÊâæÂà∞ ${matchedBans.length} ‰∏™ÂåπÈÖçÁöÑÂ∞ÅÁ¶ÅIP:`, 'warning');
                        matchedBans.forEach(ip => {
                            addTerminalLog(`  ${ip}`, 'warning');
                        });
                    }
                    break;

                case 'stats':
                    addTerminalLog('ÊúçÂä°Âô®ÁªüËÆ°:', 'info');
                    addTerminalLog(`  Âú®Á∫øÁî®Êà∑: ${adminUsers.length}`, 'info');
                    addTerminalLog(`  Ê∏∏ÊàèËøõË°å‰∏≠: ${gameState.isPlaying ? 'ÊòØ' : 'Âê¶'}`, 'info');
                    addTerminalLog(`  Ê∏∏ÊàèÁé©ÂÆ∂: ${gameState.players.length}/8`, 'info');
                    addTerminalLog(`  Ê∂àÊÅØÊÄªÊï∞: ${adminMessages.length}`, 'info');
                    addTerminalLog(`  Â∞ÅÁ¶ÅIPÊï∞: ${bannedIPs.length}`, 'info');
                    addTerminalLog(`  Êó•ÂøóÊù°Êï∞: ${terminalLogs.length}`, 'info');
                    break;

                case 'clear':
                    clearTerminal();
                    break;

                default:
                    addTerminalLog(`Êú™Áü•ÂëΩ‰ª§: ${cmd}`, 'error');
                    addTerminalLog('ËæìÂÖ• "help" Êü•ÁúãÂèØÁî®ÂëΩ‰ª§', 'info');
            }
        }

        // ========== ÂèØÊãñÂä®ÁªàÁ´Ø ==========
        function makeDraggable() {
            // ÊâãÊú∫Á´Ø‰∏çÂêØÁî®ÊãñÂä®
            if (window.innerWidth <= 768) return;
            
            const terminal = document.getElementById('cmdTerminal');
            const header = document.getElementById('terminalHeader');
            
            if (!terminal || !header) return;
            
            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                const rect = terminal.getBoundingClientRect();
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;
                terminal.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                e.preventDefault();
                const x = e.clientX - dragOffsetX;
                const y = e.clientY - dragOffsetY;
                
                terminal.style.left = x + 'px';
                terminal.style.top = y + 'px';
                terminal.style.right = 'auto';
                terminal.style.bottom = 'auto';
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                terminal.style.cursor = 'default';
            });
        }

        // ========== UIÊéßÂà∂ ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            
            if (tab === 'chat') {
                document.querySelectorAll('.tab-item')[0].classList.add('active');
                document.getElementById('chatPanel').classList.add('active');
            } else if (tab === 'users') {
                document.querySelectorAll('.tab-item')[1].classList.add('active');
                document.getElementById('usersPanel').classList.add('active');
            } else if (tab === 'game') {
                document.querySelectorAll('.tab-item')[2].classList.add('active');
                document.getElementById('gamePanel').classList.add('active');
                
                if (isConnected) {
                    ws.send(JSON.stringify({ type: 'getGameState' }));
                }
            }
        }

        // ========== Â∑•ÂÖ∑ÂáΩÊï∞ ==========
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            } else {
                alert(message);
            }
        }

        // ========== ‰∫ã‰ª∂ÁõëÂê¨ ==========
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            const usernameInput = document.getElementById('username');
            
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }

            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        joinChat();
                    }
                });
            }

            // CMDËæìÂÖ•Â§ÑÁêÜ
            const cmdInput = document.getElementById('cmdInput');
            if (cmdInput) {
                cmdInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const command = this.value.trim();
                        if (command) {
                            handleAdminCommand(command);
                            this.value = '';
                            
                            cmdHistory.push(command);
                            cmdHistoryIndex = cmdHistory.length;
                        }
                    }
                });

                cmdInput.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (cmdHistoryIndex > 0) {
                            cmdHistoryIndex--;
                            this.value = cmdHistory[cmdHistoryIndex];
                        }
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (cmdHistoryIndex < cmdHistory.length - 1) {
                            cmdHistoryIndex++;
                            this.value = cmdHistory[cmdHistoryIndex];
                        } else {
                            cmdHistoryIndex = cmdHistory.length;
                            this.value = '';
                        }
                    }
                });
            }

            // Ê†πÊçÆÂ±èÂπïÂÆΩÂ∫¶ÂÜ≥ÂÆöÊòØÂê¶ÂàùÂßãÂåñÊãñÂä®
            if (window.innerWidth > 768) {
                makeDraggable();
            }

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Êåá‰ª§Âª∫ËÆÆ
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.message-input-wrapper') && !e.target.closest('.command-suggestions')) {
                    hideCommandSuggestions();
                }
            });
        });

        // È°µÈù¢ÂÖ≥Èó≠ÂâçÊ∏ÖÁêÜ
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });

        // Ê∑ªÂä†Ê∏∏ÊàèÁé©ÂÆ∂Ê†∑Âºè
        const style = document.createElement('style');
        style.textContent = `
            .game-player.alive {
                border-left: 3px solid #2ecc71;
            }
            .game-player.dead {
                border-left: 3px solid #e74c3c;
                opacity: 0.6;
            }
        `;
        document.head.appendChild(style);

        // ÂêØÂä®ËøûÊé•
        connect();
    </script>
</body>
</html>