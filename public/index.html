<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>èŠå¤©å®¤</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      :root {
        --primary: #4a90e2;
        --primary-dark: #357abd;
        --secondary: #667eea;
        --accent: #764ba2;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --dark: #2c3e50;
        --light: #f5f7fa;

        --safe-area-top: env(safe-area-inset-top, 0px);
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
          "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        padding: 0;
        margin: 0;
      }

      .app-container {
        width: 100%;
        max-width: 500px;
        height: 100vh;
        background: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      }

      /* ç™»å½•åŒºåŸŸ */
      .login-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        padding: 20px;
      }

      .login-box {
        background: white;
        padding: 30px 20px;
        border-radius: 20px;
        width: 100%;
        max-width: 320px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .login-box h3 {
        text-align: center;
        margin-bottom: 25px;
        color: var(--dark);
        font-size: 24px;
      }

      .login-box h3 i {
        color: var(--primary);
        margin-right: 10px;
      }

      .login-box input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .login-box input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
      }

      .login-box button {
        width: 100%;
        padding: 15px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .login-box button:hover {
        background: var(--primary-dark);
      }

      .login-box button:active {
        transform: scale(0.98);
      }

      .login-box button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      #loginError {
        color: var(--danger);
        margin-top: 15px;
        text-align: center;
        font-size: 14px;
        display: none;
        padding: 10px;
        background: rgba(231, 76, 60, 0.1);
        border-radius: 8px;
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .login-tip {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 13px;
      }

      .login-tip p {
        margin-bottom: 3px;
      }

      .login-tip code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        color: var(--danger);
      }

      /* è¿æ¥çŠ¶æ€ */
      .connection-status {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 1001;
        display: none;
      }

      .status-connected {
        background: var(--success);
        color: white;
      }

      .status-disconnected {
        background: var(--danger);
        color: white;
      }

      .status-connecting {
        background: var(--warning);
        color: white;
      }

      /* ç§»åŠ¨ç«¯å¤´éƒ¨ */
      .mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        padding-top: max(12px, var(--safe-area-top));
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        flex-shrink: 0;
      }

      .mobile-header h2 {
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mobile-header h2 i {
        font-size: 20px;
      }

      .online-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
      }

      /* æ ‡ç­¾é¡µå¯¼èˆª */
      .tab-bar {
        display: flex;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        flex-shrink: 0;
      }

      .tab-item {
        flex: 1;
        text-align: center;
        padding: 12px 0;
        font-size: 14px;
        color: #666;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
      }

      .tab-item.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        font-weight: 600;
      }

      .tab-item i {
        font-size: 16px;
      }

      /* å†…å®¹åŒºåŸŸ */
      .content-area {
        flex: 1;
        overflow: hidden;
        position: relative;
        background: #f8f9fa;
      }

      .tab-panel {
        display: none;
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: var(--safe-area-bottom);
      }

      .tab-panel.active {
        display: block;
      }

      /* èŠå¤©é¢æ¿ */
      .chat-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .message {
        max-width: 85%;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.system {
        align-self: center;
        max-width: 90%;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 20px;
        padding: 6px 16px;
      }

      .system-content {
        font-size: 12px;
        color: #666;
        text-align: center;
        word-break: break-word;
      }

      .message.private {
        align-self: center;
        max-width: 90%;
        background: rgba(74, 144, 226, 0.1);
        border-radius: 20px;
        padding: 8px 16px;
        border-left: 3px solid var(--primary);
      }

      .private-content {
        font-size: 13px;
        color: var(--primary-dark);
        text-align: center;
        font-weight: 500;
      }

      .message.chat {
        align-self: flex-start;
      }

      .message.own-message {
        align-self: flex-end;
      }

      .message-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
        padding: 0 4px;
      }

      .own-message .message-header {
        flex-direction: row-reverse;
      }

      .message-username {
        font-size: 12px;
        font-weight: 600;
        color: var(--primary);
      }

      .message-time {
        font-size: 10px;
        color: #999;
      }

      .message-bubble {
        background: white;
        padding: 10px 14px;
        border-radius: 18px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
      }

      .own-message .message-bubble {
        background: var(--primary);
        color: white;
      }

      .command-highlight {
        background: rgba(255, 215, 0, 0.2);
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
        font-weight: bold;
      }

      /* è¾“å…¥åŒºåŸŸ */
      .input-area {
        background: white;
        border-top: 1px solid #e0e0e0;
        padding: 12px 16px;
        padding-bottom: max(12px, var(--safe-area-bottom));
        display: flex;
        gap: 10px;
        align-items: flex-end;
        position: relative;
      }

      .message-input-wrapper {
        flex: 1;
        position: relative;
      }

      .message-input {
        width: 100%;
        padding: 14px 45px 14px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 28px;
        font-size: 15px;
        resize: none;
        max-height: 120px;
        background: #f8f9fa;
        font-family: inherit;
        transition: all 0.3s ease;
        line-height: 1.5;
      }

      .message-input:focus {
        border-color: var(--primary);
        outline: none;
        background: white;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
      }

      .message-input:disabled {
        background: #e9ecef;
        opacity: 0.7;
      }

      .message-input.command-mode {
        border-color: #f39c12;
        background: #fff8e7;
      }

      .command-prompt {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #f39c12;
        font-weight: bold;
        font-size: 18px;
        display: none;
        z-index: 2;
      }

      .command-prompt.visible {
        display: block;
      }

      .command-input {
        padding-left: 35px !important;
      }

      .send-btn {
        padding: 0 24px;
        height: 48px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 28px;
        font-size: 15px;
        font-weight: 600;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
      }

      .send-btn i {
        font-size: 15px;
      }

      .send-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(74, 144, 226, 0.4);
      }

      .send-btn:active {
        transform: translateY(0);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* æŒ‡ä»¤å»ºè®® - å®šä½åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ */
      .command-suggestions {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -8px 25px rgba(0, 0, 0, 0.15);
        border: 1px solid #e0e0e0;
        border-bottom: none;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        z-index: 100;
        margin-bottom: 8px;
      }

      .command-suggestions.visible {
        display: block;
        animation: slideUp 0.2s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .suggestion-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-item:hover {
        background: #f8f9fa;
      }

      .suggestion-item.selected {
        background: #e3f2fd;
        border-left: 3px solid var(--primary);
      }

      .suggestion-cmd {
        font-weight: 600;
        color: var(--primary);
        min-width: 90px;
        font-size: 14px;
        background: rgba(74, 144, 226, 0.1);
        padding: 4px 8px;
        border-radius: 16px;
        text-align: center;
      }

      .suggestion-desc {
        font-size: 13px;
        color: #666;
        flex: 1;
      }

      /* å¿«é€ŸæŒ‡ä»¤æŒ‰é’® - å®šä½åœ¨è¾“å…¥æ¡†ä¸Šæ–¹å·¦ä¾§ */
      .quick-commands {
        position: absolute;
        bottom: 100%;
        left: 0;
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        z-index: 99;
      }

      .quick-cmd-btn {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 8px 14px;
        font-size: 13px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
      }

      .quick-cmd-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        background: var(--primary-dark);
      }

      .quick-cmd-btn i {
        font-size: 12px;
      }

      /* æ‰“å­—æŒ‡ç¤ºå™¨ */
      .typing-indicator {
        padding: 5px 16px;
        font-size: 11px;
        color: #666;
        font-style: italic;
        background: white;
      }

      /* ç”¨æˆ·é¢æ¿ */
      .users-panel {
        padding: 16px;
      }

      .online-stats {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }

      .online-stats h3 {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .online-count {
        font-size: 32px;
        font-weight: bold;
      }

      .online-count small {
        font-size: 14px;
        opacity: 0.8;
        margin-left: 5px;
      }

      .user-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
      }

      .user-card {
        background: white;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .user-card.in-game {
        border-left: 3px solid var(--success);
      }

      .user-card.dead {
        opacity: 0.6;
        border-left: 3px solid var(--danger);
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
        flex-shrink: 0;
      }

      .user-info {
        flex: 1;
        min-width: 0;
      }

      .user-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .user-status {
        font-size: 11px;
        color: #999;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .user-role-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.05);
      }

      /* æ¸¸æˆé¢æ¿ */
      .game-panel {
        padding: 16px;
      }

      .game-header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 16px;
        position: relative;
        overflow: hidden;
      }

      .game-header::after {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 70%
        );
        animation: rotate 20s linear infinite;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .game-header h3 {
        font-size: 18px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        z-index: 1;
      }

      .game-phase-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
      }

      .game-phase-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
      }

      .game-timer {
        background: rgba(0, 0, 0, 0.3);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-family: monospace;
        font-weight: bold;
      }

      .game-players {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .game-players h4 {
        margin-bottom: 12px;
        color: var(--dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player-count {
        font-size: 14px;
        color: var(--primary);
      }

      .players-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .game-player {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 13px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
      }

      .game-player.alive {
        border-left: 3px solid var(--success);
      }

      .game-player.dead {
        border-left: 3px solid var(--danger);
        opacity: 0.6;
      }

      .player-role {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.1);
      }

      .game-instructions {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
        border: 1px solid #e0e0e0;
      }

      .game-instructions h5 {
        margin-bottom: 10px;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .instruction-list {
        list-style: none;
        padding: 0;
      }

      .instruction-list li {
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .instruction-list li:hover {
        background: rgba(74, 144, 226, 0.05);
      }

      .instruction-list li:last-child {
        border-bottom: none;
      }

      .instruction-cmd {
        background: var(--primary);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        min-width: 70px;
        text-align: center;
      }

      .instruction-desc {
        color: #666;
      }

      .game-btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .game-btn.primary {
        background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
        color: white;
      }

      .game-btn.secondary {
        background: #95a5a6;
        color: white;
      }

      .game-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .game-btn:active {
        transform: scale(0.98);
      }

      /* ç®¡ç†å‘˜é¢æ¿ */
      .admin-panel {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 16px;
        border-radius: 12px;
        margin: 10px;
        position: fixed;
        top: 60px;
        right: 10px;
        width: 350px;
        max-width: 90%;
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: none;
      }

      .admin-panel.visible {
        display: block;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .admin-header h3 {
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .admin-header h3 i {
        color: #f39c12;
      }

      .admin-close {
        background: none;
        border: none;
        color: #999;
        font-size: 20px;
        cursor: pointer;
      }

      .admin-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 10px;
      }

      .admin-tab {
        padding: 6px 12px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        border-radius: 20px;
        font-size: 13px;
      }

      .admin-tab.active {
        background: #f39c12;
        color: white;
      }

      .admin-content {
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
      }

      .admin-user-list,
      .admin-message-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .admin-user-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .admin-user-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .admin-user-name {
        font-weight: 600;
        font-size: 14px;
      }

      .admin-user-ip {
        font-size: 11px;
        opacity: 0.7;
      }

      .admin-user-status {
        font-size: 11px;
        display: flex;
        gap: 8px;
      }

      .status-badge {
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
      }

      .status-muted {
        background: #e74c3c;
      }

      .status-normal {
        background: #2ecc71;
      }

      .status-admin {
        background: #f39c12;
      }

      .status-banned {
        background: #c0392b;
      }

      .admin-user-actions {
        display: flex;
        gap: 5px;
      }

      .admin-user-actions button {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .admin-user-actions button:hover {
        transform: scale(1.05);
      }

      .btn-mute {
        background: #e74c3c;
        color: white;
      }

      .btn-unmute {
        background: #2ecc71;
        color: white;
      }

      .btn-kick {
        background: #95a5a6;
        color: white;
      }

      .btn-ban {
        background: #c0392b;
        color: white;
      }

      .admin-message-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
      }

      .admin-message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 11px;
        opacity: 0.8;
      }

      .admin-message-content {
        font-size: 13px;
        margin-bottom: 5px;
        word-break: break-word;
      }

      .admin-message-id {
        font-size: 9px;
        color: #999;
        margin-bottom: 5px;
      }

      .admin-message-actions {
        display: flex;
        gap: 5px;
        justify-content: flex-end;
      }

      .btn-recall {
        background: #e67e22;
        color: white;
        padding: 3px 8px;
        border: none;
        border-radius: 4px;
        font-size: 10px;
        cursor: pointer;
      }

      .admin-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #f39c12;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 1001;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      /* æŒ‡ä»¤å»ºè®®å›¾æ ‡ */
      .suggestion-icon {
        font-size: 16px;
        min-width: 24px;
        text-align: center;
      }

      /* æŒ‡ä»¤åˆ—è¡¨å›¾æ ‡ */
      .instruction-icon {
        font-size: 14px;
        min-width: 24px;
        text-align: center;
      }

      /* ç”¨æˆ·å¡ç‰‡ç‚¹å‡»æç¤º */
      .user-card {
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      }

      .user-card:active {
        transform: translateY(0);
      }

      /* è¾“å…¥æ¡†å…‰æ ‡ä½ç½®æç¤º */
      .message-input {
        caret-color: var(--primary);
      }
      /* ========== CMDç»ˆç«¯æ ·å¼ - åªåœ¨æ¡Œé¢ç«¯æ˜¾ç¤º ========== */
      @media (min-width: 769px) {
        .cmd-terminal {
          background-color: #0a0a0a;
          color: #cccccc;
          font-family: "Consolas", "Monaco", "Courier New", monospace;
          font-size: 13px;
          line-height: 1.5;
          padding: 0;
          border-radius: 6px;
          border: 1px solid #333;
          box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
          position: fixed;
          bottom: 80px;
          right: 20px;
          width: 600px;
          height: 400px;
          z-index: 2000;
          display: none;
          flex-direction: column;
          overflow: hidden;
          resize: both;
          min-width: 400px;
          min-height: 300px;
          user-select: none;
        }

        .cmd-terminal.visible {
          display: flex;
        }

        .terminal-toggle {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: linear-gradient(135deg, #2c3e50, #34495e);
          color: white;
          border: none;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          font-size: 20px;
          cursor: pointer;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
          z-index: 1999;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease;
        }

        .terminal-toggle:hover {
          transform: scale(1.1);
          background: linear-gradient(135deg, #34495e, #2c3e50);
        }

        .terminal-toggle.active {
          background: #e74c3c;
        }

        .cmd-terminal-header {
          background-color: #1a1a1a;
          padding: 8px 12px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid #333;
          cursor: move;
          user-select: none;
        }

        .cmd-terminal-title {
          color: #fff;
          font-weight: bold;
          font-size: 12px;
        }

        .cmd-terminal-controls {
          display: flex;
          gap: 8px;
        }

        .cmd-terminal-btn {
          background: none;
          border: none;
          color: #888;
          cursor: pointer;
          font-size: 14px;
          padding: 0 4px;
        }

        .cmd-terminal-btn:hover {
          color: #fff;
        }

        .cmd-terminal-content {
          flex: 1;
          overflow-y: auto;
          padding: 10px;
          background-color: #0a0a0a;
          scroll-behavior: smooth;
          user-select: text;
        }

        .cmd-line {
          margin: 2px 0;
          white-space: pre-wrap;
          word-wrap: break-word;
          font-family: "Consolas", "Monaco", "Courier New", monospace;
          color: #cccccc;
        }

        .cmd-prompt {
          color: #4ec9b0;
          font-weight: bold;
        }

        .cmd-timestamp {
          color: #808080;
          margin-right: 8px;
        }

        .cmd-input-line {
          display: flex;
          align-items: center;
          padding: 8px 12px;
          background-color: #1a1a1a;
          border-top: 1px solid #333;
        }

        .cmd-input-prompt {
          color: #4ec9b0;
          margin-right: 8px;
          font-weight: bold;
        }

        .cmd-input {
          flex: 1;
          background: none;
          border: none;
          color: #fff;
          font-family: "Consolas", "Monaco", "Courier New", monospace;
          font-size: 13px;
          outline: none;
        }

        .cmd-input::placeholder {
          color: #444;
        }

        /* æ—¥å¿—é¢œè‰² */
        .cmd-log-info {
          color: #cccccc;
        }

        .cmd-log-warning {
          color: #ffd700;
        }

        .cmd-log-error {
          color: #ff6b6b;
        }

        .cmd-log-success {
          color: #6bff6b;
        }

        .cmd-log-admin {
          color: #ff9d4a;
        }

        .cmd-log-game {
          color: #9d6bff;
        }
      }
      /* æ¸¸æˆè®¡æ—¶å™¨ - å›ºå®šä½ç½®ä¸é®æŒ¡èŠå¤© */
      .game-timer-display {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 20px;
        border-radius: 30px;
        font-size: 16px;
        font-weight: bold;
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
      }

      .game-timer-display.visible {
        display: flex;
      }

      .timer-icon {
        color: #f39c12;
        font-size: 18px;
      }

      .timer-text {
        font-family: monospace;
        font-size: 18px;
        letter-spacing: 2px;
      }

      .timer-phase {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        margin-left: 5px;
      }

      /* æ‰‹æœºç«¯é€‚é… */
      @media (max-width: 768px) {
        .game-timer-display {
          top: 5px;
          padding: 5px 15px;
          font-size: 14px;
        }

        .timer-text {
          font-size: 16px;
        }
      }

      /* ç‹¼äººç§èŠæ¶ˆæ¯æ ·å¼ */
      .message.wolf-chat {
        align-self: flex-start;
        border-left: 3px solid #c0392b;
      }

      .message.wolf-chat .message-username {
        color: #c0392b;
      }

      .message.wolf-chat .message-bubble {
        background: rgba(192, 57, 43, 0.1);
        border: 1px solid rgba(192, 57, 43, 0.3);
      }

      .message.own-wolf-chat {
        align-self: flex-end;
      }

      .message.own-wolf-chat .message-bubble {
        background: rgba(192, 57, 43, 0.2);
        border: 1px solid #c0392b;
      }

      .wolf-badge {
        background: #c0392b;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
      }
      /* æ‰‹æœºç«¯éšè—CMDç»ˆç«¯å’Œç›¸å…³æŒ‰é’® */
      @media (max-width: 768px) {
        .cmd-terminal,
        .terminal-toggle,
        .cmd-terminal.visible,
        .terminal-toggle.active,
        #cmdTerminal,
        #terminalToggle {
          display: none !important;
          visibility: hidden !important;
          opacity: 0 !important;
          pointer-events: none !important;
        }

        /* ç¡®ä¿å¿«é€ŸæŒ‡ä»¤æŒ‰é’®åœ¨æ‰‹æœºç«¯æ­£å¸¸æ˜¾ç¤º */
        .quick-commands {
          left: 10px;
          gap: 5px;
        }

        .quick-cmd-btn {
          padding: 6px 10px;
          font-size: 11px;
        }

        .quick-cmd-btn i {
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- ç™»å½•åŒºåŸŸ -->
      <div class="login-container" id="loginContainer">
        <div class="login-box">
          <h3><i class="fas fa-user-plus"></i> åŠ å…¥èŠå¤©</h3>
          <input
            type="text"
            id="username"
            placeholder="è¾“å…¥æ˜µç§°"
            maxlength="20"
            autocomplete="off"
          />
          <button onclick="joinChat()" id="joinBtn">
            <span id="joinText">è¿›å…¥èŠå¤©å®¤</span>
            <span class="spinner" id="joinSpinner" style="display: none"></span>
          </button>
          <div id="loginError"></div>

          <div class="login-tip">
            <p><strong>ğŸ“Œ ç™»å½•æ–¹å¼ï¼š</strong></p>
            <p>â€¢ æ™®é€šç”¨æˆ·ï¼šç›´æ¥è¾“å…¥æ˜µç§°ï¼Œå¦‚ <code>å¼ ä¸‰</code></p>
            <p>â€¢ ç®¡ç†å‘˜ï¼šè¾“å…¥ <code>ç”¨æˆ·å:å¯†ç </code> æ ¼å¼</p>
            <p style="color: #e67e22">
              ğŸ” é»˜è®¤ç®¡ç†å‘˜å¯†ç : <code>admin123</code>
            </p>
            <p style="color: #e67e22">ç¤ºä¾‹: <code>admin:admin123</code></p>
          </div>
        </div>
      </div>

      <!-- ä¸»ç•Œé¢ (ç™»å½•åæ˜¾ç¤º) -->
      <div
        id="mainApp"
        style="display: none; height: 100%; flex-direction: column"
      >
        <!-- å¤´éƒ¨ -->
        <div class="mobile-header">
          <h2>
            <i class="fas fa-comments"></i>
            èŠå¤©å®¤
          </h2>
          <div class="online-badge" id="onlineBadge">
            <i class="fas fa-users"></i> <span id="onlineCount">0</span>
          </div>
        </div>
        <!-- æ¸¸æˆè®¡æ—¶å™¨ -->
        <div class="game-timer-display" id="gameTimerDisplay">
          <i class="fas fa-hourglass-half timer-icon"></i>
          <span class="timer-text" id="timerText">00:00</span>
          <span class="timer-phase" id="timerPhase">ç­‰å¾…</span>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="tab-bar">
          <div class="tab-item active" onclick="switchTab('chat')">
            <i class="fas fa-comment"></i> èŠå¤©
          </div>
          <div class="tab-item" onclick="switchTab('users')">
            <i class="fas fa-users"></i> ç”¨æˆ·
          </div>
          <div class="tab-item" onclick="switchTab('game')">
            <i class="fas fa-gamepad"></i> æ¸¸æˆ
          </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
          <!-- èŠå¤©é¢æ¿ -->
          <div class="tab-panel active" id="chatPanel">
            <div class="chat-panel">
              <div class="messages-container" id="messages">
                <div class="message system">
                  <div class="system-content">
                    <i class="fas fa-info-circle"></i> æ¬¢è¿
                  </div>
                </div>
                <div class="message system">
                  <div class="system-content">
                    <i class="fas fa-terminal"></i> è¾“å…¥
                    <span class="command-highlight">/help</span> æŸ¥çœ‹æ¸¸æˆæŒ‡ä»¤
                  </div>
                </div>
              </div>

              <div
                class="typing-indicator"
                id="typingIndicator"
                style="display: none"
              ></div>

              <!-- è¾“å…¥åŒºåŸŸ -->
              <div class="input-area">
                <!-- å¿«é€ŸæŒ‡ä»¤æŒ‰é’®æ”¾åœ¨è¿™é‡Œ -->
                <div
                  class="quick-commands"
                  id="quickCommands"
                  style="display: none"
                >
                  <button class="quick-cmd-btn" onclick="quickCommand('/join')">
                    <i class="fas fa-plus"></i> /join
                  </button>
                  <button
                    class="quick-cmd-btn"
                    onclick="quickCommand('/players')"
                  >
                    <i class="fas fa-users"></i> /players
                  </button>
                  <button class="quick-cmd-btn" onclick="quickCommand('/help')">
                    <i class="fas fa-question"></i> /help
                  </button>
                </div>

                <div class="message-input-wrapper">
                  <span class="command-prompt" id="commandPrompt">/</span>
                  <textarea
                    id="messageInput"
                    class="message-input"
                    placeholder="è¾“å…¥æ¶ˆæ¯... "
                    rows="1"
                    disabled
                  ></textarea>
                  <!-- æŒ‡ä»¤å»ºè®®æ”¾åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ -->
                  <div
                    class="command-suggestions"
                    id="commandSuggestions"
                  ></div>
                </div>

                <button
                  class="send-btn"
                  onclick="sendMessage()"
                  id="sendButton"
                  disabled
                >
                  <i class="fas fa-paper-plane"></i> å‘é€
                </button>
              </div>
            </div>
          </div>

          <!-- ç”¨æˆ·é¢æ¿ -->
          <div class="tab-panel" id="usersPanel">
            <div class="users-panel">
              <div class="online-stats">
                <h3><i class="fas fa-users"></i> åœ¨çº¿ç©å®¶</h3>
                <div class="online-count">
                  <span id="onlineCountDetail">0</span>
                  <small>äºº</small>
                </div>
              </div>
              <div class="user-grid" id="userList"></div>
            </div>
          </div>

          <!-- æ¸¸æˆé¢æ¿ -->
          <div class="tab-panel" id="gamePanel">
            <div class="game-panel">
              <div class="game-header">
                <h3><i class="fas fa-gamepad"></i> ç‹¼äººæ€</h3>
                <div class="game-phase-info">
                  <span class="game-phase-badge" id="gameStatus">ç­‰å¾…å¼€å§‹</span>
                  <span class="game-timer" id="gameTimer">--:--</span>
                </div>
              </div>

              <div class="game-players">
                <h4>
                  <span>æ¸¸æˆç©å®¶</span>
                  <span class="player-count" id="playerCount">0/8</span>
                </h4>
                <div class="players-grid" id="gamePlayers"></div>
              </div>

              <div class="game-instructions" id="gameInstructions">
                <h5><i class="fas fa-terminal"></i> æ¸¸æˆæŒ‡ä»¤</h5>
                <ul class="instruction-list" id="instructionList">
                  <li onclick="quickCommand('/join')">
                    <span class="instruction-cmd">/join</span>
                    <span class="instruction-desc">åŠ å…¥æ¸¸æˆ</span>
                  </li>
                  <li onclick="quickCommand('/leave')">
                    <span class="instruction-cmd">/leave</span>
                    <span class="instruction-desc">ç¦»å¼€æ¸¸æˆ</span>
                  </li>
                  <li onclick="quickCommand('/start')">
                    <span class="instruction-cmd">/start</span>
                    <span class="instruction-desc">å¼€å§‹æ¸¸æˆï¼ˆæˆ¿ä¸»ï¼‰</span>
                  </li>
                  <li onclick="quickCommand('/players')">
                    <span class="instruction-cmd">/players</span>
                    <span class="instruction-desc">æŸ¥çœ‹å­˜æ´»ç©å®¶</span>
                  </li>
                  <li onclick="quickCommand('/roles')">
                    <span class="instruction-cmd">/roles</span>
                    <span class="instruction-desc">æŸ¥çœ‹å‰©ä½™è§’è‰²</span>
                  </li>
                  <li onclick="quickCommand('/help')">
                    <span class="instruction-cmd">/help</span>
                    <span class="instruction-desc">æŸ¥çœ‹æ‰€æœ‰æŒ‡ä»¤</span>
                  </li>
                  <li onclick="quickCommand('/wolf')">
                    <span class="instruction-cmd">/wolf æ¶ˆæ¯</span>
                    <span class="instruction-desc">ç‹¼äººç§èŠï¼ˆä»…ç‹¼äººå¯è§ï¼‰</span>
                  </li>
                </ul>
              </div>

              <button
                class="game-btn primary"
                id="joinGameBtn"
                onclick="quickCommand('/join')"
                disabled
              >
                <i class="fas fa-plus"></i> åŠ å…¥æ¸¸æˆ (/join)
              </button>
              <button
                class="game-btn secondary"
                id="leaveGameBtn"
                onclick="quickCommand('/leave')"
                style="display: none"
                disabled
              >
                <i class="fas fa-sign-out-alt"></i> ç¦»å¼€æ¸¸æˆ (/leave)
              </button>
              <button
                class="game-btn primary"
                id="startGameBtn"
                onclick="quickCommand('/start')"
                style="display: none"
                disabled
              >
                <i class="fas fa-play"></i> å¼€å§‹æ¸¸æˆ (/start)
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ç®¡ç†å‘˜é¢æ¿ -->
      <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
          <h3><i class="fas fa-shield-alt"></i> ç®¡ç†å‘˜æ§åˆ¶é¢æ¿</h3>
          <button class="admin-close" onclick="hideAdminPanel()">
            &times;
          </button>
        </div>

        <div class="admin-tabs">
          <button class="admin-tab active" onclick="switchAdminTab('users')">
            åœ¨çº¿ç”¨æˆ·
          </button>
          <button class="admin-tab" onclick="switchAdminTab('messages')">
            æ¶ˆæ¯è®°å½•
          </button>
          <button class="admin-tab" onclick="switchAdminTab('bans')">
            å°ç¦åˆ—è¡¨
          </button>
        </div>

        <div class="admin-content" id="adminUsersTab">
          <div class="admin-user-list" id="adminUserList">
            <div style="text-align: center; padding: 20px; color: #999">
              åŠ è½½ä¸­...
            </div>
          </div>
        </div>

        <div class="admin-content" id="adminMessagesTab" style="display: none">
          <div class="admin-message-list" id="adminMessageList">
            <div style="text-align: center; padding: 20px; color: #999">
              åŠ è½½ä¸­...
            </div>
          </div>
        </div>

        <div class="admin-content" id="adminBansTab" style="display: none">
          <div class="admin-ban-list" id="adminBanList">
            <div style="text-align: center; padding: 20px; color: #999">
              åŠ è½½ä¸­...
            </div>
          </div>
        </div>
      </div>

      <!-- è¿æ¥çŠ¶æ€ -->
      <div id="connectionStatus" class="connection-status"></div>
    </div>

    <!-- CMDç»ˆç«¯æŒ‰é’® - åªåœ¨æ¡Œé¢ç«¯æ˜¾ç¤º -->
    <button
      class="terminal-toggle"
      id="terminalToggle"
      onclick="toggleTerminal()"
    >
      <i class="fas fa-terminal"></i>
    </button>

    <!-- CMDç»ˆç«¯ - åªåœ¨æ¡Œé¢ç«¯æ˜¾ç¤º -->
    <div class="cmd-terminal" id="cmdTerminal">
      <div class="cmd-terminal-header" id="terminalHeader">
        <span class="cmd-terminal-title">ADMIN@SERVER:~$ console</span>
        <div class="cmd-terminal-controls">
          <button class="cmd-terminal-btn" onclick="clearTerminal()">
            <i class="fas fa-trash"></i>
          </button>
          <button class="cmd-terminal-btn" onclick="toggleTerminal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="cmd-terminal-content" id="terminalContent">
        <div class="cmd-line">
          <span class="cmd-prompt">ADMIN@SERVER:~$</span>
          <span class="cmd-log-success">System initialized</span>
        </div>
        <div class="cmd-line">
          <span class="cmd-prompt">ADMIN@SERVER:~$</span>
          <span>Type 'help' for available commands</span>
        </div>
      </div>
      <div class="cmd-input-line">
        <span class="cmd-input-prompt">ADMIN@SERVER:~$</span>
        <input
          type="text"
          class="cmd-input"
          id="cmdInput"
          placeholder="Enter command..."
          disabled
        />
      </div>
    </div>

    <script>
      // ========== é…ç½® ==========
      const CONFIG = {
        maxReconnectAttempts: 5,
        reconnectDelay: 3000,
        typingTimeout: 1000,
        maxMessageLength: 500,
        maxUsernameLength: 20,
      };

      // æ¸¸æˆæŒ‡ä»¤åˆ—è¡¨
      const GAME_COMMANDS = {
        join: "åŠ å…¥æ¸¸æˆ",
        leave: "ç¦»å¼€æ¸¸æˆ",
        start: "å¼€å§‹æ¸¸æˆï¼ˆæˆ¿ä¸»ï¼‰",
        wolf: "[æ¶ˆæ¯] ç‹¼äººç§èŠ",
        kill: "[@ç”¨æˆ·å] ç‹¼äººæ€äºº",
        check: "[@ç”¨æˆ·å] é¢„è¨€å®¶æŸ¥éªŒ",
        save: "[@ç”¨æˆ·å] å¥³å·«æ•‘äºº",
        poison: "[@ç”¨æˆ·å] å¥³å·«æ¯’äºº",
        skip: "å¥³å·«è·³è¿‡",
        shoot: "[@ç”¨æˆ·å] çŒäººå¼€æª",
        vote: "[@ç”¨æˆ·å] æŠ•ç¥¨æ”¾é€",
        players: "æŸ¥çœ‹å­˜æ´»ç©å®¶",
        roles: "æŸ¥çœ‹å‰©ä½™è§’è‰²",
        help: "æŸ¥çœ‹å¸®åŠ©",
      };

      // ç®¡ç†å‘˜å‘½ä»¤åˆ—è¡¨
      const ADMIN_COMMANDS = {
        help: "æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯",
        users: "åˆ—å‡ºæ‰€æœ‰åœ¨çº¿ç”¨æˆ·",
        "userinfo <ç”¨æˆ·å>": "æŸ¥çœ‹ç”¨æˆ·è¯¦ç»†ä¿¡æ¯",
        "mute <ç”¨æˆ·å> [åŸå› ]": "ç¦è¨€ç”¨æˆ·",
        "unmute <ç”¨æˆ·å>": "å–æ¶ˆç”¨æˆ·ç¦è¨€",
        "kick <ç”¨æˆ·å> [åŸå› ]": "è¸¢å‡ºç”¨æˆ·",
        "ban <ç”¨æˆ·å/IP> [åŸå› ]": "å°ç¦ç”¨æˆ·æˆ–IP",
        "unban <IP>": "è§£å°IP",
        "recall <æ¶ˆæ¯ID> [åŸå› ]": "æ’¤å›æ¶ˆæ¯",
        "logs [æ•°é‡]": "æŸ¥çœ‹æœ€è¿‘æ—¥å¿—",
        "search <ç”¨æˆ·å/IP>": "æœç´¢ç”¨æˆ·",
        clear: "æ¸…å±",
        stats: "æŸ¥çœ‹æœåŠ¡å™¨ç»Ÿè®¡",
      };

      // ========== å…¨å±€å˜é‡ ==========
      let ws = null;
      let currentUsername = null;
      let currentUserId = null;
      let currentUserIsAdmin = false;
      let reconnectAttempts = 0;
      let typingTimeout = null;
      let isConnected = false;
      let isJoining = false;
      let heartbeatInterval = null;
      // æ¸¸æˆè®¡æ—¶å™¨å˜é‡
      let gameTimerInterval = null;
      // æ¸¸æˆçŠ¶æ€
      let gameState = {
        isPlaying: false,
        players: [],
        hostId: null,
        playerCount: 0,
        gamePhase: "waiting",
        dayCount: 1,
        myRole: null,
        phaseEndTime: null,
      };

      // ç®¡ç†å‘˜ç›¸å…³å˜é‡
      let adminUsers = [];
      let adminMessages = [];
      let bannedIPs = [];

      // å¸¸ç”¨è¡¨æƒ…
      const emojis = ["ğŸ˜Š", "ğŸ˜‚", "â¤ï¸", "ğŸ‘", "ğŸ‰", "âœ¨", "ğŸ”¥", "ğŸ’¯"];

      // CMDç»ˆç«¯å˜é‡
      let terminalVisible = false;
      let terminalLogs = [];
      let cmdHistory = [];
      let cmdHistoryIndex = -1;
      let isDragging = false;
      let dragOffsetX, dragOffsetY;

      // æŒ‡ä»¤å»ºè®®ç›¸å…³
      let commandSuggestions = [];
      let selectedSuggestionIndex = -1;

      // ========== WebSocketè¿æ¥ ==========
      function connect() {
        if (ws && ws.readyState === WebSocket.OPEN) return;

        updateConnectionStatus("connecting");

        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        ws = new WebSocket(`${protocol}//${host}`);

        ws.onopen = function () {
          console.log("âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨");
          isConnected = true;
          reconnectAttempts = 0;
          updateConnectionStatus("connected");

          startHeartbeat();
        };

        ws.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            console.log("æ”¶åˆ°æ¶ˆæ¯:", data);
            handleMessage(data);
          } catch (err) {
            console.error("æ¶ˆæ¯è§£æå¤±è´¥:", err);
          }
        };

        ws.onclose = function () {
          console.log("âŒ è¿æ¥æ–­å¼€");
          isConnected = false;
          updateConnectionStatus("disconnected");

          enableControls(false);

          if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
          }

          if (reconnectAttempts < CONFIG.maxReconnectAttempts) {
            reconnectAttempts++;
            setTimeout(connect, CONFIG.reconnectDelay);
          }
        };

        ws.onerror = function (error) {
          console.error("WebSocketé”™è¯¯:", error);
          updateConnectionStatus("disconnected");
        };
      }

      // å¿ƒè·³
      function startHeartbeat() {
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        heartbeatInterval = setInterval(() => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "ping" }));
          }
        }, 30000);
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€
      function updateConnectionStatus(status) {
        const statusEl = document.getElementById("connectionStatus");
        if (!statusEl) return;

        statusEl.style.display = "block";
        statusEl.className = "connection-status";

        let text = "";
        switch (status) {
          case "connected":
            statusEl.classList.add("status-connected");
            text = "ğŸŸ¢ å·²è¿æ¥";
            break;
          case "connecting":
            statusEl.classList.add("status-connecting");
            text = "ğŸŸ¡ è¿æ¥ä¸­...";
            break;
          case "disconnected":
            statusEl.classList.add("status-disconnected");
            text = "ğŸ”´ å·²æ–­å¼€";
            break;
        }
        statusEl.textContent = text;
      }

      // å¯ç”¨/ç¦ç”¨æ§ä»¶
      function enableControls(enabled) {
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const joinGameBtn = document.getElementById("joinGameBtn");
        const leaveGameBtn = document.getElementById("leaveGameBtn");
        const startGameBtn = document.getElementById("startGameBtn");
        const quickCommands = document.getElementById("quickCommands");

        if (messageInput) messageInput.disabled = !enabled;
        if (sendButton) sendButton.disabled = !enabled;

        if (enabled) {
          setupCommandInput();
          if (quickCommands) quickCommands.style.display = "flex";
        }
      }

      // ========== ç™»å½•åŠŸèƒ½ ==========
      function joinChat() {
        if (isJoining) return;

        const usernameInput = document.getElementById("username");
        const joinBtn = document.getElementById("joinBtn");
        const joinText = document.getElementById("joinText");
        const joinSpinner = document.getElementById("joinSpinner");

        const username = usernameInput.value.trim();

        if (!username) {
          showError("è¯·è¾“å…¥æ˜µç§°");
          return;
        }

        if (username.length < 2) {
          showError("æ˜µç§°è‡³å°‘2ä¸ªå­—ç¬¦");
          return;
        }

        if (username.length > CONFIG.maxUsernameLength) {
          showError(`æ˜µç§°ä¸èƒ½è¶…è¿‡${CONFIG.maxUsernameLength}ä¸ªå­—ç¬¦`);
          return;
        }

        if (!isConnected) {
          showError("æ­£åœ¨è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¨å€™...");
          return;
        }

        isJoining = true;
        currentUsername = username;

        joinBtn.disabled = true;
        joinText.style.display = "none";
        joinSpinner.style.display = "inline-block";

        ws.send(
          JSON.stringify({
            type: "join",
            username: username,
          }),
        );
      }

      // ========== æ¶ˆæ¯å¤„ç† ==========
      function handleMessage(data) {
        console.log("å¤„ç†æ¶ˆæ¯:", data);

        switch (data.type) {
          case "welcome":
            currentUserId = data.userId;
            currentUserIsAdmin = data.isAdmin || false;

            console.log("å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜:", currentUserIsAdmin);

            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("mainApp").style.display = "flex";

            enableControls(true);

            addSystemMessage(`æ¬¢è¿ ${data.username} åŠ å…¥èŠå¤©å®¤ï¼`);

            if (currentUserIsAdmin) {
              console.log("ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼Œæ˜¾ç¤ºé¢æ¿");
              showAdminPanel();
              ws.send(JSON.stringify({ type: "adminGetUsers" }));
              ws.send(JSON.stringify({ type: "adminGetHistory" }));
              ws.send(JSON.stringify({ type: "adminGetBanned" }));

              // åªåœ¨æ¡Œé¢ç«¯åˆå§‹åŒ–ç»ˆç«¯
              if (window.innerWidth > 768) {
                initTerminal();
                addTerminalLog(`ç®¡ç†å‘˜ ${data.username} ç™»å½•æˆåŠŸ`, "success");
                addTerminalLog(`IP: ${data.ip || "Unknown"}`, "info");
              }
            }

            setTimeout(() => {
              ws.send(JSON.stringify({ type: "getGameState" }));
            }, 500);
            break;
          // åœ¨ handleMessage å‡½æ•°ä¸­æ·»åŠ  phaseTimer å¤„ç†
          case "phaseTimer":
            updateGameTimerDisplay(data.remaining, data.phase);
            break;
          // æ·»åŠ ç‹¼äººç§èŠæ¶ˆæ¯å¤„ç†
          case "wolfChat":
            addWolfChatMessage(data);
            break;
          case "chat":
            addMessage(data);
            if (currentUserIsAdmin && window.innerWidth > 768) {
              addTerminalLog(
                `[CHAT] ${data.username}: ${data.content}`,
                "info",
              );
            }
            break;

          case "system":
            addSystemMessage(data.content);
            if (currentUserIsAdmin && window.innerWidth > 768) {
              addTerminalLog(`[SYSTEM] ${data.content}`, "game");
            }
            break;

          case "private":
            addPrivateMessage(data.content);
            break;

          case "users":
            updateUserList(data.users);
            updateOnlineCount(data.users.length);
            if (currentUserIsAdmin && window.innerWidth > 768) {
              addTerminalLog(
                `[INFO] åœ¨çº¿ç”¨æˆ·æ›´æ–°: ${data.users.length} äººåœ¨çº¿`,
                "info",
              );
            }
            break;

          case "gameState":
            console.log("æ›´æ–°æ¸¸æˆçŠ¶æ€:", data);
            updateGameState(data);
            break;

          case "gameEvent":
            addSystemMessage(`ğŸ® ${data.content}`);
            if (currentUserIsAdmin && window.innerWidth > 768) {
              addTerminalLog(`[GAME] ${data.content}`, "game");
            }
            break;

          case "phaseTimer":
            updateGameTimer(data.remaining);
            break;

          case "yourRole":
            gameState.myRole = data.role;
            addPrivateMessage(
              `ğŸ­ ä½ çš„è§’è‰²æ˜¯ï¼š${data.role} - ${data.description}`,
            );
            updateGameInstructions(data.role);
            break;

          case "seerResult":
            addPrivateMessage(
              `ğŸ”® æŸ¥éªŒç»“æœï¼š${data.target} ${data.isWerewolf ? "æ˜¯ç‹¼äºº" : "ä¸æ˜¯ç‹¼äºº"}`,
            );
            break;

          case "actionConfirm":
            addSystemMessage(`âœ… ${data.content}`);
            break;

          case "gameEnd":
            addSystemMessage(`=== æ¸¸æˆç»“æŸï¼Œ${data.winner}è·èƒœ ===`);
            if (data.players) {
              data.players.forEach((p) => {
                addSystemMessage(
                  `${p.username} æ˜¯ ${p.role} ${p.isAlive ? "ğŸ˜Šå­˜æ´»" : "ğŸ’€æ­»äº¡"}`,
                );
              });
            }
            ws.send(JSON.stringify({ type: "getGameState" }));
            break;

          case "messageRecalled":
            handleMessageRecalled(data);
            if (currentUserIsAdmin && window.innerWidth > 768) {
              addTerminalLog(`[ADMIN] æ¶ˆæ¯å·²æ’¤å›: ${data.messageId}`, "admin");
            }
            break;

          case "error":
            showError(data.content);
            if (currentUserIsAdmin && window.innerWidth > 768) {
              addTerminalLog(`[ERROR] ${data.content}`, "error");
            }
            break;

          case "adminUsers":
            console.log("æ”¶åˆ°ç®¡ç†å‘˜ç”¨æˆ·åˆ—è¡¨:", data.users);
            if (currentUserIsAdmin) {
              adminUsers = data.users;
              updateAdminUsers(data.users);
              if (window.innerWidth > 768) {
                addTerminalLog(
                  `[ADMIN] è·å–åˆ° ${data.users.length} ä¸ªåœ¨çº¿ç”¨æˆ·`,
                  "success",
                );
              }
            }
            break;

          case "adminHistory":
            console.log("æ”¶åˆ°ç®¡ç†å‘˜æ¶ˆæ¯å†å²:", data.messages);
            if (currentUserIsAdmin) {
              adminMessages = data.messages;
              updateAdminMessages(data.messages);
              if (window.innerWidth > 768) {
                addTerminalLog(
                  `[ADMIN] è·å–åˆ° ${data.messages.length} æ¡æ¶ˆæ¯å†å²`,
                  "success",
                );
              }
            }
            break;

          case "bannedIPs":
            console.log("æ”¶åˆ°å°ç¦IPåˆ—è¡¨:", data.ips);
            if (currentUserIsAdmin) {
              bannedIPs = data.ips || [];
              updateBannedIPs(bannedIPs);
              if (window.innerWidth > 768) {
                addTerminalLog(
                  `[ADMIN] å½“å‰æœ‰ ${bannedIPs.length} ä¸ªIPè¢«å°ç¦`,
                  "info",
                );
              }
            }
            break;

          case "systemLogs":
            if (currentUserIsAdmin && window.innerWidth > 768) {
              addTerminalLog("=== ç³»ç»Ÿæ—¥å¿— ===", "info");
              data.logs.forEach((log) => {
                addTerminalLog(log, "info");
              });
            }
            break;

          case "adminSuccess":
            if (currentUserIsAdmin) {
              if (window.innerWidth > 768) {
                addTerminalLog(`[SUCCESS] ${data.content}`, "success");
              }
              showAdminNotification(data.content);
            }
            break;

          case "adminError":
            if (currentUserIsAdmin) {
              if (window.innerWidth > 768) {
                addTerminalLog(`[ERROR] ${data.content}`, "error");
              }
              alert(`ç®¡ç†å‘˜æ“ä½œå¤±è´¥: ${data.content}`);
            }
            break;

          case "pong":
            break;
        }
      }

      // ========== èŠå¤©åŠŸèƒ½ ==========
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const content = input.value.trim();

        if (!content || !isConnected) return;

        if (content.length > CONFIG.maxMessageLength) {
          showError(`æ¶ˆæ¯ä¸èƒ½è¶…è¿‡${CONFIG.maxMessageLength}ä¸ªå­—ç¬¦`);
          return;
        }

        ws.send(
          JSON.stringify({
            type: "message",
            content: content,
          }),
        );

        input.value = "";
        input.style.height = "auto";
        hideCommandSuggestions();
      }

      function addMessage(message) {
        const messagesDiv = document.getElementById("messages");
        const isOwnMessage = message.userId === currentUserId;

        const messageDiv = document.createElement("div");
        messageDiv.className = `message chat ${isOwnMessage ? "own-message" : ""}`;
        messageDiv.dataset.messageId = message.id;

        // é«˜äº®æ˜¾ç¤ºæŒ‡ä»¤
        let content = escapeHtml(message.content);
        if (content.startsWith("/")) {
          content = `<span class="command-highlight">${content}</span>`;
        }

        messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-username" style="color: ${message.color || "#4a90e2"}">
                        ${escapeHtml(message.username)}
                    </span>
                    <span class="message-time">${message.timestamp || new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-bubble">${content}</div>
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addSystemMessage(content) {
        const messagesDiv = document.getElementById("messages");

        const messageDiv = document.createElement("div");
        messageDiv.className = "message system";
        messageDiv.innerHTML = `<div class="system-content">${content}</div>`;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
      // æ·»åŠ ç‹¼äººç§èŠæ¶ˆæ¯
      function addWolfChatMessage(data) {
        const messagesDiv = document.getElementById("messages");
        const isOwnMessage = data.isOwn || false;

        const messageDiv = document.createElement("div");
        messageDiv.className = `message wolf-chat ${isOwnMessage ? "own-wolf-chat" : ""}`;

        const badge = '<span class="wolf-badge">ğŸº ç‹¼äººç§èŠ</span>';

        messageDiv.innerHTML = `
        <div class="message-header">
            <span class="message-username" style="color: #c0392b">
                ${escapeHtml(data.username)}
            </span>
            ${badge}
            <span class="message-time">${data.timestamp || new Date().toLocaleTimeString()}</span>
        </div>
        <div class="message-bubble">${escapeHtml(data.content)}</div>
    `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
      function addPrivateMessage(content) {
        const messagesDiv = document.getElementById("messages");

        const messageDiv = document.createElement("div");
        messageDiv.className = "message private";
        messageDiv.innerHTML = `<div class="private-content">ğŸ”’ ${content}</div>`;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function handleMessageRecalled(data) {
        const messagesDiv = document.getElementById("messages");
        const messages = messagesDiv.children;

        for (let i = 0; i < messages.length; i++) {
          const msg = messages[i];
          if (msg.dataset.messageId === data.messageId) {
            if (msg.classList.contains("own-message")) {
              msg.querySelector(".message-bubble").innerHTML =
                "âš ï¸ ä½ çš„æ¶ˆæ¯å·²è¢«ç®¡ç†å‘˜æ’¤å›";
            } else {
              msg.querySelector(".message-bubble").innerHTML =
                "âš ï¸ è¯¥æ¶ˆæ¯å·²è¢«ç®¡ç†å‘˜æ’¤å›";
            }
            msg.querySelector(".message-bubble").style.backgroundColor =
              "#f0f0f0";
            msg.querySelector(".message-bubble").style.color = "#999";
            break;
          }
        }

        addSystemMessage(data.content);
      }
      // æ£€æŸ¥å½“å‰è¾“å…¥æ˜¯å¦å¤„äºæŒ‡ä»¤æ¨¡å¼
      function isInCommandMode() {
        const input = document.getElementById("messageInput");
        const value = input.value;
        const cursorPos = input.selectionStart;

        // æ£€æŸ¥å…‰æ ‡å‰æœ€è¿‘çš„å­—ç¬¦ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨æŒ‡ä»¤ä¸­
        const textBeforeCursor = value.substring(0, cursorPos);
        const lastSlashIndex = textBeforeCursor.lastIndexOf("/");

        if (lastSlashIndex === -1) return false;

        // æ£€æŸ¥æ–œæ åæ˜¯å¦æœ‰ç©ºæ ¼
        const afterSlash = textBeforeCursor.substring(lastSlashIndex + 1);
        return !afterSlash.includes(" ");
      }

      // ========== æŒ‡ä»¤è¾“å…¥åŠŸèƒ½ ==========
      function setupCommandInput() {
        const input = document.getElementById("messageInput");

        input.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = this.scrollHeight + "px";

          const value = this.value;
          const prompt = document.getElementById("commandPrompt");

          if (value.startsWith("/")) {
            prompt.classList.add("visible");
            this.classList.add("command-input");
            showCommandSuggestions(value);
          } else {
            prompt.classList.remove("visible");
            this.classList.remove("command-input");
            hideCommandSuggestions();
          }

          if (!currentUserId || !isConnected) return;

          clearTimeout(typingTimeout);

          ws.send(
            JSON.stringify({
              type: "typing",
              isTyping: true,
            }),
          );

          typingTimeout = setTimeout(() => {
            ws.send(
              JSON.stringify({
                type: "typing",
                isTyping: false,
              }),
            );
          }, CONFIG.typingTimeout);
        });
      }

      function showCommandSuggestions(input) {
    const fullInput = input; // å®Œæ•´çš„è¾“å…¥å†…å®¹ï¼Œå¦‚ "/k"
    const cmd = fullInput.slice(1).toLowerCase(); // å»æ‰æ–œæ ï¼Œå¾—åˆ° "k"
    const suggestions = document.getElementById('commandSuggestions');
    const inputWrapper = document.querySelector('.message-input-wrapper');
    
    // è·å–å½“å‰å¯ç”¨çš„æŒ‡ä»¤åˆ—è¡¨
    let availableCommands = { ...GAME_COMMANDS };
    
    // æ ¹æ®æ¸¸æˆçŠ¶æ€å’Œç©å®¶è§’è‰²è¿‡æ»¤æŒ‡ä»¤
    if (gameState.isPlaying && gameState.myRole) {
        // åªæœ‰ç‹¼äººå¯ä»¥çœ‹åˆ° /wolf æŒ‡ä»¤
        if (gameState.myRole !== 'ç‹¼äºº') {
            delete availableCommands['wolf'];
        }
        
        // æ ¹æ®æ¸¸æˆé˜¶æ®µè¿‡æ»¤æŒ‡ä»¤
        if (gameState.gamePhase !== 'night') {
            delete availableCommands['kill'];
            delete availableCommands['check'];
            delete availableCommands['save'];
            delete availableCommands['poison'];
            delete availableCommands['skip'];
        }
        
        if (gameState.gamePhase !== 'vote') {
            delete availableCommands['vote'];
        }
        
        // åªæœ‰æ­»äº¡çš„çŒäººå¯ä»¥çœ‹åˆ° /shoot
        const hunter = gameState.players.find(p => p.userId === currentUserId);
        if (hunter && hunter.role === 'çŒäºº' && hunter.isAlive) {
            delete availableCommands['shoot'];
        }
    }
    
    if (!cmd) {
        commandSuggestions = Object.entries(availableCommands).map(([cmd, desc]) => ({ cmd, desc }));
    } else {
        commandSuggestions = Object.entries(availableCommands)
            .filter(([c, desc]) => c.startsWith(cmd) || desc.includes(cmd))
            .map(([cmd, desc]) => ({ cmd, desc }));
    }
    
    if (commandSuggestions.length > 0) {
        suggestions.innerHTML = commandSuggestions.map((s, index) => {
            // ä¸ºä¸åŒæŒ‡ä»¤æ·»åŠ ä¸åŒå›¾æ ‡
            let icon = '';
            switch(s.cmd) {
                case 'wolf': icon = 'ğŸº'; break;
                case 'kill': icon = 'ğŸ”ª'; break;
                case 'check': icon = 'ğŸ”®'; break;
                case 'save': icon = 'ğŸ’Š'; break;
                case 'poison': icon = 'â˜ ï¸'; break;
                case 'skip': icon = 'â­ï¸'; break;
                case 'shoot': icon = 'ğŸ¹'; break;
                case 'vote': icon = 'ğŸ—³ï¸'; break;
                case 'join': icon = 'â•'; break;
                case 'leave': icon = 'â–'; break;
                case 'start': icon = 'â–¶ï¸'; break;
                case 'players': icon = 'ğŸ‘¥'; break;
                case 'roles': icon = 'ğŸ“Š'; break;
                case 'help': icon = 'â“'; break;
                default: icon = 'ğŸ“';
            }
            
            return `
                <div class="suggestion-item ${index === 0 ? 'selected' : ''}" 
                     onclick="insertCommand('${s.cmd}', '${fullInput}')">  <!-- ä¼ å…¥å®Œæ•´è¾“å…¥ -->
                    <span class="suggestion-icon">${icon}</span>
                    <span class="suggestion-cmd">/${s.cmd}</span>
                    <span class="suggestion-desc">${s.desc}</span>
                </div>
            `;
        }).join('');
        
        suggestions.classList.add('visible');
        
        // è°ƒæ•´è¾“å…¥æ¡†ä½ç½®ï¼Œä¸ºå»ºè®®åˆ—è¡¨è…¾å‡ºç©ºé—´
        if (inputWrapper) {
            inputWrapper.style.marginBottom = (suggestions.offsetHeight + 5) + 'px';
        }
        
        selectedSuggestionIndex = 0;
    } else {
        hideCommandSuggestions();
    }
}

      function hideCommandSuggestions() {
        const suggestions = document.getElementById("commandSuggestions");
        const inputWrapper = document.querySelector(".message-input-wrapper");

        if (suggestions) {
          suggestions.classList.remove("visible");
        }
        if (inputWrapper) {
          inputWrapper.style.marginBottom = "0";
        }
        selectedSuggestionIndex = -1;
      }

      function navigateSuggestions(direction) {
        const items = document.querySelectorAll(".suggestion-item");
        if (items.length === 0) return;

        items.forEach((item) => item.classList.remove("selected"));

        if (direction === "up") {
          selectedSuggestionIndex =
            (selectedSuggestionIndex - 1 + items.length) % items.length;
        } else {
          selectedSuggestionIndex =
            (selectedSuggestionIndex + 1) % items.length;
        }

        items[selectedSuggestionIndex].classList.add("selected");
      }
      function insertCommand(cmd, currentInput) {
    const input = document.getElementById('messageInput');
    
    // æ‰¾åˆ°å½“å‰è¾“å…¥ä¸­æœ€åä¸€ä¸ªæ–œæ çš„ä½ç½®
    const lastSlashIndex = currentInput.lastIndexOf('/');
    
    // æ„å»ºæ–°çš„å‘½ä»¤
    let newText = '';
    let cursorOffset = 0;
    
    // åˆ¤æ–­æŒ‡ä»¤æ˜¯å¦éœ€è¦å‚æ•°
    const needsParam = ['kill', 'check', 'save', 'poison', 'shoot', 'vote', 'wolf'].includes(cmd);
    
    if (lastSlashIndex >= 0) {
        // æœ‰æ–œæ ï¼Œæ›¿æ¢æ–œæ åçš„å†…å®¹
        const beforeSlash = currentInput.substring(0, lastSlashIndex + 1); // åŒ…æ‹¬æ–œæ 
        const afterSlash = currentInput.substring(lastSlashIndex + 1);
        
        if (needsParam) {
            if (cmd === 'wolf') {
                newText = beforeSlash + cmd + ' '; // /wolf + ç©ºæ ¼
                cursorOffset = beforeSlash.length + cmd.length + 1;
            } else {
                newText = beforeSlash + cmd + ' @'; // /kill + ç©ºæ ¼ + @
                cursorOffset = beforeSlash.length + cmd.length + 2;
            }
        } else {
            newText = beforeSlash + cmd + ' '; // /cmd + ç©ºæ ¼
            cursorOffset = beforeSlash.length + cmd.length + 1;
        }
    } else {
        // æ²¡æœ‰æ–œæ ï¼Œæ·»åŠ å®Œæ•´çš„å‘½ä»¤
        if (needsParam) {
            if (cmd === 'wolf') {
                newText = '/' + cmd + ' '; // /wolf + ç©ºæ ¼
                cursorOffset = newText.length;
            } else {
                newText = '/' + cmd + ' @'; // /kill + ç©ºæ ¼ + @
                cursorOffset = newText.length;
            }
        } else {
            newText = '/' + cmd + ' '; // /cmd + ç©ºæ ¼
            cursorOffset = newText.length;
        }
    }
    
    // æ›´æ–°è¾“å…¥æ¡†
    input.value = newText;
    input.setSelectionRange(cursorOffset, cursorOffset);
    input.focus();
    hideCommandSuggestions();
    
    // è§¦å‘è¾“å…¥äº‹ä»¶
    input.dispatchEvent(new Event('input'));
}

function completeCommand() {
    if (commandSuggestions.length > 0) {
        const selected = document.querySelector('.suggestion-item.selected');
        if (selected) {
            // è·å–é€‰ä¸­çš„æŒ‡ä»¤å’Œå½“å‰è¾“å…¥
            const cmd = selected.querySelector('.suggestion-cmd').textContent.replace('/', '');
            const input = document.getElementById('messageInput');
            const currentInput = input.value;
            insertCommand(cmd, currentInput);
        } else if (commandSuggestions[0]) {
            const input = document.getElementById('messageInput');
            const currentInput = input.value;
            insertCommand(commandSuggestions[0].cmd, currentInput);
        }
    }
}
      function quickCommand(cmd) {
    const input = document.getElementById('messageInput');
    if (!input || input.disabled) return;
    
    const currentText = input.value;
    
    // ç§»é™¤å¯èƒ½å·²ç»å­˜åœ¨çš„æ–œæ 
    const cleanCmd = cmd.replace(/^\//, '');
    
    // åˆ¤æ–­æŒ‡ä»¤æ˜¯å¦éœ€è¦å‚æ•°
    const needsParam = ['kill', 'check', 'save', 'poison', 'shoot', 'vote', 'wolf'].includes(cleanCmd);
    
    // æ„å»ºæ–°çš„å‘½ä»¤
    let newText = '';
    let cursorOffset = 0;
    
    if (needsParam) {
        if (cleanCmd === 'wolf') {
            newText = '/' + cleanCmd + ' '; // /wolf + ç©ºæ ¼
            cursorOffset = newText.length;
        } else {
            newText = '/' + cleanCmd + ' @'; // /kill + ç©ºæ ¼ + @
            cursorOffset = newText.length;
        }
    } else {
        newText = '/' + cleanCmd + ' '; // /cmd + ç©ºæ ¼
        cursorOffset = newText.length;
    }
    
    // æ›¿æ¢æ•´ä¸ªè¾“å…¥æ¡†å†…å®¹
    input.value = newText;
    input.setSelectionRange(cursorOffset, cursorOffset);
    
    input.focus();
    input.style.height = 'auto';
    input.style.height = (input.scrollHeight) + 'px';
    
    // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥æ˜¾ç¤ºæŒ‡ä»¤å»ºè®®
    input.dispatchEvent(new Event('input'));
}
      // ========== ç”¨æˆ·åˆ—è¡¨ ==========
      // åœ¨ updateUserList å‡½æ•°ä¸­ï¼Œä¿®æ”¹ç”¨æˆ·å¡ç‰‡çš„ onclick
      function updateUserList(users) {
        const userList = document.getElementById("userList");
        if (!userList) return;

        if (!users || users.length === 0) {
          userList.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
          return;
        }

        userList.innerHTML = users
          .map((user) => {
            const avatar = user.username.charAt(0).toUpperCase();
            const isCurrentUser = user.username === currentUsername;
            const inGame = gameState.players?.some(
              (p) => p.username === user.username,
            );
            const isDead =
              inGame &&
              gameState.players?.find((p) => p.username === user.username)
                ?.isAlive === false;

            let userClass = "user-card";
            if (inGame) userClass += " in-game";
            if (isDead) userClass += " dead";

            return `
            <div class="${userClass}" onclick="mentionUser('${user.username}')">
                <div class="user-avatar" style="background: ${user.color || "#4a90e2"}">
                    ${avatar}
                </div>
                <div class="user-info">
                    <div class="user-name">
                        ${escapeHtml(user.username)}
                        ${isCurrentUser ? " (ä½ )" : ""}
                        ${user.isAdmin ? " ğŸ‘‘" : ""}
                        ${isDead ? " ğŸ’€" : ""}
                    </div>
                    <div class="user-status">
                        ${inGame ? '<span style="color: var(--success)">æ¸¸æˆä¸­</span>' : ""}
                    </div>
                </div>
            </div>
        `;
          })
          .join("");
      }
      // æ–°å¢ï¼š@ç”¨æˆ·å‡½æ•° - è¿½åŠ å†…å®¹è€Œä¸æ˜¯æ›¿æ¢
      function mentionUser(username) {
        const input = document.getElementById("messageInput");
        if (!input || input.disabled) return;

        const currentText = input.value;
        const cursorPos = input.selectionStart;

        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ @ç”¨æˆ·å
        const beforeText = currentText.substring(0, cursorPos);
        const afterText = currentText.substring(cursorPos);

        // å¦‚æœå…‰æ ‡å‰ä¸æ˜¯ç©ºæ ¼ä¸”ä¸æ˜¯å¼€å¤´ï¼Œæ·»åŠ ä¸€ä¸ªç©ºæ ¼
        const needsSpace =
          beforeText.length > 0 &&
          !beforeText.endsWith(" ") &&
          !beforeText.endsWith("@");
        const mention = (needsSpace ? " " : "") + "@" + username + " ";

        input.value = beforeText + mention + afterText;

        // å°†å…‰æ ‡ç§»åŠ¨åˆ°æ’å…¥å†…å®¹ä¹‹å
        const newCursorPos = cursorPos + mention.length;
        input.setSelectionRange(newCursorPos, newCursorPos);

        input.focus();
        input.style.height = "auto";
        input.style.height = input.scrollHeight + "px";

        // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥æ˜¾ç¤ºæŒ‡ä»¤å»ºè®®
        input.dispatchEvent(new Event("input"));
      }

      function updateOnlineCount(count) {
        const onlineCount = document.getElementById("onlineCount");
        const onlineCountDetail = document.getElementById("onlineCountDetail");
        if (onlineCount) onlineCount.textContent = count;
        if (onlineCountDetail) onlineCountDetail.textContent = count;
      }

      // ========== æ¸¸æˆåŠŸèƒ½ ==========
      // æ›´æ–°æ¸¸æˆè®¡æ—¶å™¨æ˜¾ç¤º
      function updateGameTimerDisplay(remaining, phase) {
        const timerDisplay = document.getElementById("gameTimerDisplay");
        const timerText = document.getElementById("timerText");
        const timerPhase = document.getElementById("timerPhase");

        if (!timerDisplay || !timerText || !timerPhase) return;

        if (remaining > 0 && gameState.isPlaying) {
          timerDisplay.classList.add("visible");

          const minutes = Math.floor(remaining / 60);
          const seconds = remaining % 60;
          timerText.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

          let phaseText = "";
          switch (phase) {
            case "night":
              phaseText = "å¤œæ™š";
              break;
            case "day":
              phaseText = "ç™½å¤©";
              break;
            case "vote":
              phaseText = "æŠ•ç¥¨";
              break;
            default:
              phaseText = "ç­‰å¾…";
          }
          timerPhase.textContent = phaseText;

          // æ ¹æ®å‰©ä½™æ—¶é—´æ”¹å˜é¢œè‰²
          if (remaining <= 10) {
            timerText.style.color = "#e74c3c";
          } else if (remaining <= 30) {
            timerText.style.color = "#f39c12";
          } else {
            timerText.style.color = "white";
          }
        } else {
          timerDisplay.classList.remove("visible");
        }
      }

      function updateGameState(state) {
        gameState = {
          ...gameState,
          isPlaying: state.isPlaying,
          players: state.players || [],
          hostId: state.hostId,
          playerCount:
            state.playerCount || (state.players ? state.players.length : 0),
          gamePhase: state.gamePhase || "waiting",
          dayCount: state.dayCount || 1,
          phaseEndTime: state.phaseEndTime,
        };

        console.log("æ›´æ–°åçš„æ¸¸æˆçŠ¶æ€:", gameState);

        const gamePlayers = document.getElementById("gamePlayers");
        const playerCount = document.getElementById("playerCount");
        const gameStatus = document.getElementById("gameStatus");
        const joinGameBtn = document.getElementById("joinGameBtn");
        const leaveGameBtn = document.getElementById("leaveGameBtn");
        const startGameBtn = document.getElementById("startGameBtn");

        if (playerCount) {
          playerCount.textContent = `${gameState.playerCount}/8`;
        }

        if (gameStatus) {
          if (gameState.isPlaying) {
            let phaseText = "";
            switch (gameState.gamePhase) {
              case "night":
                phaseText = `ğŸŒ™ ç¬¬${gameState.dayCount}å¤©å¤œæ™š`;
                break;
              case "day":
                phaseText = `â˜€ï¸ ç¬¬${gameState.dayCount}å¤©ç™½å¤©`;
                break;
              case "vote":
                phaseText = `ğŸ—³ï¸ ç¬¬${gameState.dayCount}å¤©æŠ•ç¥¨`;
                break;
              default:
                phaseText = "æ¸¸æˆä¸­";
            }
            gameStatus.textContent = phaseText;
          } else {
            gameStatus.textContent = "ç­‰å¾…å¼€å§‹";
          }
        }

        if (gamePlayers) {
          if (gameState.players.length === 0) {
            gamePlayers.innerHTML =
              '<div style="grid-column: span 2; text-align: center; padding: 20px; color: #999;">æš‚æ— ç©å®¶</div>';
          } else {
            gamePlayers.innerHTML = gameState.players
              .map((p) => {
                const isHost = p.userId === gameState.hostId;
                const isCurrent = p.userId === currentUserId;
                return `
                            <div class="game-player ${p.isAlive === false ? "dead" : "alive"}">
                                <span>
                                    ${escapeHtml(p.username)}
                                    ${isCurrent ? " (ä½ )" : ""}
                                </span>
                                ${isHost ? '<span style="color: #f39c12;">ğŸ‘‘</span>' : ""}
                            </div>
                        `;
              })
              .join("");
          }
        }

        const isInGame = gameState.players.some(
          (p) => p.userId === currentUserId,
        );

        if (gameState.isPlaying) {
          joinGameBtn.style.display = "none";
          leaveGameBtn.style.display = "none";
          startGameBtn.style.display = "none";
        } else {
          if (isInGame) {
            joinGameBtn.style.display = "none";
            leaveGameBtn.style.display = "block";

            if (
              gameState.hostId === currentUserId &&
              gameState.players.length >= 5
            ) {
              startGameBtn.style.display = "block";
              startGameBtn.disabled = false;
            } else {
              startGameBtn.style.display = "none";
            }
          } else {
            joinGameBtn.style.display = "block";
            leaveGameBtn.style.display = "none";
            startGameBtn.style.display = "none";
          }
        }
      }

      function updateGameTimer(remaining) {
        const timer = document.getElementById("gameTimer");
        if (timer) {
          const minutes = Math.floor(remaining / 60);
          const seconds = remaining % 60;
          timer.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }
      }

      function updateGameInstructions(role) {
        const instructionList = document.getElementById("instructionList");
        if (!instructionList) return;

        let commands = [
          { cmd: "join", desc: "åŠ å…¥æ¸¸æˆ", icon: "â•" },
          { cmd: "leave", desc: "ç¦»å¼€æ¸¸æˆ", icon: "â–" },
          { cmd: "players", desc: "æŸ¥çœ‹å­˜æ´»ç©å®¶", icon: "ğŸ‘¥" },
          { cmd: "roles", desc: "æŸ¥çœ‹å‰©ä½™è§’è‰²", icon: "ğŸ“Š" },
          { cmd: "help", desc: "æŸ¥çœ‹æ‰€æœ‰æŒ‡ä»¤", icon: "â“" },
        ];

        if (gameState.isPlaying) {
          if (role === "ç‹¼äºº") {
            commands.unshift(
              { cmd: "wolf", desc: "ç‹¼äººç§èŠ", icon: "ğŸº" },
              { cmd: "kill", desc: "æ€æ­»ä¸€åç©å®¶", icon: "ğŸ”ª" },
            );
          } else if (role === "é¢„è¨€å®¶") {
            commands.unshift({
              cmd: "check",
              desc: "æŸ¥éªŒä¸€åç©å®¶",
              icon: "ğŸ”®",
            });
          } else if (role === "å¥³å·«") {
            commands.unshift(
              { cmd: "save", desc: "ä½¿ç”¨è§£è¯æ•‘äºº", icon: "ğŸ’Š" },
              { cmd: "poison", desc: "ä½¿ç”¨æ¯’è¯æ¯’äºº", icon: "â˜ ï¸" },
              { cmd: "skip", desc: "è·³è¿‡è¡ŒåŠ¨", icon: "â­ï¸" },
            );
          } else if (
            role === "çŒäºº" &&
            !gameState.players.find((p) => p.userId === currentUserId)?.isAlive
          ) {
            commands.unshift({
              cmd: "shoot",
              desc: "å¼€æªå¸¦èµ°ä¸€äºº",
              icon: "ğŸ¹",
            });
          }

          if (gameState.gamePhase === "vote") {
            commands.unshift({ cmd: "vote", desc: "æŠ•ç¥¨æ”¾é€", icon: "ğŸ—³ï¸" });
          }
        }

        instructionList.innerHTML = commands
          .map(
            (c) => `
        <li onclick="quickCommand('/${c.cmd}')">  <!-- è¿™é‡Œä¿æŒå¸¦æ–œæ ï¼Œå› ä¸ºquickCommandä¼šå¤„ç† -->
            <span class="instruction-icon">${c.icon || "ğŸ“"}</span>
            <span class="instruction-cmd">/${c.cmd}</span>
            <span class="instruction-desc">${c.desc}</span>
        </li>
    `,
          )
          .join("");
      }

      // ========== ç®¡ç†å‘˜é¢æ¿æ§åˆ¶ ==========
      function showAdminPanel() {
        const panel = document.getElementById("adminPanel");
        if (panel) {
          panel.style.display = "block";
          ws.send(JSON.stringify({ type: "adminGetUsers" }));
          ws.send(JSON.stringify({ type: "adminGetHistory" }));
          ws.send(JSON.stringify({ type: "adminGetBanned" }));
        }
      }

      function hideAdminPanel() {
        document.getElementById("adminPanel").style.display = "none";
      }

      function switchAdminTab(tab) {
        document
          .querySelectorAll(".admin-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".admin-content")
          .forEach((c) => (c.style.display = "none"));

        if (tab === "users") {
          document.querySelectorAll(".admin-tab")[0].classList.add("active");
          document.getElementById("adminUsersTab").style.display = "block";
          ws.send(JSON.stringify({ type: "adminGetUsers" }));
        } else if (tab === "messages") {
          document.querySelectorAll(".admin-tab")[1].classList.add("active");
          document.getElementById("adminMessagesTab").style.display = "block";
          ws.send(JSON.stringify({ type: "adminGetHistory" }));
        } else if (tab === "bans") {
          document.querySelectorAll(".admin-tab")[2].classList.add("active");
          document.getElementById("adminBansTab").style.display = "block";
          ws.send(JSON.stringify({ type: "adminGetBanned" }));
        }
      }

      function updateAdminUsers(users) {
        adminUsers = users;
        const userList = document.getElementById("adminUserList");
        if (!userList) return;

        if (!users || users.length === 0) {
          userList.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
          return;
        }

        userList.innerHTML = users
          .map((user) => {
            const status = [];
            if (user.isMuted)
              status.push(
                '<span class="status-badge status-muted">ç¦è¨€</span>',
              );
            if (user.isAdmin)
              status.push(
                '<span class="status-badge status-admin">ç®¡ç†å‘˜</span>',
              );
            if (status.length === 0)
              status.push(
                '<span class="status-badge status-normal">æ­£å¸¸</span>',
              );

            return `
                    <div class="admin-user-item">
                        <div class="admin-user-info">
                            <span class="admin-user-name">${escapeHtml(user.username)}</span>
                            <span class="admin-user-ip">${user.ip}</span>
                            <div class="admin-user-status">
                                ${status.join(" ")}
                            </div>
                        </div>
                        <div class="admin-user-actions">
                            ${user.isAdmin ? '<span style="color:#f39c12;">ç®¡ç†å‘˜</span>' : ""}
                            ${
                              !user.isAdmin
                                ? user.isMuted
                                  ? `<button class="btn-unmute" onclick="adminUnmute('${user.username}')">å–æ¶ˆç¦è¨€</button>`
                                  : `<button class="btn-mute" onclick="adminMute('${user.username}')">ç¦è¨€</button>`
                                : ""
                            }
                            ${!user.isAdmin ? `<button class="btn-ban" onclick="adminBan('${user.username}')">å°ç¦IP</button>` : ""}
                            ${!user.isAdmin ? `<button class="btn-kick" onclick="adminKick('${user.username}')">è¸¢å‡º</button>` : ""}
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function updateAdminMessages(messages) {
        adminMessages = messages;
        const messageList = document.getElementById("adminMessageList");
        if (!messageList) return;

        if (!messages || messages.length === 0) {
          messageList.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— æ¶ˆæ¯è®°å½•</div>';
          return;
        }

        messageList.innerHTML = messages
          .slice()
          .reverse()
          .map(
            (msg) => `
                <div class="admin-message-item">
                    <div class="admin-message-header">
                        <span>${escapeHtml(msg.username)}</span>
                        <span>${msg.timestamp}</span>
                    </div>
                    <div class="admin-message-content">${escapeHtml(msg.content)}</div>
                    <div class="admin-message-id">ID: ${msg.id}</div>
                    <div class="admin-message-actions">
                        <button class="btn-recall" onclick="adminRecall('${msg.id}')">æ’¤å›</button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function updateBannedIPs(ips) {
        const banList = document.getElementById("adminBanList");
        if (!banList) return;

        if (!ips || ips.length === 0) {
          banList.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— å°ç¦IP</div>';
          return;
        }

        banList.innerHTML = ips
          .map(
            (ip) => `
                <div class="admin-user-item">
                    <div class="admin-user-info">
                        <span class="admin-user-ip">${ip}</span>
                        <div class="admin-user-status">
                            <span class="status-badge status-banned">å·²å°ç¦</span>
                        </div>
                    </div>
                    <div class="admin-user-actions">
                        <button class="btn-unmute" onclick="adminUnban('${ip}')">è§£å°</button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      // ========== ç®¡ç†å‘˜æ“ä½œå‡½æ•° ==========
      function adminMute(username) {
        const reason = prompt("è¯·è¾“å…¥ç¦è¨€åŸå› ï¼š", "è¿è§„å‘è¨€");
        if (reason !== null) {
          ws.send(
            JSON.stringify({
              type: "adminMute",
              username: username,
              reason: reason,
            }),
          );
          addTerminalLog(`[ADMIN] å‘é€ç¦è¨€å‘½ä»¤: ${username}`, "admin");
          showAdminNotification(`å·²å‘é€ç¦è¨€è¯·æ±‚: ${username}`);
        }
      }

      function adminUnmute(username) {
        if (confirm(`ç¡®å®šè¦å–æ¶ˆ ${username} çš„ç¦è¨€å—ï¼Ÿ`)) {
          ws.send(
            JSON.stringify({
              type: "adminUnmute",
              username: username,
            }),
          );
          addTerminalLog(`[ADMIN] å‘é€å–æ¶ˆç¦è¨€å‘½ä»¤: ${username}`, "admin");
          showAdminNotification(`å·²å‘é€å–æ¶ˆç¦è¨€è¯·æ±‚: ${username}`);
        }
      }

      function adminBan(username) {
        const reason = prompt("è¯·è¾“å…¥å°ç¦åŸå› ï¼š", "æ¶æ„è¡Œä¸º");
        if (reason !== null) {
          if (confirm(`ç¡®å®šè¦å°ç¦ ${username} çš„IPå—ï¼Ÿ`)) {
            ws.send(
              JSON.stringify({
                type: "adminBan",
                username: username,
                reason: reason,
              }),
            );
            addTerminalLog(`[ADMIN] å‘é€å°ç¦å‘½ä»¤: ${username}`, "admin");
            showAdminNotification(`å·²å‘é€å°ç¦è¯·æ±‚: ${username}`);
          }
        }
      }

      function adminUnban(ip) {
        if (confirm(`ç¡®å®šè¦è§£å°IP ${ip} å—ï¼Ÿ`)) {
          ws.send(
            JSON.stringify({
              type: "adminUnban",
              ip: ip,
            }),
          );
          addTerminalLog(`[ADMIN] å‘é€è§£å°å‘½ä»¤: ${ip}`, "admin");
          showAdminNotification(`å·²å‘é€è§£å°è¯·æ±‚: ${ip}`);
        }
      }

      function adminKick(username) {
        const reason = prompt("è¯·è¾“å…¥è¸¢å‡ºåŸå› ï¼š", "è¿è§„è¡Œä¸º");
        if (reason !== null) {
          if (confirm(`ç¡®å®šè¦å°† ${username} è¸¢å‡ºèŠå¤©å®¤å—ï¼Ÿ`)) {
            ws.send(
              JSON.stringify({
                type: "adminKick",
                username: username,
                reason: reason,
              }),
            );
            addTerminalLog(`[ADMIN] å‘é€è¸¢å‡ºå‘½ä»¤: ${username}`, "admin");
            showAdminNotification(`å·²å‘é€è¸¢å‡ºè¯·æ±‚: ${username}`);
          }
        }
      }

      function adminRecall(messageId) {
        const reason = prompt("è¯·è¾“å…¥æ’¤å›åŸå› ï¼š", "ä¸å½“è¨€è®º");
        if (reason !== null) {
          if (confirm(`ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ`)) {
            ws.send(
              JSON.stringify({
                type: "adminRecall",
                messageId: messageId,
                reason: reason,
              }),
            );
            addTerminalLog(`[ADMIN] å‘é€æ’¤å›å‘½ä»¤: ${messageId}`, "admin");
            showAdminNotification(`å·²å‘é€æ’¤å›è¯·æ±‚: ${messageId}`);
          }
        }
      }

      function showAdminNotification(message) {
        const notification = document.createElement("div");
        notification.className = "admin-notification";
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // ========== CMDç»ˆç«¯åŠŸèƒ½ ==========
      function initTerminal() {
        addTerminalLog("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—", "info");
        addTerminalLog("â•‘               SUCCESS                â•‘", "success");
        addTerminalLog("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•", "info");
        addTerminalLog("", "info");
        addTerminalLog("ç³»ç»Ÿæ—¶é—´: " + new Date().toLocaleString(), "info");
        addTerminalLog("å½“å‰ç”¨æˆ·: " + currentUsername, "info");
        addTerminalLog("IPåœ°å€: " + (currentUserIp || "Unknown"), "info");
        addTerminalLog("", "info");
        addTerminalLog('è¾“å…¥ "help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤', "info");
      }

      function toggleTerminal() {
        // æ‰‹æœºç«¯ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        if (window.innerWidth <= 768) return;

        const terminal = document.getElementById("cmdTerminal");
        const toggleBtn = document.getElementById("terminalToggle");

        terminalVisible = !terminalVisible;
        if (terminalVisible) {
          terminal.classList.add("visible");
          toggleBtn.classList.add("active");
          toggleBtn.innerHTML = '<i class="fas fa-times"></i>';

          if (currentUserIsAdmin) {
            document.getElementById("cmdInput").disabled = false;
            document.getElementById("cmdInput").focus();
          }
        } else {
          terminal.classList.remove("visible");
          toggleBtn.classList.remove("active");
          toggleBtn.innerHTML = '<i class="fas fa-terminal"></i>';
          document.getElementById("cmdInput").disabled = true;
        }
      }

      function addTerminalLog(message, type = "info") {
        // æ‰‹æœºç«¯ä¸è®°å½•æ—¥å¿—
        if (window.innerWidth <= 768) return;

        const timestamp = new Date().toLocaleTimeString();
        let logClass = "cmd-log-info";

        switch (type) {
          case "warning":
            logClass = "cmd-log-warning";
            break;
          case "error":
            logClass = "cmd-log-error";
            break;
          case "success":
            logClass = "cmd-log-success";
            break;
          case "admin":
            logClass = "cmd-log-admin";
            break;
          case "game":
            logClass = "cmd-log-game";
            break;
        }

        const logLine = `<span class="cmd-timestamp">[${timestamp}]</span> <span class="${logClass}">${message}</span>`;
        terminalLogs.push(logLine);

        const terminalContent = document.getElementById("terminalContent");
        if (terminalContent) {
          const lineDiv = document.createElement("div");
          lineDiv.className = "cmd-line";
          lineDiv.innerHTML = logLine;
          terminalContent.appendChild(lineDiv);

          terminalContent.scrollTop = terminalContent.scrollHeight;
        }
      }

      function clearTerminal() {
        const terminalContent = document.getElementById("terminalContent");
        if (terminalContent) {
          terminalContent.innerHTML = "";
          terminalLogs = [];
          addTerminalLog("æ§åˆ¶å°å·²æ¸…ç©º", "info");
          addTerminalLog('è¾“å…¥ "help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤', "info");
        }
      }

      // å¤„ç†ç®¡ç†å‘˜å‘½ä»¤
      function handleAdminCommand(command) {
        const parts = command.split(" ");
        const cmd = parts[0].toLowerCase();
        const args = parts.slice(1);

        addTerminalLog(`ADMIN@SERVER:~$ ${command}`, "info");

        switch (cmd) {
          case "help":
            addTerminalLog("å¯ç”¨å‘½ä»¤:", "info");
            Object.entries(ADMIN_COMMANDS).forEach(([cmd, desc]) => {
              addTerminalLog(`  ${cmd.padEnd(20)} - ${desc}`, "info");
            });
            break;

          case "users":
            addTerminalLog("è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨...", "info");
            ws.send(JSON.stringify({ type: "adminGetUsers" }));
            break;

          case "userinfo":
            if (args.length < 1) {
              addTerminalLog("ç”¨æ³•: userinfo <ç”¨æˆ·å>", "error");
              return;
            }
            const username = args[0];
            const user = adminUsers.find((u) => u.username === username);
            if (user) {
              addTerminalLog(`ç”¨æˆ·ä¿¡æ¯: ${user.username}`, "success");
              addTerminalLog(`  ID: ${user.id}`, "info");
              addTerminalLog(`  IP: ${user.ip}`, "info");
              addTerminalLog(
                `  çŠ¶æ€: ${user.isMuted ? "ç¦è¨€ä¸­" : "æ­£å¸¸"}`,
                user.isMuted ? "warning" : "success",
              );
              addTerminalLog(
                `  ç®¡ç†å‘˜: ${user.isAdmin ? "æ˜¯" : "å¦"}`,
                user.isAdmin ? "admin" : "info",
              );
            } else {
              addTerminalLog(`ç”¨æˆ· ${username} ä¸å­˜åœ¨`, "error");
            }
            break;

          case "mute":
            if (args.length < 1) {
              addTerminalLog("ç”¨æ³•: mute <ç”¨æˆ·å> [åŸå› ]", "error");
              return;
            }
            const muteUser = args[0];
            const muteReason = args.slice(1).join(" ") || "ç®¡ç†å‘˜æ“ä½œ";
            ws.send(
              JSON.stringify({
                type: "adminMute",
                username: muteUser,
                reason: muteReason,
              }),
            );
            addTerminalLog(`å·²å‘é€ç¦è¨€å‘½ä»¤: ${muteUser}`, "admin");
            break;

          case "unmute":
            if (args.length < 1) {
              addTerminalLog("ç”¨æ³•: unmute <ç”¨æˆ·å>", "error");
              return;
            }
            ws.send(
              JSON.stringify({
                type: "adminUnmute",
                username: args[0],
              }),
            );
            addTerminalLog(`å·²å‘é€å–æ¶ˆç¦è¨€å‘½ä»¤: ${args[0]}`, "admin");
            break;

          case "kick":
            if (args.length < 1) {
              addTerminalLog("ç”¨æ³•: kick <ç”¨æˆ·å> [åŸå› ]", "error");
              return;
            }
            const kickUser = args[0];
            const kickReason = args.slice(1).join(" ") || "ç®¡ç†å‘˜æ“ä½œ";
            ws.send(
              JSON.stringify({
                type: "adminKick",
                username: kickUser,
                reason: kickReason,
              }),
            );
            addTerminalLog(`å·²å‘é€è¸¢å‡ºå‘½ä»¤: ${kickUser}`, "admin");
            break;

          case "ban":
            if (args.length < 1) {
              addTerminalLog("ç”¨æ³•: ban <ç”¨æˆ·å/IP> [åŸå› ]", "error");
              return;
            }
            const target = args[0];
            const banReason = args.slice(1).join(" ") || "ç®¡ç†å‘˜æ“ä½œ";

            // åˆ¤æ–­æ˜¯IPè¿˜æ˜¯ç”¨æˆ·å
            if (target.includes(".")) {
              ws.send(
                JSON.stringify({
                  type: "adminBan",
                  ip: target,
                  reason: banReason,
                }),
              );
              addTerminalLog(`å·²å‘é€å°ç¦IPå‘½ä»¤: ${target}`, "admin");
            } else {
              ws.send(
                JSON.stringify({
                  type: "adminBan",
                  username: target,
                  reason: banReason,
                }),
              );
              addTerminalLog(`å·²å‘é€å°ç¦ç”¨æˆ·å‘½ä»¤: ${target}`, "admin");
            }
            break;

          case "unban":
            if (args.length < 1) {
              addTerminalLog("ç”¨æ³•: unban <IP>", "error");
              return;
            }
            ws.send(
              JSON.stringify({
                type: "adminUnban",
                ip: args[0],
              }),
            );
            addTerminalLog(`å·²å‘é€è§£å°IPå‘½ä»¤: ${args[0]}`, "admin");
            break;

          case "recall":
            if (args.length < 1) {
              addTerminalLog("ç”¨æ³•: recall <æ¶ˆæ¯ID> [åŸå› ]", "error");
              return;
            }
            const msgId = args[0];
            const recallReason = args.slice(1).join(" ") || "ç®¡ç†å‘˜æ“ä½œ";
            ws.send(
              JSON.stringify({
                type: "adminRecall",
                messageId: msgId,
                reason: recallReason,
              }),
            );
            addTerminalLog(`å·²å‘é€æ’¤å›å‘½ä»¤: ${msgId}`, "admin");
            break;

          case "logs":
            const limit = args.length > 0 ? parseInt(args[0]) : 50;
            addTerminalLog(`è·å–æœ€è¿‘ ${limit} æ¡æ—¥å¿—...`, "info");
            ws.send(JSON.stringify({ type: "adminGetLogs" }));
            break;

          case "search":
            if (args.length < 1) {
              addTerminalLog("ç”¨æ³•: search <ç”¨æˆ·å/IP>", "error");
              return;
            }
            const searchTerm = args[0].toLowerCase();

            // æœç´¢ç”¨æˆ·
            const matchedUsers = adminUsers.filter(
              (u) =>
                u.username.toLowerCase().includes(searchTerm) ||
                u.ip.includes(searchTerm),
            );

            if (matchedUsers.length > 0) {
              addTerminalLog(
                `æ‰¾åˆ° ${matchedUsers.length} ä¸ªåŒ¹é…çš„ç”¨æˆ·:`,
                "success",
              );
              matchedUsers.forEach((u) => {
                addTerminalLog(
                  `  ${u.username} - IP: ${u.ip} - çŠ¶æ€: ${u.isMuted ? "ç¦è¨€" : "æ­£å¸¸"}`,
                  "info",
                );
              });
            } else {
              addTerminalLog("æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·", "warning");
            }

            // æœç´¢å°ç¦IP
            const matchedBans = bannedIPs.filter((ip) =>
              ip.includes(searchTerm),
            );
            if (matchedBans.length > 0) {
              addTerminalLog(
                `æ‰¾åˆ° ${matchedBans.length} ä¸ªåŒ¹é…çš„å°ç¦IP:`,
                "warning",
              );
              matchedBans.forEach((ip) => {
                addTerminalLog(`  ${ip}`, "warning");
              });
            }
            break;

          case "stats":
            addTerminalLog("æœåŠ¡å™¨ç»Ÿè®¡:", "info");
            addTerminalLog(`  åœ¨çº¿ç”¨æˆ·: ${adminUsers.length}`, "info");
            addTerminalLog(
              `  æ¸¸æˆè¿›è¡Œä¸­: ${gameState.isPlaying ? "æ˜¯" : "å¦"}`,
              "info",
            );
            addTerminalLog(`  æ¸¸æˆç©å®¶: ${gameState.players.length}/8`, "info");
            addTerminalLog(`  æ¶ˆæ¯æ€»æ•°: ${adminMessages.length}`, "info");
            addTerminalLog(`  å°ç¦IPæ•°: ${bannedIPs.length}`, "info");
            addTerminalLog(`  æ—¥å¿—æ¡æ•°: ${terminalLogs.length}`, "info");
            break;

          case "clear":
            clearTerminal();
            break;

          default:
            addTerminalLog(`æœªçŸ¥å‘½ä»¤: ${cmd}`, "error");
            addTerminalLog('è¾“å…¥ "help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤', "info");
        }
      }

      // ========== å¯æ‹–åŠ¨ç»ˆç«¯ ==========
      function makeDraggable() {
        // æ‰‹æœºç«¯ä¸å¯ç”¨æ‹–åŠ¨
        if (window.innerWidth <= 768) return;

        const terminal = document.getElementById("cmdTerminal");
        const header = document.getElementById("terminalHeader");

        if (!terminal || !header) return;

        header.addEventListener("mousedown", (e) => {
          isDragging = true;
          const rect = terminal.getBoundingClientRect();
          dragOffsetX = e.clientX - rect.left;
          dragOffsetY = e.clientY - rect.top;
          terminal.style.cursor = "grabbing";
        });

        document.addEventListener("mousemove", (e) => {
          if (!isDragging) return;

          e.preventDefault();
          const x = e.clientX - dragOffsetX;
          const y = e.clientY - dragOffsetY;

          terminal.style.left = x + "px";
          terminal.style.top = y + "px";
          terminal.style.right = "auto";
          terminal.style.bottom = "auto";
        });

        document.addEventListener("mouseup", () => {
          isDragging = false;
          terminal.style.cursor = "default";
        });
      }

      // ========== UIæ§åˆ¶ ==========
      function switchTab(tab) {
        document
          .querySelectorAll(".tab-item")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-panel")
          .forEach((p) => p.classList.remove("active"));

        if (tab === "chat") {
          document.querySelectorAll(".tab-item")[0].classList.add("active");
          document.getElementById("chatPanel").classList.add("active");
        } else if (tab === "users") {
          document.querySelectorAll(".tab-item")[1].classList.add("active");
          document.getElementById("usersPanel").classList.add("active");
        } else if (tab === "game") {
          document.querySelectorAll(".tab-item")[2].classList.add("active");
          document.getElementById("gamePanel").classList.add("active");

          if (isConnected) {
            ws.send(JSON.stringify({ type: "getGameState" }));
          }
        }
      }

      // ========== å·¥å…·å‡½æ•° ==========
      function escapeHtml(unsafe) {
        if (!unsafe) return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function showError(message) {
        const errorDiv = document.getElementById("loginError");
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
          setTimeout(() => {
            errorDiv.style.display = "none";
          }, 3000);
        } else {
          alert(message);
        }
      }

      // ========== äº‹ä»¶ç›‘å¬ ==========
      document.addEventListener("DOMContentLoaded", function () {
        const messageInput = document.getElementById("messageInput");
        const usernameInput = document.getElementById("username");

        if (messageInput) {
          messageInput.addEventListener("input", function () {
            this.style.height = "auto";
            this.style.height = this.scrollHeight + "px";
          });
        }

        if (usernameInput) {
          usernameInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              joinChat();
            }
          });
        }

        // CMDè¾“å…¥å¤„ç†
        const cmdInput = document.getElementById("cmdInput");
        if (cmdInput) {
          cmdInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              const command = this.value.trim();
              if (command) {
                handleAdminCommand(command);
                this.value = "";

                cmdHistory.push(command);
                cmdHistoryIndex = cmdHistory.length;
              }
            }
          });

          cmdInput.addEventListener("keydown", function (e) {
            if (e.key === "ArrowUp") {
              e.preventDefault();
              if (cmdHistoryIndex > 0) {
                cmdHistoryIndex--;
                this.value = cmdHistory[cmdHistoryIndex];
              }
            } else if (e.key === "ArrowDown") {
              e.preventDefault();
              if (cmdHistoryIndex < cmdHistory.length - 1) {
                cmdHistoryIndex++;
                this.value = cmdHistory[cmdHistoryIndex];
              } else {
                cmdHistoryIndex = cmdHistory.length;
                this.value = "";
              }
            }
          });
        }

        // æ ¹æ®å±å¹•å®½åº¦å†³å®šæ˜¯å¦åˆå§‹åŒ–æ‹–åŠ¨
        if (window.innerWidth > 768) {
          makeDraggable();
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æŒ‡ä»¤å»ºè®®
        document.addEventListener("click", function (e) {
          if (
            !e.target.closest(".message-input-wrapper") &&
            !e.target.closest(".command-suggestions")
          ) {
            hideCommandSuggestions();
          }
        });
      });

      // é¡µé¢å…³é—­å‰æ¸…ç†
      window.addEventListener("beforeunload", function () {
        if (ws) {
          ws.close();
        }
      });

      // æ·»åŠ æ¸¸æˆç©å®¶æ ·å¼
      const style = document.createElement("style");
      style.textContent = `
            .game-player.alive {
                border-left: 3px solid #2ecc71;
            }
            .game-player.dead {
                border-left: 3px solid #e74c3c;
                opacity: 0.6;
            }
        `;
      document.head.appendChild(style);

      // å¯åŠ¨è¿æ¥
      connect();
    </script>
  </body>
</html>
