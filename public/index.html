<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>èŠå¤©å®¤</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* é¢œè‰²ç³»ç»Ÿä¿æŒä¸å˜ */
            --primary: #4a90e2;
            --primary-dark: #357abd;
            --primary-light: #6ba6ff;
            --secondary: #667eea;
            --accent: #764ba2;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #f5f7fa;
            
            --text-primary: #333;
            --text-secondary: #666;
            --text-light: #999;
            --text-white: #fff;
            
            --border: #e0e0e0;
            --bg-light: #f8f9fa;
            --bg-white: #fff;
            --bg-overlay: rgba(255, 255, 255, 0.95);
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 5px 15px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.2);
            
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-blue: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 30px;
            --radius-full: 9999px;
            
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-2xl: 24px;
            --spacing-3xl: 30px;
            
            /* å®‰å…¨åŒºåŸŸ */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            
            /* è¾“å…¥æ¡†é«˜åº¦ */
            --input-height: 46px;
            --input-height-mobile: 44px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--gradient-primary);
            height: 100vh;
            height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        html {
            height: -webkit-fill-available;
        }

        /* åŠ¨æ€èƒŒæ™¯ */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: twinkle 3s infinite;
            pointer-events: none;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .floating-shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            animation: float 20s infinite;
            pointer-events: none;
            opacity: 0.4;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -50px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .connection-status {
            position: fixed;
            top: max(10px, var(--safe-area-top));
            right: 10px;
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition-normal);
            border: 1px solid rgba(255,255,255,0.2);
            pointer-events: none;
        }

        .status-connected { background: rgba(46, 204, 113, 0.95); color: white; }
        .status-disconnected { background: rgba(231, 76, 60, 0.95); color: white; }
        .status-connecting { background: rgba(243, 156, 18, 0.95); color: white; }

        /* ä¸»å®¹å™¨ */
        .chat-wrapper {
            width: 100%;
            max-width: 1400px;
            height: 100vh;
            height: -webkit-fill-available;
            background: var(--bg-overlay);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
            display: flex;
            position: relative;
            z-index: 1;
            animation: slideIn 0.5s var(--transition-normal);
            overflow: hidden;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== ç”µè„‘ç«¯å¸ƒå±€ ========== */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--bg-white) 0%, var(--bg-light) 100%);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all var(--transition-normal);
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: var(--spacing-2xl) var(--spacing-xl);
            background: var(--gradient-blue);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: rotate 15s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .sidebar-header h3 {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .online-count {
            font-size: 32px;
            font-weight: bold;
            position: relative;
            z-index: 1;
            line-height: 1.2;
        }

        .online-count small {
            font-size: 13px;
            font-weight: normal;
            opacity: 0.8;
            margin-left: 5px;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
            scrollbar-width: thin;
        }

        .user-item {
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            background: var(--bg-white);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
            cursor: pointer;
            border: 1px solid transparent;
        }

        .user-item.current-user {
            background: linear-gradient(135deg, #e8f0fe 0%, #d4e4fc 100%);
            border-color: var(--primary);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .user-status {
            font-size: 10px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .user-status i {
            font-size: 6px;
        }

        /* ä¸»èŠå¤©åŒº - ä½¿ç”¨flexåˆ—å¸ƒå±€ */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-white);
            min-width: 0;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            padding: var(--spacing-lg) var(--spacing-2xl);
            background: var(--gradient-primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            flex-shrink: 0;
            z-index: 10;
        }

        .chat-header h2 {
            font-size: clamp(18px, 4vw, 24px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header p {
            font-size: clamp(12px, 3vw, 14px);
            opacity: 0.9;
            margin-top: 4px;
        }

        .header-stats {
            display: flex;
            gap: var(--spacing-lg);
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: var(--radius-full);
            backdrop-filter: blur(5px);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: clamp(16px, 4vw, 20px);
            font-weight: bold;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.9;
        }

        /* ç™»å½•åŒºåŸŸ */
        .login-container {
            padding: var(--spacing-3xl);
            background: linear-gradient(135deg, var(--bg-light) 0%, #e9ecef 100%);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            flex-shrink: 0;
            z-index: 10;
        }

        .login-box {
            background: var(--bg-white);
            padding: clamp(20px, 5vw, 35px) clamp(20px, 5vw, 30px);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 10px 30px rgba(74, 144, 226, 0.2); }
            50% { box-shadow: 0 20px 40px rgba(74, 144, 226, 0.3); }
            100% { box-shadow: 0 10px 30px rgba(74, 144, 226, 0.2); }
        }

        .login-box h3 {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            color: var(--text-primary);
            font-size: clamp(20px, 6vw, 26px);
        }

        .input-group {
            margin-bottom: var(--spacing-lg);
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 15px;
            transition: all var(--transition-fast);
            background: var(--bg-light);
            -webkit-appearance: none;
        }

        .input-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            background: var(--bg-white);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--gradient-blue);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        #loginError {
            color: var(--danger);
            margin-top: var(--spacing-md);
            text-align: center;
            font-size: 14px;
            padding: 8px;
            border-radius: var(--radius-sm);
            background: rgba(231, 76, 60, 0.1);
            display: none;
        }

        /* æ¶ˆæ¯åŒºåŸŸ - å¯æ»šåŠ¨ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-xl);
            background: var(--bg-light);
            background-image: radial-gradient(circle at 20px 20px, rgba(0,0,0,0.02) 2px, transparent 2px);
            background-size: 40px 40px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            transition: padding-bottom var(--transition-normal);
        }

        .message {
            margin-bottom: var(--spacing-lg);
            animation: messageSlide 0.3s var(--transition-normal);
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.system {
            text-align: center;
            margin: var(--spacing-md) 0;
        }

        .system-content {
            display: inline-block;
            padding: 6px 20px;
            background: rgba(0,0,0,0.05);
            border-radius: var(--radius-full);
            color: var(--text-secondary);
            font-size: 12px;
            backdrop-filter: blur(5px);
        }

        .message.chat {
            display: flex;
            flex-direction: column;
        }

        .message.chat.own-message {
            align-items: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            padding: 0 4px;
        }

        .own-message .message-header {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 13px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .message-username {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 9px;
            color: var(--text-light);
        }

        .message-bubble {
            max-width: min(70%, 500px);
            padding: 10px 16px;
            border-radius: 18px;
            background: var(--bg-white);
            box-shadow: var(--shadow-sm);
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            margin-left: 34px;
            transition: all var(--transition-fast);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .own-message .message-bubble {
            margin-left: 0;
            margin-right: 34px;
            background: var(--gradient-blue);
            color: white;
            border: none;
        }

        /* é”™è¯¯æç¤º */
        #errorContainer {
            position: fixed;
            top: max(60px, var(--safe-area-top));
            right: 10px;
            left: 10px;
            z-index: 1001;
            max-width: 350px;
            margin: 0 auto;
            pointer-events: none;
        }

        .error-message {
            background: var(--danger);
            color: white;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            animation: slideDown 0.3s var(--transition-normal);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            pointer-events: auto;
        }

        /* ========== è¾“å…¥åŒºåŸŸ - å§‹ç»ˆå›ºå®šåœ¨åº•éƒ¨ ========== */
        .input-wrapper {
            position: relative;
            background: var(--bg-white);
            border-top: 1px solid var(--border);
            transition: transform var(--transition-normal);
            z-index: 100;
            width: 100%;
            flex-shrink: 0;
        }

        .typing-indicator {
            padding: 6px var(--spacing-xl);
            color: var(--text-secondary);
            font-style: italic;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-white);
            border-top: 1px solid var(--border);
            min-height: 32px;
            transition: all var(--transition-normal);
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 5px;
            height: 5px;
            background: var(--primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-5px); opacity: 1; }
        }

        .input-area {
            padding: var(--spacing-md) var(--spacing-xl);
            background: var(--bg-white);
            display: flex;
            gap: var(--spacing-sm);
            align-items: flex-end;
            transition: all var(--transition-normal);
            padding-bottom: max(var(--spacing-md), var(--safe-area-bottom));
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--border);
            border-radius: 24px;
            font-size: 15px;
            resize: none;
            max-height: 120px;
            transition: all var(--transition-fast);
            background: var(--bg-light);
            font-family: inherit;
            line-height: 1.5;
            -webkit-appearance: none;
            height: var(--input-height);
        }

        .message-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            background: var(--bg-white);
        }

        .message-input:disabled {
            background: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .emoji-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 20px;
            transition: all var(--transition-fast);
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .emoji-btn:active {
            background: rgba(74, 144, 226, 0.1);
            transform: scale(1.1);
        }

        .emoji-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .send-btn {
            padding: 0 25px;
            background: var(--gradient-blue);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
            height: var(--input-height);
            white-space: nowrap;
            min-width: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        .send-btn:active {
            transform: scale(0.96);
        }

        .send-btn:disabled {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }

        /* Emoji é¢æ¿ */
        .emoji-panel {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
            padding: var(--spacing-md);
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-width: 100%;
            animation: slideUp 0.3s var(--transition-normal);
            z-index: 99;
            border: 1px solid var(--border);
            border-bottom: none;
            transform: translateY(0);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            background: var(--bg-light);
            -webkit-tap-highlight-color: transparent;
            padding: 8px;
        }

        .emoji-item:active {
            background: var(--gradient-blue);
            transform: scale(1.1);
        }

        /* æ¬¢è¿æ¶ˆæ¯ */
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .welcome-message i {
            font-size: 60px;
            margin-bottom: 16px;
            color: var(--primary);
            animation: bounce 2s infinite;
            display: inline-block;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        .welcome-message h3 {
            font-size: 22px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* ========== æ‰‹æœºç«¯å¸ƒå±€ ========== */
        @media (max-width: 768px) {
            .chat-wrapper {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 30vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .sidebar-header {
                padding: var(--spacing-md) var(--spacing-lg);
            }

            .sidebar-header h3 {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .online-count {
                font-size: 24px;
            }

            .user-list {
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
                padding: var(--spacing-sm);
                gap: var(--spacing-sm);
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
            }

            .user-item {
                min-width: 100px;
                margin-bottom: 0;
                flex-shrink: 0;
                scroll-snap-align: start;
                padding: var(--spacing-sm);
                gap: var(--spacing-sm);
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .user-name {
                font-size: 12px;
            }

            .chat-header {
                padding: var(--spacing-md) var(--spacing-lg);
            }

            .chat-header h2 {
                font-size: 18px;
            }

            .chat-header p {
                font-size: 11px;
            }

            .header-stats {
                padding: 6px 12px;
                gap: var(--spacing-md);
            }

            .login-container {
                padding: var(--spacing-xl);
                min-height: 180px;
            }

            .login-box {
                padding: var(--spacing-xl);
            }

            .login-box h3 {
                font-size: 20px;
                margin-bottom: var(--spacing-lg);
            }

            .messages-container {
                padding: var(--spacing-md);
            }

            .message-bubble {
                max-width: 85%;
                font-size: 14px;
                padding: 8px 14px;
            }

            /* æ‰‹æœºç«¯è¾“å…¥åŒºåŸŸä¼˜åŒ– */
            .input-wrapper {
                position: relative;
                z-index: 100;
            }

            .input-area {
                padding: var(--spacing-sm) var(--spacing-md);
                gap: var(--spacing-sm);
                padding-bottom: max(var(--spacing-sm), var(--safe-area-bottom));
            }

            .message-input {
                font-size: 14px;
                padding: 10px 40px 10px 12px;
                height: var(--input-height-mobile);
            }

            .emoji-btn {
                width: 30px;
                height: 30px;
                font-size: 18px;
                bottom: 7px;
                right: 6px;
            }

            .send-btn {
                padding: 0 16px;
                height: var(--input-height-mobile);
                font-size: 14px;
                min-width: 60px;
            }

            .emoji-panel {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                padding: var(--spacing-sm);
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            }

            .emoji-item {
                font-size: 22px;
                padding: 6px;
            }

            .typing-indicator {
                padding: 4px var(--spacing-md);
                font-size: 10px;
                min-height: 28px;
            }
        }

        /* å°å±å¹•æ‰‹æœº */
        @media (max-width: 375px) {
            .user-item {
                min-width: 90px;
            }

            .message-bubble {
                max-width: 90%;
            }

            .send-btn span {
                display: none;
            }

            .send-btn {
                min-width: 44px;
                padding: 0 12px;
            }

            .send-btn i {
                font-size: 16px;
                margin: 0;
            }

            .emoji-panel {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* æ¨ªå±æ¨¡å¼ */
        @media (max-height: 500px) and (orientation: landscape) {
            .sidebar {
                max-height: 100vh;
                width: 200px;
            }

            .login-container {
                min-height: 150px;
            }

            .input-area {
                padding: var(--spacing-xs) var(--spacing-md);
            }
        }

        /* è§¦æ‘¸ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .user-item:hover,
            .message-bubble:hover,
            .send-btn:hover {
                transform: none;
            }
            
            .user-item:active {
                background: var(--bg-light);
            }
        }

        /* é”®ç›˜å¼¹å‡ºæ—¶çš„æ ·å¼ */
        .keyboard-visible .input-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            transform: translateY(0) !important;
            background: var(--bg-white);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .keyboard-visible .emoji-panel {
            display: none !important;
        }

        .keyboard-visible .messages-container {
            padding-bottom: calc(var(--input-height-mobile) + var(--spacing-xl) * 2 + 40px);
        }
    </style>
</head>
<body>
    <div class="background-animation" id="background"></div>
    
    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="connection-status" id="connectionStatus"></div>
    
    <div class="chat-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>
                    <i class="fas fa-users"></i>
                    åœ¨çº¿ç”¨æˆ·
                </h3>
                <div class="online-count">
                    <span id="onlineCount">0</span>
                    <small>äºº</small>
                </div>
            </div>
            <div class="user-list" id="userList"></div>
        </div>

        <!-- ä¸»èŠå¤©åŒº -->
        <div class="main-chat">
            <div class="chat-header">
                <div>
                    <h2>
                        <i class="fas fa-comments"></i>
                        èŠå¤©å®¤
                    </h2>
                    <p>
                        <i class="fas fa-globe"></i>
                        å®æ—¶èŠå¤©
                    </p>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalMessages">0</div>
                        <div class="stat-label">æ¶ˆæ¯</div>
                    </div>
                </div>
            </div>

            <!-- ç™»å½•åŒºåŸŸ -->
            <div class="login-container" id="loginContainer">
                <div class="login-box">
                    <h3>
                        <i class="fas fa-rocket"></i>
                        åŠ å…¥èŠå¤©
                    </h3>
                    <div class="input-group">
                        <label>
                            <i class="fas fa-user"></i>
                            æ˜µç§°
                        </label>
                        <input 
                            type="text" 
                            id="username" 
                            placeholder="è¾“å…¥æ˜µç§°..." 
                            maxlength="20" 
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                        >
                    </div>
                    <button class="login-btn" onclick="joinChat()" id="joinBtn">
                        <span>è¿›å…¥</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <div id="loginError"></div>
                </div>
            </div>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div class="messages-container" id="messages">
                <div class="welcome-message">
                    <i class="fas fa-hand-peace"></i>
                    <h3>æ¬¢è¿</h3>
                    <p>è¾“å…¥æ˜µç§°å¼€å§‹èŠå¤©</p>
                </div>
            </div>

            <!-- é”™è¯¯æç¤º -->
            <div id="errorContainer" style="display: none;"></div>

            <!-- è¾“å…¥åŒºåŸŸåŒ…è£…å™¨ - ç”¨äºé”®ç›˜å¼¹å‡ºæ—¶å®šä½ -->
            <div class="input-wrapper" id="inputWrapper">
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span id="typingText"></span>
                </div>

                <div class="input-area" id="inputArea">
                    <div class="message-input-wrapper">
                        <textarea 
                            id="messageInput" 
                            class="message-input" 
                            placeholder="è¾“å…¥æ¶ˆæ¯..." 
                            disabled
                            rows="1"
                            inputmode="text"
                        ></textarea>
                        <button class="emoji-btn" id="emojiBtn" onclick="toggleEmojiPanel()" disabled>
                            <i class="far fa-smile"></i>
                        </button>
                        <div class="emoji-panel" id="emojiPanel" style="display: none;"></div>
                    </div>
                    <button class="send-btn" id="sendButton" onclick="sendMessage()" disabled>
                        <span>å‘é€</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const CONFIG = {
            maxReconnectAttempts: 5,
            reconnectDelay: 3000,
            typingTimeout: 1000,
            heartbeatInterval: 30000,
            maxMessageLength: 500,
            maxUsernameLength: 20
        };

        // çŠ¶æ€ç®¡ç†
        let ws = null;
        let currentUsername = null;
        let currentUserId = null;
        let typingTimeout = null;
        let messageCount = 0;
        let activeTypingUsers = new Map();
        let reconnectAttempts = 0;
        let heartbeatInterval = null;
        let isConnected = false;
        let isJoining = false;
        let keyboardHeight = 0;
        let originalViewportHeight = window.innerHeight;
        let isKeyboardVisible = false;

        // å¸¸ç”¨è¡¨æƒ…
        const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'â¤ï¸', 'ğŸ‘', 'ğŸ‰', 'âœ¨', 'ğŸ”¥', 'ğŸ’¯', 
                       'ğŸ¤”', 'ğŸ˜¢', 'ğŸ˜', 'ğŸ¥³', 'ğŸ‘‹', 'ğŸ™', 'ğŸ•', 'ğŸ¸',
                       'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ™', 'â­', 'âš¡', 'â„ï¸', 'ğŸŒŸ', 'â­'];

        // åˆå§‹åŒ–èƒŒæ™¯
        function initBackground() {
            const bg = document.getElementById('background');
            if (!bg) return;
            
            bg.innerHTML = '';
            
            const starCount = window.innerWidth < 768 ? 30 : 50;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                bg.appendChild(star);
            }
            
            const shapes = [
                { color: 'rgba(255, 107, 107, 0.3)', size: window.innerWidth < 768 ? 200 : 300 },
                { color: 'rgba(78, 205, 196, 0.3)', size: window.innerWidth < 768 ? 250 : 400 },
                { color: 'rgba(69, 183, 209, 0.3)', size: window.innerWidth < 768 ? 220 : 350 }
            ];
            
            shapes.forEach((shape, index) => {
                const div = document.createElement('div');
                div.className = 'floating-shape';
                div.style.width = shape.size + 'px';
                div.style.height = shape.size + 'px';
                div.style.background = shape.color;
                div.style.left = Math.random() * 70 + 15 + '%';
                div.style.top = Math.random() * 70 + 15 + '%';
                div.style.animationDelay = index * 2 + 's';
                bg.appendChild(div);
            });
        }

        // å¤„ç†ç§»åŠ¨ç«¯é”®ç›˜å¼¹å‡º - è®©è¾“å…¥æ¡†ç´§è´´é”®ç›˜ä¸Šéƒ¨
        function setupKeyboardHandling() {
            if (!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) return;

            const messageInput = document.getElementById('messageInput');
            const inputWrapper = document.getElementById('inputWrapper');
            const messagesContainer = document.getElementById('messages');
            const mainChat = document.querySelector('.main-chat');
            
            if (!messageInput || !inputWrapper || !messagesContainer) return;

            // è·å–è¾“å…¥æ¡†çš„é«˜åº¦
            const getInputWrapperHeight = () => {
                return inputWrapper.offsetHeight;
            };

            // é”®ç›˜å¼¹å‡º
            messageInput.addEventListener('focus', () => {
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾…é”®ç›˜å®Œå…¨å¼¹å‡º
                setTimeout(() => {
                    // è®¡ç®—é”®ç›˜é«˜åº¦
                    const currentHeight = window.innerHeight;
                    if (currentHeight < originalViewportHeight - 100) {
                        keyboardHeight = originalViewportHeight - currentHeight;
                        isKeyboardVisible = true;
                        
                        // æ·»åŠ é”®ç›˜å¯è§ç±»
                        document.body.classList.add('keyboard-visible');
                        
                        // å°†è¾“å…¥åŒ…è£…å™¨å›ºå®šåœ¨åº•éƒ¨ï¼Œç´§è´´é”®ç›˜
                        inputWrapper.style.position = 'fixed';
                        inputWrapper.style.bottom = keyboardHeight + 'px';
                        inputWrapper.style.left = '0';
                        inputWrapper.style.right = '0';
                        inputWrapper.style.zIndex = '1000';
                        
                        // ç»™æ¶ˆæ¯å®¹å™¨æ·»åŠ åº•éƒ¨å†…è¾¹è·ï¼Œé¿å…å†…å®¹è¢«è¾“å…¥æ¡†é®æŒ¡
                        messagesContainer.style.paddingBottom = (getInputWrapperHeight() + 20) + 'px';
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        setTimeout(() => {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }, 100);
                    }
                }, 300);
            });

            // é”®ç›˜æ”¶èµ·
            messageInput.addEventListener('blur', () => {
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦çœŸçš„æ”¶èµ·äº†é”®ç›˜
                    const currentHeight = window.innerHeight;
                    if (currentHeight >= originalViewportHeight - 100) {
                        isKeyboardVisible = false;
                        
                        // ç§»é™¤é”®ç›˜å¯è§ç±»
                        document.body.classList.remove('keyboard-visible');
                        
                        // æ¢å¤è¾“å…¥åŒ…è£…å™¨çš„ä½ç½®
                        inputWrapper.style.position = '';
                        inputWrapper.style.bottom = '';
                        inputWrapper.style.left = '';
                        inputWrapper.style.right = '';
                        inputWrapper.style.zIndex = '';
                        
                        // æ¢å¤æ¶ˆæ¯å®¹å™¨çš„å†…è¾¹è·
                        messagesContainer.style.paddingBottom = '';
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }, 300);
            });

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆé”®ç›˜å¼¹å‡º/æ”¶èµ·ï¼‰
            window.addEventListener('resize', () => {
                const currentHeight = window.innerHeight;
                
                // æ£€æµ‹é”®ç›˜æ˜¯å¦å¼¹å‡ºï¼ˆé«˜åº¦å‡å°‘è¶…è¿‡100pxï¼‰
                if (currentHeight < originalViewportHeight - 100) {
                    // é”®ç›˜å¼¹å‡º
                    keyboardHeight = originalViewportHeight - currentHeight;
                    
                    if (document.activeElement === messageInput) {
                        isKeyboardVisible = true;
                        document.body.classList.add('keyboard-visible');
                        
                        // æ›´æ–°è¾“å…¥æ¡†ä½ç½®
                        inputWrapper.style.position = 'fixed';
                        inputWrapper.style.bottom = keyboardHeight + 'px';
                        
                        // æ›´æ–°æ¶ˆæ¯å®¹å™¨å†…è¾¹è·
                        messagesContainer.style.paddingBottom = (getInputWrapperHeight() + 20) + 'px';
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        setTimeout(() => {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }, 50);
                    }
                } else {
                    // é”®ç›˜æ”¶èµ·
                    if (isKeyboardVisible) {
                        isKeyboardVisible = false;
                        document.body.classList.remove('keyboard-visible');
                        
                        inputWrapper.style.position = '';
                        inputWrapper.style.bottom = '';
                        messagesContainer.style.paddingBottom = '';
                    }
                    
                    originalViewportHeight = currentHeight;
                }
            });

            // ç‚¹å‡»å‘é€æŒ‰é’®æ—¶ä¸æ”¶èµ·é”®ç›˜
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // é˜²æ­¢å¤±å»ç„¦ç‚¹
                });
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;
            
            statusEl.className = 'connection-status';
            
            switch(status) {
                case 'connected':
                    statusEl.classList.add('status-connected');
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>å·²è¿æ¥</span>';
                    isConnected = true;
                    reconnectAttempts = 0;
                    break;
                case 'connecting':
                    statusEl.classList.add('status-connecting');
                    statusEl.innerHTML = '<i class="fas fa-spinner fa-pulse"></i><span>è¿æ¥ä¸­...</span>';
                    isConnected = false;
                    break;
                case 'disconnected':
                    statusEl.classList.add('status-disconnected');
                    statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>${message || 'å·²æ–­å¼€'}</span>`;
                    isConnected = false;
                    break;
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message, isLoginError = false) {
            if (isLoginError) {
                const errorDiv = document.getElementById('loginError');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                    }, 3000);
                }
            } else {
                const container = document.getElementById('errorContainer');
                if (!container) return;
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                container.appendChild(errorDiv);
                container.style.display = 'block';
                
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(50);
                }
                
                setTimeout(() => {
                    errorDiv.remove();
                    if (container.children.length === 0) {
                        container.style.display = 'none';
                    }
                }, 3000);
            }
        }

        // åˆå§‹åŒ–è¡¨æƒ…é¢æ¿
        function initEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            if (!panel) return;
            
            panel.innerHTML = '';
            
            emojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'emoji-item';
                item.textContent = emoji;
                item.onclick = (e) => {
                    e.stopPropagation();
                    insertEmoji(emoji);
                };
                panel.appendChild(item);
            });
        }

        // æ’å…¥è¡¨æƒ…
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            if (!input || input.disabled) return;
            
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            
            adjustTextareaHeight(input);
            toggleEmojiPanel();
        }

        // åˆ‡æ¢è¡¨æƒ…é¢æ¿
        function toggleEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            if (!panel) return;
            
            if (isKeyboardVisible) return; // é”®ç›˜å¼¹å‡ºæ—¶ä¸æ˜¾ç¤ºè¡¨æƒ…é¢æ¿
            
            const isVisible = panel.style.display === 'grid';
            panel.style.display = isVisible ? 'none' : 'grid';
        }

        // WebSocket è¿æ¥
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            
            updateConnectionStatus('connecting');
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                console.log('å·²è¿æ¥åˆ°èŠå¤©');
                updateConnectionStatus('connected');
                
                if (currentUsername) {
                    joinChat(true);
                }
                
                startHeartbeat();
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    switch (data.type) {
                        case 'history':
                            displayHistory(data.messages);
                            break;
                        case 'chat':
                            addMessage(data);
                            messageCount++;
                            updateStats();
                            if (window.innerWidth < 768 && document.visibilityState === 'visible') {
                                if (window.navigator && window.navigator.vibrate) {
                                    window.navigator.vibrate(20);
                                }
                            }
                            break;
                        case 'system':
                            addSystemMessage(data);
                            break;
                        case 'users':
                            updateUserList(data.users);
                            updateStats();
                            break;
                        case 'typing':
                            handleTyping(data);
                            break;
                        case 'welcome':
                            currentUserId = data.userId;
                            document.getElementById('loginContainer').style.display = 'none';
                            enableChatControls(true);
                            break;
                        case 'error':
                            showError(data.content, true);
                            enableChatControls(false);
                            const joinBtn = document.getElementById('joinBtn');
                            if (joinBtn) {
                                joinBtn.disabled = false;
                                joinBtn.innerHTML = '<span>è¿›å…¥</span><i class="fas fa-arrow-right"></i>';
                            }
                            break;
                        case 'ping':
                            if (ws.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify({ type: 'pong' }));
                            }
                            break;
                    }
                } catch (error) {
                    console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
                }
            };

            ws.onclose = () => {
                console.log('è¿æ¥æ–­å¼€');
                updateConnectionStatus('disconnected', 'é‡è¿ä¸­...');
                enableChatControls(false);
                stopHeartbeat();
                
                if (reconnectAttempts < CONFIG.maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connect, CONFIG.reconnectDelay);
                } else {
                    updateConnectionStatus('disconnected', 'é‡è¿å¤±è´¥');
                }
            };

            ws.onerror = () => {
                updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
            };
        }

        // å¿ƒè·³
        function startHeartbeat() {
            stopHeartbeat();
            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, CONFIG.heartbeatInterval);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // å¯ç”¨/ç¦ç”¨èŠå¤©æ§ä»¶
        function enableChatControls(enabled) {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const emojiBtn = document.getElementById('emojiBtn');
            
            if (messageInput) messageInput.disabled = !enabled;
            if (sendButton) sendButton.disabled = !enabled;
            if (emojiBtn) emojiBtn.disabled = !enabled;
        }

        // åŠ å…¥èŠå¤©å®¤
        function joinChat(isReconnect = false) {
            if (isJoining) return;
            
            const usernameInput = document.getElementById('username');
            const joinBtn = document.getElementById('joinBtn');
            
            if (!usernameInput || !joinBtn) return;
            
            const username = isReconnect ? currentUsername : usernameInput.value.trim();
            
            if (!username) {
                showError('è¯·è¾“å…¥æ˜µç§°', true);
                return;
            }

            if (username.length < 2) {
                showError('è‡³å°‘2ä¸ªå­—ç¬¦', true);
                return;
            }

            if (username.length > CONFIG.maxUsernameLength) {
                showError(`ä¸èƒ½è¶…è¿‡${CONFIG.maxUsernameLength}ä¸ªå­—ç¬¦`, true);
                return;
            }

            if (!/^[\u4e00-\u9fa5a-zA-Z0-9]+$/.test(username)) {
                showError('åªèƒ½åŒ…å«ä¸­æ–‡ã€å­—æ¯å’Œæ•°å­—', true);
                return;
            }

            if (!isReconnect) {
                currentUsername = username;
            }
            
            isJoining = true;
            joinBtn.disabled = true;
            joinBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i>';
            
            ws.send(JSON.stringify({
                type: 'join',
                username: currentUsername
            }));
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (!input) return;
            
            const content = input.value.trim();
            
            if (!content || !currentUsername || !isConnected) {
                showError('æ— æ³•å‘é€æ¶ˆæ¯', false);
                return;
            }
            
            if (content.length > CONFIG.maxMessageLength) {
                showError(`æ¶ˆæ¯ä¸èƒ½è¶…è¿‡${CONFIG.maxMessageLength}ä¸ªå­—ç¬¦`, false);
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'message',
                content: content
            }));
            
            input.value = '';
            adjustTextareaHeight(input);
            
            // å‘é€åä¿æŒç„¦ç‚¹ï¼ˆç§»åŠ¨ç«¯ï¼‰
            if (window.innerWidth < 768) {
                input.focus();
            }
        }

        // è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        function adjustTextareaHeight(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            if (!messagesDiv) return;
            
            const welcomeMsg = messagesDiv.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();
            
            const isOwnMessage = message.userId === currentUserId;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message chat ${isOwnMessage ? 'own-message' : ''}`;
            
            const avatar = message.username ? message.username.charAt(0).toUpperCase() : '?';
            const bubbleColor = message.color || '#4a90e2';
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar" style="background: ${bubbleColor}">
                        ${avatar}
                    </div>
                    <span class="message-username">${escapeHtml(message.username || 'ç”¨æˆ·')}</span>
                    <span class="message-time">${message.timestamp || ''}</span>
                </div>
                <div class="message-bubble">${escapeHtml(message.content || '')}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            
            // å¦‚æœä¸æ˜¯é”®ç›˜å¯è§çŠ¶æ€ï¼Œç›´æ¥æ»šåŠ¨åˆ°åº•éƒ¨
            if (!isKeyboardVisible) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } else {
                // é”®ç›˜å¯è§æ—¶ï¼Œè€ƒè™‘è¾“å…¥æ¡†çš„é«˜åº¦
                setTimeout(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 50);
            }
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(message) {
            const messagesDiv = document.getElementById('messages');
            if (!messagesDiv) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div class="system-content">
                    <i class="fas fa-info-circle"></i>
                    ${escapeHtml(message.content || '')}
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // æ˜¾ç¤ºå†å²æ¶ˆæ¯
        function displayHistory(messages) {
            const messagesDiv = document.getElementById('messages');
            if (!messagesDiv) return;
            
            messagesDiv.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="welcome-message">
                        <i class="fas fa-hand-peace"></i>
                        <h3>æ¬¢è¿</h3>
                        <p>è¾“å…¥æ˜µç§°å¼€å§‹èŠå¤©</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                if (message.type === 'system') {
                    addSystemMessage(message);
                } else {
                    addMessage(message);
                }
            });
            
            messageCount = messages.length;
            updateStats();
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 100);
        }

        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
        function updateUserList(users) {
            const userList = document.getElementById('userList');
            const onlineCount = document.getElementById('onlineCount');
            
            if (!userList || !onlineCount) return;
            
            onlineCount.textContent = users ? users.length : 0;
            
            if (!users || users.length === 0) {
                userList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— ç”¨æˆ·</div>';
                return;
            }
            
            userList.innerHTML = users.map(user => {
                const avatar = user.username ? user.username.charAt(0).toUpperCase() : '?';
                const isCurrentUser = user.username === currentUsername;
                
                return `
                    <div class="user-item ${isCurrentUser ? 'current-user' : ''}" onclick="mentionUser('${user.username}')">
                        <div class="user-avatar" style="background: ${user.color || '#4a90e2'}">
                            ${avatar}
                        </div>
                        <div class="user-info">
                            <div class="user-name">
                                ${escapeHtml(user.username || 'ç”¨æˆ·')}
                                ${isCurrentUser ? '<span style="font-size:10px;color:#999;"> (ä½ )</span>' : ''}
                            </div>
                            <div class="user-status">
                                <i class="fas fa-circle"></i>
                                åœ¨çº¿
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å¤„ç†è¾“å…¥æç¤º
        function handleTyping(data) {
            if (!data || data.username === currentUsername) return;
            
            if (data.isTyping) {
                activeTypingUsers.set(data.username, true);
            } else {
                activeTypingUsers.delete(data.username);
            }
            
            updateTypingIndicator();
        }

        // æ›´æ–°è¾“å…¥æç¤º
        function updateTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            const typingText = document.getElementById('typingText');
            
            if (!indicator || !typingText) return;
            
            if (activeTypingUsers.size > 0) {
                const users = Array.from(activeTypingUsers.keys());
                let text = '';
                
                if (users.length === 1) {
                    text = `${users[0]} æ­£åœ¨è¾“å…¥...`;
                } else if (users.length === 2) {
                    text = `${users[0]} å’Œ ${users[1]} æ­£åœ¨è¾“å…¥...`;
                } else {
                    text = `${users.length} äººæ­£åœ¨è¾“å…¥...`;
                }
                
                typingText.textContent = text;
                indicator.style.display = 'flex';
            } else {
                indicator.style.display = 'none';
            }
        }

        // æåŠç”¨æˆ·
        function mentionUser(username) {
            if (!username || username === currentUsername) return;
            
            const input = document.getElementById('messageInput');
            if (!input || input.disabled) return;
            
            input.value += `@${username} `;
            input.focus();
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const totalMessages = document.getElementById('totalMessages');
            if (totalMessages) {
                totalMessages.textContent = messageCount;
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('messageInput');
            const usernameInput = document.getElementById('username');
            
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    adjustTextareaHeight(this);
                    
                    if (!currentUsername || !isConnected) return;
                    
                    if (typingTimeout) clearTimeout(typingTimeout);
                    
                    ws.send(JSON.stringify({
                        type: 'typing',
                        isTyping: true
                    }));
                    
                    typingTimeout = setTimeout(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'typing',
                                isTyping: false
                            }));
                        }
                    }, CONFIG.typingTimeout);
                });
            }

            if (usernameInput) {
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        joinChat();
                    }
                });
            }

            // ç‚¹å‡»å¤–éƒ¨å…³é—­è¡¨æƒ…é¢æ¿
            document.addEventListener('click', (e) => {
                const emojiBtn = document.getElementById('emojiBtn');
                const emojiPanel = document.getElementById('emojiPanel');
                
                if (emojiBtn && emojiPanel && 
                    !emojiBtn.contains(e.target) && 
                    !emojiPanel.contains(e.target)) {
                    emojiPanel.style.display = 'none';
                }
            });

            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åˆå§‹åŒ–èƒŒæ™¯
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    initBackground();
                    
                    const messageInput = document.getElementById('messageInput');
                    if (messageInput) {
                        adjustTextareaHeight(messageInput);
                    }
                }, 250);
            });

            // è®¾ç½®é”®ç›˜å¤„ç†
            setupKeyboardHandling();
        });

        // é¡µé¢å…³é—­æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
            stopHeartbeat();
        });

        // åˆå§‹åŒ–
        initBackground();
        initEmojiPanel();
        connect();
    </script>
</body>
</html>